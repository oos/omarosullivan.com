<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Content Manager (Custom Auth)</title>
  </head>
  <body>
    <div id="login-section" style="text-align:center;margin:20px;">
      <h4>Login with GitHub</h4>
      <button id="login-btn" style="background:#333;color:white;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;">
        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDBDNS4zNzQgMCAwIDUuMzc0IDAgMTJjMCA1LjMwMiAzLjQzOCA5LjggOC4yMDcgMTEuMzg3LjYuMTExLjgyOS0uMjYxLjgyOS0uNTc3di0yLjIzNGMtMy4zMzguNzI2LTQuMDMzLTEuNDE2LTQuMDMzLTEuNDE2LS41NDYtMS4zODctMS4zMzMtMS43NTYtMS4zMzMtMS43NTYtMS4wODktLjc0NS4wODMtLjcyOS4wODMtLjcyOSAxLjIwNS4wODQgMS44MzggMS4yMzcgMS44MzggMS4yMzcgMS4wNyAxLjgzNCAyLjc3NyAxLjMwNCAzLjQ1Mi45OTcuMTA3LS43NzYuNDE1LTEuMzA1Ljc1NS0xLjYwNS0Mi42NjUtLjMwNS01LjQ2Ni0xLjMzNC01LjQ2Ni01LjkzMSAwLTEuMzExLjQ2OS0yLjM4MSAxLjIzNi0zLjIyMS0uMTI0LS4zMDUtLjUzNS0xLjUyNC4xMTctMy4xNzYgMCAwIDEuMDA4LS4zMjIgMy4zMDEgMS4yMy45NTctLjI2NiAxLjk4My0uMzk5IDMuMDAzLS40MDQgMS4wMi4wMDUgMi4wNDcuMTM4IDMuMDA2LjQwNCAyLjI5LTEuNTUyIDMuMjk3LTEuMjMgMy4yOTctMS4yMy42NTMgMS42NTIuMjQyIDIuODcuMTE4IDMuMTc2LjkyLjg0IDEuMjM1IDEuOTExIDEuMjM1IDMuMjIxIDAgNC42MDktMi44MDcgNS42MjQtNS40NzkgNS45MjEuNDI5LjM2OS44MTEuMS4xMS0uODA4LjEwOC0uODM0LjEwOC0xLjczNSAwLTEuNjA1LS4wMTUtMi45MzUtLjAxNS01LjMzNHYtMi4yNDZjMC0uMzE1LjE5OS0uNjg4LjgyOS0uNTc3QzIwLjU2MiAyMS43OTcgMjQgMTcuMzAyIDI0IDEyYzAtNi42MjYtNS4zNzQtMTItMTItMTJ6IiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K" style="width:20px;height:20px;margin-right:8px;vertical-align:middle;">
        Login with GitHub
      </button>
    </div>

    <div id="cms-interface" style="display:none;">
      <h4>Content Management System</h4>
      <div id="collections">
        <h5>Main Navigation</h5>
        <div id="main-nav-section">
          <button id="edit-main-nav" style="background:#007cba;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;margin:5px;">Edit Main Navigation</button>
        </div>
        <h5>Site Settings</h5>
        <div id="site-settings-section">
          <button id="edit-site-settings" style="background:#28a745;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;margin:5px;">Edit Site Settings</button>
        </div>
        <h5>Pages</h5>
        <div id="pages-section">
          <h6>Pages</h6>
          <button id="add-page" style="background:#28a745;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;margin:5px;">Add New Page</button>
          <button id="edit-about" style="background:#007cba;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;margin:5px;">Edit About Page</button>
          <div id="pages-list"></div>
        </div>
        <h5>Collections</h5>
        <div id="portfolio-section">
          <h6>Sketches</h6>
          <button id="add-portfolio" style="background:#007cba;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;margin:5px;">Add New Sketch</button>
          <div id="portfolio-list"></div>
        </div>
        <div id="photography-section">
          <h6>Photography</h6>
          <button id="add-photography" style="background:#6f42c1;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;margin:5px;">Add New Photo</button>
          <div id="photography-list"></div>
        </div>
        <div id="poetry-section">
          <h6>Poetry</h6>
          <button id="add-poetry" style="background:#e83e8c;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;margin:5px;">Add New Poetry Post</button>
          <div id="poetry-list"></div>
        </div>
      </div>
    </div>

    <script>
      // Define global functions immediately - before IIFE
      window.editFile = function(filename, sha) {
        console.log('editFile called with:', filename, sha);
        
        // Determine if this is a poetry file or portfolio file based on context
        // Check if we're in the poetry section by looking at the current URL or context
        const isPoetryFile = window.location.hash.includes('poetry') || 
                           document.querySelector('#poetry-list')?.contains(event?.target) ||
                           filename.includes('poetry');
        
        if (isPoetryFile && window.editPoetryItem) {
          console.log('Editing poetry file:', filename);
          window.editPoetryItem(filename, sha);
        } else if (window.editPortfolioItem) {
          console.log('Editing portfolio file:', filename);
          window.editPortfolioItem(filename, sha);
        } else {
          alert('Please wait for the page to load completely');
        }
      };

      window.editPage = function(pageName) {
        console.log('editPage called with:', pageName);
        // Wait for the page to be fully loaded
        if (document.readyState === 'complete' && window.editPageInternal) {
          window.editPageInternal(pageName);
        } else {
          // Retry after a short delay
          setTimeout(() => {
            if (window.editPageInternal) {
              window.editPageInternal(pageName);
            } else {
              alert('Please wait for the page to load completely');
            }
          }, 100);
        }
      };

      window.deleteFile = function(filename, sha) {
        if (confirm('Are you sure you want to delete ' + filename + '?')) {
          // Wait for the page to be fully loaded
          if (document.readyState === 'complete' && window.deletePortfolioItem) {
            window.deletePortfolioItem(filename, sha);
          } else {
            // Retry after a short delay
            setTimeout(() => {
              if (window.deletePortfolioItem) {
                window.deletePortfolioItem(filename, sha);
              } else {
                alert('Please wait for the page to load completely');
              }
            }, 100);
          }
        }
      };

      window.deletePage = function(pageName, sha) {
        if (confirm('Are you sure you want to delete the ' + pageName + ' page? This will also remove it from the navigation menu.')) {
          // Wait for the page to be fully loaded
          if (document.readyState === 'complete' && window.deletePageAndMenu) {
            window.deletePageAndMenu(pageName, sha);
          } else {
            // Retry after a short delay
            setTimeout(() => {
              if (window.deletePageAndMenu) {
                window.deletePageAndMenu(pageName, sha);
              } else {
                alert('Please wait for the page to load completely');
              }
            }, 100);
          }
        }
      };

      window.testGlobalFunctions = function() {
        console.log('Testing global functions...');
        console.log('window.editFile exists:', !!window.editFile);
        console.log('window.editPage exists:', !!window.editPage);
        console.log('window.editPortfolioItem exists:', !!window.editPortfolioItem);
        console.log('window.editPageInternal exists:', !!window.editPageInternal);
        return 'Global functions test complete';
      };

      // Regression test suite to prevent breaking existing functionality
      window.runRegressionTests = function() {
        console.log('ðŸ§ª Running regression tests...');
        const tests = [];
        
        // Test 1: Check if all required DOM elements exist
        const requiredElements = [
          'login-section',
          'cms-interface', 
          'login-btn',
          'portfolio-list',
          'pages-list',
          'poetry-list',
          'add-portfolio',
          'add-page',
          'add-poetry',
          'edit-site-settings'
        ];
        
        requiredElements.forEach(id => {
          const element = document.getElementById(id);
          const exists = !!element;
          tests.push({ test: `Element ${id} exists`, passed: exists });
          if (!exists) console.error(`âŒ Missing element: ${id}`);
        });
        
        // Test 2: Check if all required functions exist
        const requiredFunctions = [
          'showAddPortfolioForm',
          'showAddPageForm', 
          'showAddPoetryForm',
          'loadPortfolioItems',
          'loadPages',
          'loadPoetryItems',
          'createPoetryItem',
          'editSiteSettings',
          'setupButtonListeners'
        ];
        
        requiredFunctions.forEach(funcName => {
          const exists = typeof window[funcName] === 'function';
          tests.push({ test: `Function ${funcName} exists`, passed: exists });
          if (!exists) console.error(`âŒ Missing function: ${funcName}`);
        });
        
        // Test 3: Check if authentication variables are defined
        const authVars = ['currentToken', 'isAuthenticated', 'isLoading'];
        authVars.forEach(varName => {
          const exists = window.hasOwnProperty(varName);
          tests.push({ test: `Variable ${varName} defined`, passed: exists });
          if (!exists) console.error(`âŒ Missing variable: ${varName}`);
        });
        
        // Test 4: Check if event listeners are properly attached
        const buttons = ['add-portfolio', 'add-page', 'add-poetry', 'edit-site-settings'];
        buttons.forEach(buttonId => {
          const button = document.getElementById(buttonId);
          if (button) {
            const hasListeners = button.onclick !== null || button.addEventListener !== undefined;
            tests.push({ test: `Button ${buttonId} has listeners`, passed: hasListeners });
            if (!hasListeners) console.error(`âŒ Button ${buttonId} missing listeners`);
          }
        });
        
        // Test 5: Check if poetry items are displayed in admin
        const poetryList = document.getElementById('poetry-list');
        if (poetryList) {
          const hasPoetryItems = poetryList.children.length > 0;
          tests.push({ test: 'Poetry items displayed in admin', passed: hasPoetryItems });
          if (!hasPoetryItems) console.error('âŒ No poetry items displayed in admin interface');
        }
        
        // Summary
        const passed = tests.filter(t => t.passed).length;
        const total = tests.length;
        const success = passed === total;
        
        console.log(`ðŸ§ª Regression tests complete: ${passed}/${total} passed`);
        if (success) {
          console.log('âœ… All regression tests passed!');
        } else {
          console.log('âŒ Some regression tests failed!');
        }
        
        return { passed, total, success, tests };
      };

      window.showLoginForm = function() {
        // Reset authentication state
        window.currentToken = null;
        window.isAuthenticated = false;
        
        // Show login form and hide CMS interface
        const loginSection = document.getElementById('login-section');
        const cmsInterface = document.getElementById('cms-interface');
        
        if (loginSection) loginSection.style.display = 'block';
        if (cmsInterface) cmsInterface.style.display = 'none';
        
        console.log('[auth] Showing login form due to token expiration');
      };

      (function () {
        const loginSection = document.getElementById('login-section');
        const cmsInterface = document.getElementById('cms-interface');
        const loginBtn = document.getElementById('login-btn');
        const portfolioList = document.getElementById('portfolio-list');

        // Expose internal functions to global scope immediately
        window.editPortfolioItem = function(filename, sha) {
          // This will be defined later in the IIFE
          if (typeof editPortfolioItem === 'function') {
            return editPortfolioItem(filename, sha);
          } else {
            alert('Please wait for the page to load completely');
          }
        };

        window.editPageInternal = function(pageName) {
          // This will be defined later in the IIFE
          if (typeof editPage === 'function') {
            return editPage(pageName);
          } else {
            alert('Please wait for the page to load completely');
          }
        };

        window.deletePortfolioItem = function(filename, sha) {
          // This will be defined later in the IIFE
          if (typeof deletePortfolioItem === 'function') {
            return deletePortfolioItem(filename, sha);
          } else {
            alert('Please wait for the page to load completely');
          }
        };

        window.deletePageAndMenu = function(pageName, sha) {
          // This will be defined later in the IIFE
          if (typeof deletePageAndMenu === 'function') {
            return deletePageAndMenu(pageName, sha);
          } else {
            alert('Please wait for the page to load completely');
          }
        };

        let currentToken = null;
        let isLoading = false;
        let isAuthenticated = false;

        function log(msg, kind) {
          // Debug logging disabled for production - only console logging
          if (kind === 'token') {
            console.log('%c' + msg, 'background:#222;color:#0f0;font-weight:bold;padding:2px 6px;');
          } else if (kind === 'error') {
            console.log('%c' + msg, 'background:#222;color:#f00;font-weight:bold;padding:2px 6px;');
          } else {
            console.log(msg);
          }
        }

        function extractTokenFromStorage() {
          const keys = ['netlify-cms.oauth', 'decap-cms.oauth', 'cms.oauth', 'github-token'];
          log('[storage] Starting token extraction...');
          
          for (const key of keys) {
            // Check localStorage first, then sessionStorage as fallback
            let raw = localStorage.getItem(key);
            if (!raw) {
              raw = sessionStorage.getItem(key);
            }
            
            log('[storage] Checking ' + key + ': ' + (raw ? 'found' : 'not found'));
            
            if (raw) {
              log('[storage] Found token in ' + key + ': ' + raw.substring(0, 50) + '...');
              try {
                // Try JSON format first
                if (raw[0] === '{') {
                  const obj = JSON.parse(raw);
                  if (obj && obj.token) {
                    log('[storage] Extracted token from JSON: ' + obj.token.substring(0, 20) + '...');
                    return obj.token;
                  }
                } 
                // Try string format
                else {
                  const m = /authorization:github:success:([^:]+)$/.exec(raw);
                  if (m && m[1]) {
                    log('[storage] Extracted token from string: ' + m[1].substring(0, 20) + '...');
                    return m[1];
                  }
                  // Try direct token format
                  else if (raw.startsWith('gho_')) {
                    log('[storage] Extracted direct token: ' + raw.substring(0, 20) + '...');
                    return raw;
                  }
                }
              } catch (e) {
                log('[storage] Error parsing ' + key + ': ' + e.message, 'error');
              }
            }
          }
          
          log('[storage] No valid token found in any storage key', 'error');
          return null;
        }

        function saveTokenInAllFormats(token) {
          const formats = [
            'authorization:github:success:' + token,
            JSON.stringify({ provider: 'github', type: 'success', token: token }),
            token
          ];
          
          const keys = ['netlify-cms.oauth', 'decap-cms.oauth', 'cms.oauth', 'github-token'];
          
          keys.forEach(key => {
            formats.forEach(format => {
              try {
                // Save to both localStorage and sessionStorage for persistence
                localStorage.setItem(key, format);
                sessionStorage.setItem(key, format);
                log('[storage] Set ' + key + ' = ' + format.substring(0, 50) + '...', 'token');
              } catch (e) {
                log('[storage] Error setting ' + key + ': ' + e.message, 'error');
              }
            });
          });
        }

        function clearInvalidTokens() {
          const keys = ['netlify-cms.oauth', 'decap-cms.oauth', 'cms.oauth', 'github-token'];
          keys.forEach(key => {
            try {
              localStorage.removeItem(key);
              sessionStorage.removeItem(key);
              log('[storage] Cleared invalid token from ' + key);
            } catch (e) {
              log('[storage] Error clearing ' + key + ': ' + e.message, 'error');
            }
          });
        }



        function debugStorage() {
          const keys = ['netlify-cms.oauth', 'decap-cms.oauth', 'cms.oauth', 'github-token'];
          log('[debug] === STORAGE DEBUG ===');
          keys.forEach(key => {
            const local = localStorage.getItem(key);
            const session = sessionStorage.getItem(key);
            log('[debug] ' + key + ' - localStorage: ' + (local ? local.substring(0, 30) + '...' : 'null'));
            log('[debug] ' + key + ' - sessionStorage: ' + (session ? session.substring(0, 30) + '...' : 'null'));
          });
          log('[debug] === END STORAGE DEBUG ===');
        }

        async function testGitHubAPI(token) {
          try {
            log('[api] Testing GitHub API with token...', 'token');
            const response = await fetch('https://api.github.com/user', {
              headers: {
                'Authorization': 'token ' + token,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            if (response.ok) {
              const user = await response.json();
              log('[api] GitHub API successful! User: ' + user.login, 'token');
              return user;
            } else {
              log('[api] GitHub API failed: ' + response.status, 'error');
              return null;
            }
          } catch (e) {
            log('[api] GitHub API error: ' + e.message, 'error');
            return null;
          }
        }


        async function loadPortfolioItems(token) {
          if (isLoading) {
            log('[api] Already loading sketches, skipping...', 'token');
            return;
          }
          
          isLoading = true;
          try {
            log('[api] Loading sketches...', 'token');
            const response = await fetch('https://api.github.com/repos/oos/omarosullivan.com/contents/content/portfolio', {
              headers: {
                'Authorization': 'token ' + token,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            if (response.ok) {
              const items = await response.json();
              log('[api] Loaded ' + items.length + ' sketches', 'token');
              
              portfolioList.innerHTML = '';
              items.forEach(item => {
                if (item.name.endsWith('.md')) {
                  const div = document.createElement('div');
                  div.style.cssText = 'border:1px solid #ddd;padding:10px;margin:5px;border-radius:3px;';
                  div.innerHTML = `
                    <strong>${item.name}</strong>
                    <button onclick="editFile('${item.name}', '${item.sha}')" style="float:right;background:#007cba;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;margin-left:5px;">Edit</button>
                    <button onclick="deleteFile('${item.name}', '${item.sha}')" style="float:right;background:#dc3545;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;">Delete</button>
                  `;
                  portfolioList.appendChild(div);
                }
              });
              
              return items;
            } else if (response.status === 401) {
              log('[api] Token expired or invalid (401). Clearing tokens and requiring re-authentication.', 'error');
              console.log('[api] Portfolio: Clearing invalid tokens...');
              clearInvalidTokens();
              console.log('[api] Portfolio: Showing login form...');
              window.showLoginForm();
              console.log('[api] Portfolio: Login form should be visible now');
              return [];
            } else {
              log('[api] Failed to load sketches: ' + response.status, 'error');
              return [];
            }
                      } catch (e) {
            log('[api] Error loading sketches: ' + e.message, 'error');
            return [];
          } finally {
            isLoading = false;
          }
        }

        async function loadPages(token) {
          try {
            log('[api] Loading pages...', 'token');
            const response = await fetch('https://api.github.com/repos/oos/omarosullivan.com/contents/content', {
              headers: {
                'Authorization': 'token ' + token,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            if (response.ok) {
              const items = await response.json();
              const pagesList = document.getElementById('pages-list');
              
              pagesList.innerHTML = '';
              
              // Filter for .md files that are not in subdirectories, include _index.md but exclude other _ files
              const pages = items.filter(item => 
                item.name.endsWith('.md') && 
                (item.name === '_index.md' || !item.name.startsWith('_')) && 
                item.type === 'file'
              );
              
              log('[api] Loaded ' + pages.length + ' pages', 'token');
              
              pages.forEach(page => {
                const pageName = page.name.replace('.md', '');
                const displayName = pageName === '_index' ? 'Homepage' : pageName;
                const div = document.createElement('div');
                div.style.cssText = 'border:1px solid #ddd;padding:10px;margin:5px;border-radius:3px;';
                div.innerHTML = `
                  <strong>${displayName}</strong>
                  <button onclick="editPage('${pageName}')" style="float:right;background:#007cba;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;margin-left:5px;">Edit</button>
                  <button onclick="deletePage('${pageName}', '${page.sha}')" style="float:right;background:#dc3545;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;">Delete</button>
                `;
                pagesList.appendChild(div);
              });
              
              return pages;
            } else if (response.status === 401) {
              log('[api] Token expired or invalid (401). Clearing tokens and requiring re-authentication.', 'error');
              console.log('[api] Pages: Clearing invalid tokens...');
              clearInvalidTokens();
              console.log('[api] Pages: Showing login form...');
              window.showLoginForm();
              console.log('[api] Pages: Login form should be visible now');
              return [];
            } else {
              log('[api] Failed to load pages: ' + response.status, 'error');
              return [];
            }
          } catch (e) {
            log('[api] Error loading pages: ' + e.message, 'error');
            return [];
          }
        }

        async function authenticate() {
          if (isAuthenticated) {
            log('[auth] Already authenticated, skipping...', 'token');
            return true;
          }
          
          const token = extractTokenFromStorage();
          if (!token) {
            log('[auth] No token found in storage', 'error');
            return false;
          }

          log('[auth] Found token, testing authentication...', 'token');
          const user = await testGitHubAPI(token);
          
          if (user) {
            currentToken = token;
            isAuthenticated = true;
            log('[auth] Authentication successful! Welcome ' + user.login, 'token');
            
            // Hide login section and show CMS interface
            loginSection.style.display = 'none';
            cmsInterface.style.display = 'block';
            
            // Set up button event listeners now that CMS interface is visible
            console.log('About to call setupButtonListeners...');
            setupButtonListeners();
            console.log('setupButtonListeners called');
            
            // Load portfolio items, poetry, and pages only if not already loaded
            if (!isLoading) {
              await loadPortfolioItems(token);
              await loadPoetryItems(token);
              await loadPages(token);
            }
            
            return true;
          } else {
            log('[auth] Authentication failed', 'error');
            return false;
          }
        }

        // Listen for OAuth popup messages
        window.addEventListener('message', (e) => {
          const m = e.data;
          
          // Log all messages for debugging
          log('[message] Received message: ' + JSON.stringify(m));
          
          // Filter out non-OAuth messages to reduce noise
          if (typeof m === 'string' && m.startsWith('authorization:github:success:')) {
            log('[message] OAuth success message received', 'token');
          } else if (m && typeof m === 'object' && m.provider === 'github' && m.type === 'success') {
            log('[message] OAuth success object received', 'token');
          } else {
            // Skip logging non-OAuth messages to reduce noise
            return;
          }
          
          let saved = false;
          try {
            if (typeof m === 'string' && m.startsWith('authorization:github:success:')) {
              const token = m.replace('authorization:github:success:', '');
              saveTokenInAllFormats(token);
              saved = true;
            } else if (m && typeof m === 'object' && m.provider === 'github' && m.type === 'success' && m.token) {
              saveTokenInAllFormats(m.token);
              saved = true;
            }
          } catch (err) {
            log('[message] Error processing message: ' + err.message, 'error');
          }

          if (saved && !isAuthenticated) {
            log('[message] Token saved, attempting authentication...', 'token');
            
            // Single authentication attempt
            setTimeout(() => {
              if (!isAuthenticated) {
                authenticate();
              }
            }, 100);
          }
        });

        // Handle URL token fallback
        try {
          const hash = location.hash || '';
          const qIndex = hash.indexOf('?');
          let urlToken = null;
          if (qIndex !== -1) {
            const qs = hash.slice(qIndex + 1);
            const hp = new URLSearchParams(qs);
            urlToken = hp.get('token');
          }
          const qpToken = new URLSearchParams(location.search).get('token');
          if (qpToken && !urlToken) urlToken = qpToken;

          if (urlToken) {
            saveTokenInAllFormats(urlToken);
            log('[url] TOKEN STORED: ' + urlToken, 'token');
            history.replaceState(null, '', location.pathname + '#/');
            setTimeout(() => {
              if (!isAuthenticated) {
                authenticate();
              }
            }, 100);
            return;
          }
        } catch (e) {
          log('[url] Error parsing URL token: ' + e.message, 'error');
        }

        // Image upload function
        async function uploadImage(file, filename) {
          try {
            const reader = new FileReader();
            return new Promise((resolve, reject) => {
              reader.onload = async function(e) {
                try {
                  const base64Content = e.target.result.split(',')[1];
                  const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/static/uploads/${filename}`, {
                    method: 'PUT',
                    headers: {
                      'Authorization': 'token ' + currentToken,
                      'Accept': 'application/vnd.github.v3+json',
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                      message: `Upload image: ${filename}`,
                      content: base64Content
                    })
                  });

                  if (response.ok) {
                    resolve(true);
                  } else {
                    const error = await response.json();
                    alert('Error uploading image: ' + (error.message || 'Unknown error'));
                    resolve(false);
                  }
                } catch (e) {
                  alert('Error uploading image: ' + e.message);
                  resolve(false);
                }
              };
              reader.readAsDataURL(file);
            });
          } catch (e) {
            alert('Error uploading image: ' + e.message);
            return false;
          }
        }

        // CRUD Functions
        function showAddPortfolioForm() {
          // Remove any existing modal first
          const existingModal = document.getElementById('add-portfolio-modal');
          if (existingModal) {
            existingModal.remove();
          }
          
          const form = document.createElement('div');
          form.id = 'add-portfolio-modal';
          form.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;';
          form.innerHTML = `
            <div style="background:white;padding:20px;border-radius:8px;width:80%;max-width:600px;max-height:80%;overflow-y:auto;position:relative;">
              <button onclick="document.getElementById('add-portfolio-modal').remove()" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;">&times;</button>
              <h3>Add New Sketch</h3>
              <form id="add-portfolio-form">
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Title:</label>
                  <input type="text" id="portfolio-title" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Description:</label>
                  <textarea id="portfolio-description" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;height:100px;"></textarea>
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Tags/Labels:</label>
                  <input type="text" id="portfolio-tags" placeholder="Oil, Landscape, Painting" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  <small style="color:#666;">Separate multiple tags with commas (e.g., Oil, Landscape, Painting)</small>
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Cover Image:</label>
                  <input type="file" id="portfolio-image" accept="image/*" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  <div id="image-preview" style="margin-top:10px;display:none;">
                    <img id="preview-img" style="max-width:200px;max-height:150px;border:1px solid #ddd;border-radius:4px;">
                    <div id="image-info" style="margin-top:5px;font-size:0.9em;color:#666;"></div>
                  </div>
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Content (Markdown):</label>
                  <textarea id="portfolio-content" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;height:200px;"></textarea>
                </div>
                <div style="text-align:right;">
                  <button type="button" onclick="document.getElementById('add-portfolio-modal').remove()" style="background:#6c757d;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;margin-right:10px;">Cancel</button>
                  <button type="submit" style="background:#007cba;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">Create</button>
                </div>
              </form>
            </div>
          `;
          document.body.appendChild(form);
          
          // Image preview handler for add form
          document.getElementById('portfolio-image').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = function(e) {
                document.getElementById('preview-img').src = e.target.result;
                document.getElementById('image-preview').style.display = 'block';
                document.getElementById('image-info').textContent = `File: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
              };
              reader.readAsDataURL(file);
            } else {
              document.getElementById('image-preview').style.display = 'none';
            }
          });

          document.getElementById('add-portfolio-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('portfolio-title').value;
            const description = document.getElementById('portfolio-description').value;
            const tags = document.getElementById('portfolio-tags').value;
            const content = document.getElementById('portfolio-content').value;
            const imageFile = document.getElementById('portfolio-image').files[0];
            
            await createPortfolioItem(title, description, tags, content, imageFile);
            form.remove();
          });
        }

        async function createPortfolioItem(title, description, tags, content, imageFile) {
          try {
            const slug = title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
            const filename = slug + '.md';
            const date = new Date().toISOString().split('T')[0];
            
            let coverImage = '';
            if (imageFile) {
              // Upload image first
              const imageFilename = slug + '-' + Date.now() + '.' + imageFile.name.split('.').pop();
              const imageResponse = await uploadImage(imageFile, imageFilename);
              if (imageResponse) {
                coverImage = `cover:\n  image: "/uploads/${imageFilename}"`;
              }
            }
            
            // Process tags
            let tagsYaml = '';
            if (tags && tags.trim()) {
              const tagArray = tags.split(',').map(tag => tag.trim()).filter(tag => tag);
              if (tagArray.length > 0) {
                tagsYaml = `tags:\n${tagArray.map(tag => `  - "${tag}"`).join('\n')}`;
              }
            }
            
            const markdownContent = `---
title: "${title}"
date: ${date}
description: "${description}"
${coverImage}
${tagsYaml}
---

${content}
`;

            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/portfolio/${filename}`, {
              method: 'PUT',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Add sketch: ${title}`,
                content: btoa(unescape(encodeURIComponent(markdownContent)))
              })
            });

            if (response.ok) {
              alert('Sketch created successfully!');
              await loadPortfolioItems(currentToken);
            } else {
              const error = await response.json();
              alert('Error creating sketch: ' + (error.message || 'Unknown error'));
            }
          } catch (e) {
            alert('Error creating sketch: ' + e.message);
          }
        }

        async function editPortfolioItem(filename, sha) {
          try {
            // First, get the current content
            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/portfolio/${filename}`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            if (!response.ok) {
              alert('Error loading sketch');
              return;
            }

            const file = await response.json();
            const content = decodeURIComponent(escape(atob(file.content)));
            
            // Parse frontmatter
            const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);
            let title = filename.replace('.md', '');
            let description = '';
            let tags = '';
            let body = content;
            
            if (frontmatterMatch) {
              const frontmatter = frontmatterMatch[1];
              const bodyContent = frontmatterMatch[2];
              
              const titleMatch = frontmatter.match(/title:\s*["']?([^"'\n]+)["']?/);
              const descMatch = frontmatter.match(/description:\s*["']?([^"'\n]+)["']?/);
              
              // Parse tags from YAML array format
              const tagsMatch = frontmatter.match(/tags:\s*\n((?:\s*-\s*["']?[^"'\n]+["']?\s*\n?)*)/);
              if (tagsMatch) {
                const tagsLines = tagsMatch[1].split('\n').filter(line => line.trim());
                const tagArray = tagsLines.map(line => {
                  const match = line.match(/-\s*["']?([^"'\n]+)["']?/);
                  return match ? match[1] : '';
                }).filter(tag => tag);
                tags = tagArray.join(', ');
              }
              
              if (titleMatch) title = titleMatch[1];
              if (descMatch) description = descMatch[1];
              body = bodyContent;
            }

            // Remove any existing modal first
            const existingModal = document.getElementById('edit-portfolio-modal');
            if (existingModal) {
              existingModal.remove();
            }
            
            // Show edit form
            const form = document.createElement('div');
            form.id = 'edit-portfolio-modal';
            form.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;';
            form.innerHTML = `
              <div style="background:white;padding:20px;border-radius:8px;width:80%;max-width:600px;max-height:80%;overflow-y:auto;position:relative;">
                <button onclick="document.getElementById('edit-portfolio-modal').remove()" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;">&times;</button>
                <h3>Edit Sketch</h3>
                <form id="edit-portfolio-form">
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Title:</label>
                    <input type="text" id="edit-portfolio-title" value="${title}" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Description:</label>
                    <textarea id="edit-portfolio-description" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;height:100px;">${description}</textarea>
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Tags/Labels:</label>
                    <input type="text" id="edit-portfolio-tags" value="${tags}" placeholder="Oil, Landscape, Painting" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                    <small style="color:#666;">Separate multiple tags with commas (e.g., Oil, Landscape, Painting)</small>
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Cover Image:</label>
                    <div id="current-image-display" style="margin-bottom:10px;padding:10px;background:#f8f9fa;border:1px solid #dee2e6;border-radius:4px;">
                      <small style="color:#666;display:block;margin-bottom:5px;">Current image:</small>
                      <div id="current-image-container"></div>
                    </div>
                    <input type="file" id="edit-portfolio-image" accept="image/*" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                    <small style="color:#666;display:block;margin-top:5px;">Leave empty to keep current image, or select a new image to replace it.</small>
                    <div id="edit-image-preview" style="margin-top:10px;display:none;">
                      <img id="edit-preview-img" style="max-width:200px;max-height:150px;border:1px solid #ddd;border-radius:4px;">
                      <div id="edit-image-info" style="margin-top:5px;font-size:0.9em;color:#666;"></div>
                    </div>
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Content (Markdown):</label>
                    <textarea id="edit-portfolio-content" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;height:200px;">${body}</textarea>
                  </div>
                  <div style="text-align:right;">
                    <button type="button" onclick="document.getElementById('edit-portfolio-modal').remove()" style="background:#6c757d;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;margin-right:10px;">Cancel</button>
                    <button type="submit" style="background:#007cba;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">Save</button>
                  </div>
                </form>
              </div>
            `;
            document.body.appendChild(form);
            
            // Display current image
            const currentImageContainer = document.getElementById('current-image-container');
            const currentCoverMatch = content.match(/cover:\s*\n\s*image:\s*["']?([^"'\n]+)["']?/);
            if (currentCoverMatch) {
              const currentImagePath = currentCoverMatch[1];
              currentImageContainer.innerHTML = `
                <img src="${currentImagePath}" style="max-width:200px;max-height:150px;border:1px solid #ddd;border-radius:4px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <div style="display:none;color:#666;font-style:italic;">Image not found: ${currentImagePath}</div>
              `;
            } else {
              currentImageContainer.innerHTML = '<div style="color:#666;font-style:italic;">No current image</div>';
            }
            
            // Image preview handler for edit form
            document.getElementById('edit-portfolio-image').addEventListener('change', function(e) {
              const file = e.target.files[0];
              if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                  document.getElementById('edit-preview-img').src = e.target.result;
                  document.getElementById('edit-image-preview').style.display = 'block';
                  document.getElementById('edit-image-info').textContent = `File: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                };
                reader.readAsDataURL(file);
              } else {
                document.getElementById('edit-image-preview').style.display = 'none';
              }
            });

            document.getElementById('edit-portfolio-form').addEventListener('submit', async (e) => {
              e.preventDefault();
              const newTitle = document.getElementById('edit-portfolio-title').value;
              const newDescription = document.getElementById('edit-portfolio-description').value;
              const newTags = document.getElementById('edit-portfolio-tags').value;
              const newContent = document.getElementById('edit-portfolio-content').value;
              const imageFile = document.getElementById('edit-portfolio-image').files[0];
              
              await updatePortfolioItem(filename, sha, newTitle, newDescription, newTags, newContent, imageFile);
              form.remove();
            });
          } catch (e) {
            alert('Error loading portfolio item: ' + e.message);
          }
        }

        async function updatePortfolioItem(filename, sha, title, description, tags, content, imageFile) {
          try {
            const date = new Date().toISOString().split('T')[0];
            
            // First, get the current content to preserve existing image
            const currentResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/portfolio/${filename}`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });
            
            let existingCoverImage = '';
            if (currentResponse.ok) {
              const currentFile = await currentResponse.json();
              const currentContent = decodeURIComponent(escape(atob(currentFile.content)));
              const coverMatch = currentContent.match(/cover:\s*\n\s*image:\s*["']?([^"'\n]+)["']?/);
              if (coverMatch) {
                existingCoverImage = `cover:\n  image: "${coverMatch[1]}"`;
              }
            }
            
            let coverImage = existingCoverImage; // Preserve existing image by default
            if (imageFile) {
              // Upload new image only if one is provided
              const slug = title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
              const imageFilename = slug + '-' + Date.now() + '.' + imageFile.name.split('.').pop();
              const imageResponse = await uploadImage(imageFile, imageFilename);
              if (imageResponse) {
                coverImage = `cover:\n  image: "/uploads/${imageFilename}"`;
              }
            }
            
            // Process tags
            let tagsYaml = '';
            if (tags && tags.trim()) {
              const tagArray = tags.split(',').map(tag => tag.trim()).filter(tag => tag);
              if (tagArray.length > 0) {
                tagsYaml = `tags:\n${tagArray.map(tag => `  - "${tag}"`).join('\n')}`;
              }
            }
            
            const markdownContent = `---
title: "${title}"
date: ${date}
description: "${description}"
${coverImage}
${tagsYaml}
---

${content}
`;

            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/portfolio/${filename}`, {
              method: 'PUT',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Update sketch: ${title}`,
                content: btoa(unescape(encodeURIComponent(markdownContent))),
                sha: sha
              })
            });

            if (response.ok) {
              alert('Sketch updated successfully!');
              await loadPortfolioItems(currentToken);
            } else {
              const error = await response.json();
              alert('Error updating sketch: ' + (error.message || 'Unknown error'));
            }
          } catch (e) {
            alert('Error updating sketch: ' + e.message);
          }
        }

        async function deletePortfolioItem(filename, sha) {
          try {
            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/portfolio/${filename}`, {
              method: 'DELETE',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Delete sketch: ${filename}`,
                sha: sha
              })
            });

            if (response.ok) {
              alert('Sketch deleted successfully!');
              await loadPortfolioItems(currentToken);
            } else {
              const error = await response.json();
              alert('Error deleting sketch: ' + (error.message || 'Unknown error'));
            }
          } catch (e) {
            alert('Error deleting sketch: ' + e.message);
          }
        }

        async function editPage(pageName) {
          try {
            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/${pageName}.md`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            if (!response.ok) {
              alert('Error loading page');
              return;
            }

            const file = await response.json();
            const content = decodeURIComponent(escape(atob(file.content)));
            
            // Parse frontmatter
            const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);
            let title = pageName.charAt(0).toUpperCase() + pageName.slice(1);
            let body = content;
            
            if (frontmatterMatch) {
              const frontmatter = frontmatterMatch[1];
              const bodyContent = frontmatterMatch[2];
              
              const titleMatch = frontmatter.match(/title:\s*["']?([^"'\n]+)["']?/);
              
              if (titleMatch) title = titleMatch[1];
              body = bodyContent;
            }

            // Remove any existing modal first
            const existingModal = document.getElementById('edit-page-modal');
            if (existingModal) {
              existingModal.remove();
            }
            
            // Show edit form
            const form = document.createElement('div');
            form.id = 'edit-page-modal';
            form.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;';
            // Check if this is the About page to add image upload
            const isAboutPage = pageName === 'about';
            const imageUploadField = isAboutPage ? `
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Page Image (optional):</label>
                    <input type="file" id="edit-page-image" accept="image/*" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                    <small style="color:#666;font-size:12px;">Leave empty to keep current image, or select a new image to replace it.</small>
                  </div>
            ` : '';

            form.innerHTML = `
              <div style="background:white;padding:20px;border-radius:8px;width:80%;max-width:600px;max-height:80%;overflow-y:auto;position:relative;">
                <button onclick="document.getElementById('edit-page-modal').remove()" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;">&times;</button>
                <h3>Edit ${title} Page</h3>
                <form id="edit-page-form">
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Title:</label>
                    <input type="text" id="edit-page-title" value="${title}" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  </div>
                  ${imageUploadField}
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Content (Markdown):</label>
                    <textarea id="edit-page-content" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;height:300px;">${body}</textarea>
                  </div>
                  <div style="text-align:right;">
                    <button type="button" onclick="document.getElementById('edit-page-modal').remove()" style="background:#6c757d;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;margin-right:10px;">Cancel</button>
                    <button type="submit" style="background:#007cba;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">Save</button>
                  </div>
                </form>
              </div>
            `;
            document.body.appendChild(form);
            
            document.getElementById('edit-page-form').addEventListener('submit', async (e) => {
              e.preventDefault();
              const newTitle = document.getElementById('edit-page-title').value;
              const newContent = document.getElementById('edit-page-content').value;
              
              // Handle image upload for About page
              let imagePath = null;
              if (isAboutPage) {
                const imageFile = document.getElementById('edit-page-image').files[0];
                if (imageFile) {
                  imagePath = await uploadImage(imageFile);
                }
              }
              
              await updatePage(pageName, file.sha, newTitle, newContent, imagePath);
              form.remove();
            });
          } catch (e) {
            alert('Error loading page: ' + e.message);
          }
        }

        async function updatePage(pageName, sha, title, content, imagePath = null) {
          try {
            // First get the current file to preserve existing frontmatter
            const currentResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/${pageName}.md`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            let frontmatter = `---
title: "${title}"`;

            if (currentResponse.ok) {
              const currentFile = await currentResponse.json();
              const currentContent = decodeURIComponent(escape(atob(currentFile.content)));
              const frontmatterMatch = currentContent.match(/^---\n([\s\S]*?)\n---/);
              
              if (frontmatterMatch) {
                const existingFrontmatter = frontmatterMatch[1];
                // Preserve date and description if they exist
                const dateMatch = existingFrontmatter.match(/date:\s*([^\n]+)/);
                const descMatch = existingFrontmatter.match(/description:\s*([^\n]+)/);
                
                if (dateMatch) frontmatter += `\ndate: ${dateMatch[1]}`;
                if (descMatch) frontmatter += `\ndescription: ${descMatch[1]}`;
              }
            }

            // Add image if provided (for About page)
            if (imagePath) {
              frontmatter += `\ncover:\n  image: "${imagePath}"`;
            }

            frontmatter += `\n---\n\n${content}`;

            const markdownContent = frontmatter;

            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/${pageName}.md`, {
              method: 'PUT',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Update ${pageName} page`,
                content: btoa(unescape(encodeURIComponent(markdownContent))),
                sha: sha
              })
            });

            if (response.ok) {
              alert('Page updated successfully!');
            } else {
              const error = await response.json();
              alert('Error updating page: ' + (error.message || 'Unknown error'));
            }
          } catch (e) {
            alert('Error updating page: ' + e.message);
          }
        }

        // Section Page Functions
        async function editSectionPage(sectionName) {
          try {
            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/${sectionName}/_index.md`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            if (!response.ok) {
              alert('Error loading section page');
              return;
            }

            const file = await response.json();
            const content = decodeURIComponent(escape(atob(file.content)));
            
            // Parse frontmatter
            const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);
            let title = sectionName.charAt(0).toUpperCase() + sectionName.slice(1);
            let description = '';
            let body = content;
            
            if (frontmatterMatch) {
              const frontmatter = frontmatterMatch[1];
              const bodyContent = frontmatterMatch[2];
              
              const titleMatch = frontmatter.match(/title:\s*["']?([^"'\n]+)["']?/);
              const descMatch = frontmatter.match(/description:\s*["']?([^"'\n]+)["']?/);
              
              if (titleMatch) title = titleMatch[1];
              if (descMatch) description = descMatch[1];
              body = bodyContent;
            }

            // Remove any existing modal first
            const existingModal = document.getElementById('edit-section-modal');
            if (existingModal) {
              existingModal.remove();
            }
            
            // Show edit form
            const form = document.createElement('div');
            form.id = 'edit-section-modal';
            form.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;';
            form.innerHTML = `
              <div style="background:white;padding:20px;border-radius:8px;width:80%;max-width:600px;max-height:80%;overflow-y:auto;position:relative;">
                <button onclick="document.getElementById('edit-section-modal').remove()" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;">&times;</button>
                <h3>Edit ${title} Section Page</h3>
                <form id="edit-section-form">
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Page Title:</label>
                    <input type="text" id="edit-section-title" value="${title}" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                    <small style="color:#666;">This appears as the main heading on the section page</small>
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Description:</label>
                    <input type="text" id="edit-section-description" value="${description}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                    <small style="color:#666;">Optional description that appears below the title</small>
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Content (Markdown):</label>
                    <textarea id="edit-section-content" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;height:200px;">${body}</textarea>
                    <small style="color:#666;">Optional content that appears above the portfolio items</small>
                  </div>
                  <div style="text-align:right;">
                    <button type="button" onclick="document.getElementById('edit-section-modal').remove()" style="background:#6c757d;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;margin-right:10px;">Cancel</button>
                    <button type="submit" style="background:#6f42c1;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">Save</button>
                  </div>
                </form>
              </div>
            `;
            document.body.appendChild(form);
            
            document.getElementById('edit-section-form').addEventListener('submit', async (e) => {
              e.preventDefault();
              const newTitle = document.getElementById('edit-section-title').value;
              const newDescription = document.getElementById('edit-section-description').value;
              const newContent = document.getElementById('edit-section-content').value;
              
              await updateSectionPage(sectionName, file.sha, newTitle, newDescription, newContent);
              form.remove();
            });
          } catch (e) {
            alert('Error loading section page: ' + e.message);
          }
        }

        async function updateSectionPage(sectionName, sha, title, description, content) {
          try {
            let markdownContent = `---
title: "${title}"`;
            
            if (description && description.trim()) {
              markdownContent += `\ndescription: "${description}"`;
            }
            
            markdownContent += `\n---\n\n${content}`;

            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/${sectionName}/_index.md`, {
              method: 'PUT',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Update ${sectionName} section page`,
                content: btoa(unescape(encodeURIComponent(markdownContent))),
                sha: sha
              })
            });

            if (response.ok) {
              alert('Section page updated successfully!');
            } else {
              const error = await response.json();
              alert('Error updating section page: ' + (error.message || 'Unknown error'));
            }
          } catch (e) {
            alert('Error updating section page: ' + e.message);
          }
        }

        // Poetry Management Functions
        function showAddPoetryForm() {
          console.log('showAddPoetryForm function called');
          
          // Remove any existing modal first
          const existingModal = document.getElementById('add-poetry-modal');
          if (existingModal) {
            existingModal.remove();
          }
          
          const form = document.createElement('div');
          form.id = 'add-poetry-modal';
          form.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;';
          form.innerHTML = `
            <div style="background:white;padding:20px;border-radius:8px;width:80%;max-width:600px;max-height:80%;overflow-y:auto;position:relative;">
              <button onclick="document.getElementById('add-poetry-modal').remove()" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;">&times;</button>
              <h3>Add New Poetry Post</h3>
              <form id="add-poetry-form">
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Title:</label>
                  <input type="text" id="poetry-title" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Description:</label>
                  <textarea id="poetry-description" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;height:100px;"></textarea>
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Tags/Labels:</label>
                  <input type="text" id="poetry-tags" placeholder="Poetry, Nature, Love" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  <small style="color:#666;">Separate multiple tags with commas (e.g., Poetry, Nature, Love)</small>
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Cover Image (Optional):</label>
                  <input type="file" id="poetry-image" accept="image/*" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  <small style="color:#666;">Upload an image to accompany your poetry</small>
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Content (Poetry):</label>
                  <textarea id="poetry-content" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;height:300px;" placeholder="Write your poetry here..."></textarea>
                </div>
                <div style="text-align:right;">
                  <button type="button" onclick="document.getElementById('add-poetry-modal').remove()" style="background:#6c757d;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;margin-right:10px;">Cancel</button>
                  <button type="submit" style="background:#e83e8c;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">Create</button>
                </div>
              </form>
            </div>
          `;
          document.body.appendChild(form);
          
          // Image preview handler for add form
          document.getElementById('poetry-image').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = function(e) {
                const preview = document.createElement('div');
                preview.innerHTML = `<img src="${e.target.result}" style="max-width:200px;max-height:200px;margin-top:10px;border-radius:4px;">`;
                const existingPreview = document.querySelector('#add-poetry-modal .image-preview');
                if (existingPreview) existingPreview.remove();
                preview.className = 'image-preview';
                document.getElementById('poetry-image').parentNode.appendChild(preview);
              };
              reader.readAsDataURL(file);
            }
          });

          document.getElementById('add-poetry-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('poetry-title').value;
            const description = document.getElementById('poetry-description').value;
            const tags = document.getElementById('poetry-tags').value;
            const content = document.getElementById('poetry-content').value;
            const imageFile = document.getElementById('poetry-image').files[0];
            
            try {
              let imagePath = '';
              if (imageFile) {
                imagePath = await uploadImage(imageFile);
              }
              
              await createPoetryItem(title, description, tags, content, imagePath);
              form.remove();
              loadPoetryItems(currentToken);
            } catch (error) {
              alert('Error creating poetry post: ' + error.message);
            }
          });
        }

        async function loadPoetryItems(token) {
          if (window.isLoadingPoetry) {
            log('[api] Already loading poetry items, skipping...', 'token');
            return;
          }
          
          window.isLoadingPoetry = true;
          console.log('[debug] Starting to load poetry items...');
          try {
            log('[api] Loading poetry items...', 'token');
            const response = await fetch('https://api.github.com/repos/oos/omarosullivan.com/contents/content/poetry', {
              headers: {
                'Authorization': 'token ' + token,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            if (response.ok) {
              const items = await response.json();
              log('[api] Loaded ' + items.length + ' poetry items', 'token');
              console.log('[debug] Poetry items loaded:', items);
              
              const poetryList = document.getElementById('poetry-list');
              console.log('[debug] Poetry list element:', poetryList);
              poetryList.innerHTML = '';
              
              const poetryItems = items.filter(item => item.name.endsWith('.md'));
              console.log('[debug] Filtered poetry items:', poetryItems);
              
              poetryItems.forEach(item => {
                const div = document.createElement('div');
                div.style.cssText = 'border:1px solid #ddd;padding:10px;margin:5px;border-radius:3px;';
                
                // Handle _index.md files differently (these are section pages, not individual poems)
                if (item.name === '_index.md') {
                  div.innerHTML = `
                    <strong>${item.name} (Poetry Section Page)</strong>
                    <button onclick="editPage('poetry/${item.name.replace('.md', '')}', '${item.sha}')" style="float:right;background:#007cba;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;margin-left:5px;">Edit Section</button>
                  `;
                } else {
                  div.innerHTML = `
                    <strong>${item.name}</strong>
                    <button onclick="editPoetryItem('${item.name}', '${item.sha}')" style="float:right;background:#007cba;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;margin-left:5px;">Edit</button>
                    <button onclick="deletePoetryItem('${item.name}', '${item.sha}')" style="float:right;background:#dc3545;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;">Delete</button>
                  `;
                }
                poetryList.appendChild(div);
                console.log('[debug] Added poetry item to list:', item.name);
              });
              
              return items;
            } else if (response.status === 401) {
              log('[api] Token expired or invalid (401). Clearing tokens and requiring re-authentication.', 'error');
              console.log('[api] Poetry: Clearing invalid tokens...');
              clearInvalidTokens();
              console.log('[api] Poetry: Showing login form...');
              window.showLoginForm();
              console.log('[api] Poetry: Login form should be visible now');
              return [];
            } else {
              log('[api] Failed to load poetry items: ' + response.status, 'error');
              return [];
            }
          } catch (e) {
            log('[api] Error loading poetry items: ' + e.message, 'error');
            return [];
          } finally {
            window.isLoadingPoetry = false;
          }
        }

        async function editPoetryItem(filename, sha) {
          try {
            console.log('editPoetryItem called with filename:', filename, 'sha:', sha);
            // First, get the current content
            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/poetry/${filename}`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            if (!response.ok) {
              alert('Error loading poetry item');
              return;
            }

            const file = await response.json();
            const content = decodeURIComponent(escape(atob(file.content)));
            
            // Parse frontmatter
            const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);
            let title = filename.replace('.md', '');
            let description = '';
            let tags = '';
            let contentText = '';

            if (frontmatterMatch) {
              const frontmatter = frontmatterMatch[1];
              const titleMatch = frontmatter.match(/title:\s*["']?([^"'\n]+)["']?/);
              const descMatch = frontmatter.match(/description:\s*["']?([^"'\n]+)["']?/);
              const tagsMatch = frontmatter.match(/tags:\s*\[([^\]]*)\]/);
              
              if (titleMatch) title = titleMatch[1].trim();
              if (descMatch) description = descMatch[1].trim();
              if (tagsMatch) tags = tagsMatch[1].trim();
              contentText = frontmatterMatch[2];
            } else {
              contentText = content;
            }

            // Create edit form
            const form = document.createElement('div');
            form.id = 'edit-poetry-modal';
            form.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;';

            form.innerHTML = `
              <div style="background:white;padding:20px;border-radius:8px;width:80%;max-width:600px;max-height:80%;overflow-y:auto;position:relative;">
                <button onclick="document.getElementById('edit-poetry-modal').remove()" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;">&times;</button>
                <h3>Edit Poetry Post</h3>
                <form id="edit-poetry-form">
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Title:</label>
                    <input type="text" id="edit-poetry-title" value="${title}" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Description:</label>
                    <input type="text" id="edit-poetry-description" value="${description}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Tags (comma-separated):</label>
                    <input type="text" id="edit-poetry-tags" value="${tags}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Cover Image (optional):</label>
                    <input type="file" id="edit-poetry-image" accept="image/*" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Content (Markdown):</label>
                    <textarea id="edit-poetry-content" rows="10" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">${contentText}</textarea>
                  </div>
                  <div style="text-align:right;">
                    <button type="button" onclick="document.getElementById('edit-poetry-modal').remove()" style="background:#6c757d;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;margin-right:10px;">Cancel</button>
                    <button type="submit" style="background:#28a745;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;">Save</button>
                  </div>
                </form>
              </div>
            `;
            document.body.appendChild(form);

            // Handle form submission
            document.getElementById('edit-poetry-form').addEventListener('submit', async (e) => {
              e.preventDefault();
              try {
                const newTitle = document.getElementById('edit-poetry-title').value;
                const newDescription = document.getElementById('edit-poetry-description').value;
                const newTags = document.getElementById('edit-poetry-tags').value;
                const newContent = document.getElementById('edit-poetry-content').value;
                const imageFile = document.getElementById('edit-poetry-image').files[0];

                let imagePath = null;
                if (imageFile) {
                  imagePath = await uploadImage(imageFile);
                }
                
                await updatePoetryItem(filename, sha, newTitle, newDescription, newTags, newContent, imagePath);

                form.remove();
                loadPoetryItems(currentToken);
              } catch (error) {
                alert('Error updating poetry post: ' + error.message);
              }
            });
          } catch (e) {
            alert('Error loading poetry item: ' + e.message);
          }
        }

        async function deletePoetryItem(filename, sha) {
          try {
            if (!confirm(`Are you sure you want to delete the poetry post "${filename}"? This action cannot be undone.`)) {
              return;
            }

            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/poetry/${filename}`, {
              method: 'DELETE',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Delete poetry post: ${filename}`,
                sha: sha
              })
            });

            if (response.ok) {
              alert('Poetry post deleted successfully!');
              await loadPoetryItems(currentToken);
            } else {
              const error = await response.json();
              alert('Error deleting poetry post: ' + (error.message || 'Unknown error'));
            }
          } catch (e) {
            alert('Error deleting poetry post: ' + e.message);
          }
        }

        async function updatePoetryItem(filename, sha, title, description, tags, content, imageFile) {
          try {
            console.log('updatePoetryItem called with filename:', filename, 'sha:', sha);
            const date = new Date().toISOString().split('T')[0];
            
            // First, get the current content to preserve existing image
            const currentResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/poetry/${filename}`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            let existingImagePath = null;
            if (currentResponse.ok) {
              const currentFile = await currentResponse.json();
              const currentContent = decodeURIComponent(escape(atob(currentFile.content)));
              const frontmatterMatch = currentContent.match(/^---\n([\s\S]*?)\n---/);
              if (frontmatterMatch) {
                const coverMatch = frontmatterMatch[1].match(/cover:\s*image:\s*["']?([^"'\n]+)["']?/);
                if (coverMatch) {
                  existingImagePath = coverMatch[1].trim();
                }
              }
            }

            // Use new image if provided, otherwise keep existing
            const imagePath = imageFile ? await uploadImage(imageFile) : existingImagePath;
            
            // Build frontmatter
            let frontmatter = `---
title: "${title}"
date: ${date}
description: "${description}"`;

            if (tags) {
              const tagsArray = tags.split(',').map(tag => tag.trim()).filter(tag => tag);
              if (tagsArray.length > 0) {
                frontmatter += `\ntags: [${tagsArray.map(tag => `"${tag}"`).join(', ')}]`;
              }
            }

            if (imagePath) {
              frontmatter += `\ncover:\n  image: "${imagePath}"`;
            }

            frontmatter += `\n---\n\n`;

            const markdownContent = frontmatter + content;

            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/poetry/${filename}`, {
              method: 'PUT',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Update poetry post: ${title}`,
                content: btoa(unescape(encodeURIComponent(markdownContent))),
                sha: sha
              })
            });

            if (response.ok) {
              alert('Poetry post updated successfully!');
              await loadPoetryItems(currentToken);
            } else {
              const error = await response.json();
              alert('Error updating poetry post: ' + (error.message || 'Unknown error'));
            }
          } catch (e) {
            alert('Error updating poetry post: ' + e.message);
          }
        }

        async function createPoetryItem(title, description, tags, content, imagePath) {
          try {
            const slug = title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
            const filename = slug + '.md';
            const date = new Date().toISOString().split('T')[0];
            
            let frontmatter = `---
title: "${title}"
date: ${date}
`;

            if (description) {
              frontmatter += `description: "${description}"
`;
            }

            if (tags) {
              const tagArray = tags.split(',').map(tag => tag.trim()).filter(tag => tag);
              if (tagArray.length > 0) {
                frontmatter += `tags: [${tagArray.map(tag => `"${tag}"`).join(', ')}]
`;
              }
            }

            if (imagePath) {
              frontmatter += `cover:
  image: "${imagePath}"
`;
            }

            frontmatter += `---

${content}`;

            // First check if file exists to get SHA
            const checkResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/poetry/${filename}`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            let requestBody = {
              message: `Add poetry post: ${title}`,
              content: btoa(unescape(encodeURIComponent(frontmatter)))
            };

            // If file exists, add SHA to update it
            if (checkResponse.ok) {
              const existingFile = await checkResponse.json();
              requestBody.sha = existingFile.sha;
              requestBody.message = `Update poetry post: ${title}`;
            }

            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/poetry/${filename}`, {
              method: 'PUT',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(requestBody)
            });

            if (response.ok) {
              alert('Poetry post created successfully!');
              await loadPoetryItems(currentToken);
            } else {
              const error = await response.json();
              console.error('GitHub API Error:', error);
              alert('Error creating poetry post: ' + (error.message || 'Unknown error'));
            }
          } catch (e) {
            alert('Error creating poetry post: ' + e.message);
          }
        }

        // Page Management Functions
        function showAddPageForm() {
          console.log('showAddPageForm function called');
          
          // Remove any existing modal first
          const existingModal = document.getElementById('add-page-modal');
          if (existingModal) {
            existingModal.remove();
          }
          
          const form = document.createElement('div');
          form.id = 'add-page-modal';
          form.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;';
          form.innerHTML = `
            <div style="background:white;padding:20px;border-radius:8px;width:80%;max-width:600px;max-height:80%;overflow-y:auto;position:relative;">
              <button onclick="document.getElementById('add-page-modal').remove()" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;">&times;</button>
              <h3>Add New Page</h3>
              <form id="add-page-form">
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Page Title:</label>
                  <input type="text" id="page-title" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  <small style="color:#666;">This will appear in the navigation menu and as the page heading</small>
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">URL Slug:</label>
                  <input type="text" id="page-slug" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  <small style="color:#666;">URL-friendly version (e.g., "poetry" for /poetry/)</small>
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Menu Weight:</label>
                  <input type="number" id="page-weight" value="40" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  <small style="color:#666;">Lower numbers appear first in the menu (Portfolio=10, About=20, Contact=30)</small>
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Content (Markdown) - Optional:</label>
                  <textarea id="page-content" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;height:200px;" placeholder="Optional markdown content for this page"></textarea>
                </div>
                <div style="text-align:right;">
                  <button type="button" onclick="document.getElementById('add-page-modal').remove()" style="background:#6c757d;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;margin-right:10px;">Cancel</button>
                  <button type="submit" style="background:#28a745;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">Create Page</button>
                </div>
              </form>
            </div>
          `;
          document.body.appendChild(form);
          
          // Auto-generate slug from title
          document.getElementById('page-title').addEventListener('input', function(e) {
            const slug = e.target.value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
            document.getElementById('page-slug').value = slug;
          });

          document.getElementById('add-page-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('page-title').value;
            const slug = document.getElementById('page-slug').value;
            const weight = parseInt(document.getElementById('page-weight').value);
            const content = document.getElementById('page-content').value;
            
            console.log('Add page form submitted:', { title, slug, weight, content });
            
            try {
              await createPageAndMenu(title, slug, weight, content);
              form.remove();
            } catch (error) {
              console.error('Error in add page form submission:', error);
              alert('Error creating page: ' + error.message);
            }
          });
        }

        async function createPageAndMenu(title, slug, weight, content) {
          try {
            console.log('createPageAndMenu called with:', { title, slug, weight, content, currentToken: currentToken ? 'exists' : 'missing' });
            
            // Create the page file
            const markdownContent = `---
title: "${title}"
---

${content}
`;

            console.log('Creating page file...');
            const pageResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/${slug}.md`, {
              method: 'PUT',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Add new page: ${title}`,
                content: btoa(unescape(encodeURIComponent(markdownContent)))
              })
            });

            console.log('Page creation response status:', pageResponse.status);

            if (!pageResponse.ok) {
              const error = await pageResponse.json();
              console.error('Error creating page:', error);
              alert('Error creating page: ' + (error.message || 'Unknown error'));
              return;
            }

            // Update the menu in config.toml
            console.log('Loading config file...');
            const configResponse = await fetch('https://api.github.com/repos/oos/omarosullivan.com/contents/config.toml', {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            console.log('Config loading response status:', configResponse.status);

            if (!configResponse.ok) {
              console.error('Error loading config file:', configResponse.status);
              alert('Error loading config file');
              return;
            }

            const configFile = await configResponse.json();
            let configContent = decodeURIComponent(escape(atob(configFile.content)));
            
            console.log('Config file SHA:', configFile.sha);
            
            // Add the new menu item
            const newMenuItem = `  [[menu.main]]
    name = "${title}"
    url = "/${slug}/"
    weight = ${weight}
`;
            
            // Find the last menu item and add after it
            const lastMenuIndex = configContent.lastIndexOf('[[menu.main]]');
            if (lastMenuIndex !== -1) {
              const insertIndex = configContent.indexOf('\n', configContent.lastIndexOf('weight =', lastMenuIndex)) + 1;
              configContent = configContent.slice(0, insertIndex) + newMenuItem + configContent.slice(insertIndex);
            }

            console.log('Updating config file...');
            const updateConfigResponse = await fetch('https://api.github.com/repos/oos/omarosullivan.com/contents/config.toml', {
              method: 'PUT',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Add ${title} to navigation menu`,
                content: btoa(unescape(encodeURIComponent(configContent))),
                sha: configFile.sha
              })
            });

            console.log('Config update response status:', updateConfigResponse.status);

            if (updateConfigResponse.ok) {
              alert('Page created successfully and added to navigation menu!');
              await loadPages(currentToken);
            } else {
              const error = await updateConfigResponse.json();
              console.error('Error updating config:', error);
              alert('Page created but error updating menu: ' + (error.message || 'Unknown error'));
            }
          } catch (e) {
            console.error('Exception in createPageAndMenu:', e);
            alert('Error creating page: ' + e.message);
          }
        }

        async function deletePageAndMenu(pageName, sha) {
          try {
            // Prevent deletion of homepage
            if (pageName === '_index') {
              alert('Cannot delete the homepage. You can edit it instead.');
              return;
            }
            
            // Delete the page file
            const pageResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/${pageName}.md`, {
              method: 'DELETE',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Delete page: ${pageName}`,
                sha: sha
              })
            });

            if (!pageResponse.ok) {
              const error = await pageResponse.json();
              alert('Error deleting page: ' + (error.message || 'Unknown error'));
              return;
            }

            // Remove from menu in config.toml
            const configResponse = await fetch('https://api.github.com/repos/oos/omarosullivan.com/contents/config.toml', {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            if (!configResponse.ok) {
              alert('Error loading config file');
              return;
            }

            const configFile = await configResponse.json();
            let configContent = decodeURIComponent(escape(atob(configFile.content)));
            
            // Remove the menu item
            const menuItemRegex = new RegExp(`\\s*\\[\\[menu\\.main\\]\\]\\s*\\n\\s*name = "${pageName}"\\s*\\n\\s*url = "/${pageName}/"\\s*\\n\\s*weight = \\d+\\s*\\n`, 'g');
            configContent = configContent.replace(menuItemRegex, '');

            const updateConfigResponse = await fetch('https://api.github.com/repos/oos/omarosullivan.com/contents/config.toml', {
              method: 'PUT',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Remove ${pageName} from navigation menu`,
                content: btoa(unescape(encodeURIComponent(configContent))),
                sha: configFile.sha
              })
            });

            if (updateConfigResponse.ok) {
              alert('Page deleted successfully and removed from navigation menu!');
              await loadPages(currentToken);
            } else {
              const error = await updateConfigResponse.json();
              alert('Page deleted but error updating menu: ' + (error.message || 'Unknown error'));
            }
          } catch (e) {
            alert('Error deleting page: ' + e.message);
          }
        }

        // Login button click handler
        loginBtn.addEventListener('click', () => {
          log('[login] Opening OAuth popup...');
          const popup = window.open(
            'https://decap-oauth.netlify.app/oauth/authorize?site_id=omarosullivan.netlify.app',
            'github-oauth',
            'width=600,height=600,scrollbars=yes,resizable=yes'
          );
        });



        // Function to set up button event listeners
        function setupButtonListeners() {
          console.log('Setting up button listeners...');
          
          // Add portfolio button handler
          const addPortfolioBtn = document.getElementById('add-portfolio');
          console.log('Add Portfolio button found:', !!addPortfolioBtn);
          if (addPortfolioBtn) {
            addPortfolioBtn.addEventListener('click', () => {
              console.log('Add Portfolio button clicked');
              showAddPortfolioForm();
            });
          } else {
            console.error('Add Portfolio button not found');
          }

          // Edit about button handler
          const editAboutBtn = document.getElementById('edit-about');
          console.log('Edit About button found:', !!editAboutBtn);
          if (editAboutBtn) {
            editAboutBtn.addEventListener('click', () => {
              console.log('Edit About button clicked');
              editPage('about');
            });
          } else {
            console.log('Edit About button not found (this is normal if page doesn\'t exist)');
          }

          // Edit contact button handler
          const editContactBtn = document.getElementById('edit-contact');
          console.log('Edit Contact button found:', !!editContactBtn);
          if (editContactBtn) {
            editContactBtn.addEventListener('click', () => {
              console.log('Edit Contact button clicked');
              editPage('contact');
            });
          } else {
            console.log('Edit Contact button not found (this is normal if page doesn\'t exist)');
          }
          
          // Main navigation button handler
          const editMainNavBtn = document.getElementById('edit-main-nav');
          console.log('Edit Main Navigation button found:', !!editMainNavBtn);
          if (editMainNavBtn) {
            editMainNavBtn.addEventListener('click', () => {
              console.log('Edit Main Navigation button clicked');
              editMainNavigation();
            });
          } else {
            console.error('Edit Main Navigation button not found');
          }

          // Site settings button handler
          const editSiteSettingsBtn = document.getElementById('edit-site-settings');
          console.log('Edit Site Settings button found:', !!editSiteSettingsBtn);
          if (editSiteSettingsBtn) {
            editSiteSettingsBtn.addEventListener('click', () => {
              console.log('Edit Site Settings button clicked');
              editSiteSettings();
            });
          } else {
            console.error('Edit Site Settings button not found');
          }


          // Add page button handler
          const addPageBtn = document.getElementById('add-page');
          console.log('Add Page button found:', !!addPageBtn);
          if (addPageBtn) {
            addPageBtn.addEventListener('click', () => {
              console.log('Add Page button clicked');
              showAddPageForm();
            });
          } else {
            console.error('Add Page button not found');
          }

          // Add poetry button handler
          const addPoetryBtn = document.getElementById('add-poetry');
          console.log('Add Poetry button found:', !!addPoetryBtn);
          if (addPoetryBtn) {
            addPoetryBtn.addEventListener('click', () => {
              console.log('Add Poetry button clicked');
              showAddPoetryForm();
            });
          } else {
            console.error('Add Poetry button not found');
          }

          // Add photography button handler
          const addPhotographyBtn = document.getElementById('add-photography');
          console.log('Add Photography button found:', !!addPhotographyBtn);
          if (addPhotographyBtn) {
            addPhotographyBtn.addEventListener('click', () => {
              console.log('Add Photography button clicked');
              showAddPhotographyForm();
            });
          } else {
            console.error('Add Photography button not found');
          }
          
          console.log('Button listeners setup complete');
        }



        // Main Navigation Functions
        async function editMainNavigation() {
          try {
            console.log('editMainNavigation function called');
            
            // Close any existing modals first
            const existingModals = document.querySelectorAll('[id$="-modal"]');
            existingModals.forEach(modal => {
              console.log('Removing existing modal:', modal.id);
              modal.remove();
            });
            
            // Small delay to ensure DOM is updated
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Get the current config.toml file
            const response = await fetch('https://api.github.com/repos/oos/omarosullivan.com/contents/config.toml', {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            if (!response.ok) {
              console.error('Error loading config.toml:', response.status, response.statusText);
              alert('Error loading navigation configuration');
              return;
            }

            console.log('Config.toml loaded successfully');
            const file = await response.json();
            const content = decodeURIComponent(escape(atob(file.content)));
            console.log('Config content length:', content.length);
            
            // Parse the current navigation items
            const navItems = [];
            const navRegex = /\[\[menu\.main\]\]\s*\n\s*name\s*=\s*"([^"]+)"\s*\n\s*url\s*=\s*"([^"]+)"\s*\n\s*weight\s*=\s*(\d+)/g;
            let match;
            while ((match = navRegex.exec(content)) !== null) {
              navItems.push({
                name: match[1],
                url: match[2],
                weight: parseInt(match[3])
              });
            }

            // Sort by weight
            navItems.sort((a, b) => a.weight - b.weight);

            // Create edit form
            const form = document.createElement('div');
            form.id = 'edit-main-nav-modal';
            form.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;';

            let navItemsHtml = '';
            navItems.forEach((item, index) => {
              navItemsHtml += `
                <div style="border:1px solid #ddd;padding:15px;margin:10px 0;border-radius:5px;background:#f9f9f9;">
                  <h4 style="margin:0 0 10px 0;">Navigation Item ${index + 1}</h4>
                  <div style="display:grid;grid-template-columns:1fr 1fr 80px;gap:10px;align-items:end;">
                    <div>
                      <label style="display:block;margin-bottom:5px;font-weight:bold;">Name:</label>
                      <input type="text" value="${item.name}" data-field="name" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                    </div>
                    <div>
                      <label style="display:block;margin-bottom:5px;font-weight:bold;">URL:</label>
                      <input type="text" value="${item.url}" data-field="url" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                    </div>
                    <div>
                      <label style="display:block;margin-bottom:5px;font-weight:bold;">Weight:</label>
                      <input type="number" value="${item.weight}" data-field="weight" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                    </div>
                  </div>
                  <button type="button" onclick="removeNavItem(this)" style="background:#dc3545;color:white;border:none;padding:5px 10px;border-radius:3px;cursor:pointer;margin-top:10px;">Remove</button>
                </div>
              `;
            });

            form.innerHTML = `
              <div style="background:white;padding:20px;border-radius:8px;width:90%;max-width:800px;max-height:90%;overflow-y:auto;position:relative;">
                <button onclick="document.getElementById('edit-main-nav-modal').remove()" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;">&times;</button>
                <h3>Edit Main Navigation</h3>
                <div id="nav-items-container">
                  ${navItemsHtml}
                </div>
                <button type="button" onclick="addNavItem()" style="background:#28a745;color:white;border:none;padding:10px 20px;border-radius:3px;cursor:pointer;margin:10px 0;">Add New Navigation Item</button>
                <div style="text-align:right;margin-top:20px;">
                  <button type="button" onclick="document.getElementById('edit-main-nav-modal').remove()" style="background:#6c757d;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;margin-right:10px;">Cancel</button>
                  <button type="button" onclick="console.log('Save Navigation clicked'); saveMainNavigation('${file.sha}')" style="background:#007cba;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;">Save Navigation</button>
                </div>
              </div>
            `;
            document.body.appendChild(form);

          } catch (e) {
            alert('Error loading navigation configuration: ' + e.message);
          }
        }

        function addNavItem() {
          const container = document.getElementById('nav-items-container');
          const newIndex = container.children.length;
          
          const newItem = document.createElement('div');
          newItem.style.cssText = 'border:1px solid #ddd;padding:15px;margin:10px 0;border-radius:5px;background:#f9f9f9;';
          newItem.innerHTML = `
            <h4 style="margin:0 0 10px 0;">Navigation Item ${newIndex + 1}</h4>
            <div style="display:grid;grid-template-columns:1fr 1fr 80px;gap:10px;align-items:end;">
              <div>
                <label style="display:block;margin-bottom:5px;font-weight:bold;">Name:</label>
                <input type="text" value="New Item" data-field="name" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
              </div>
              <div>
                <label style="display:block;margin-bottom:5px;font-weight:bold;">URL:</label>
                <input type="text" value="/new-page/" data-field="url" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
              </div>
              <div>
                <label style="display:block;margin-bottom:5px;font-weight:bold;">Weight:</label>
                <input type="number" value="${newIndex * 10}" data-field="weight" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
              </div>
            </div>
            <button type="button" onclick="removeNavItem(this)" style="background:#dc3545;color:white;border:none;padding:5px 10px;border-radius:3px;cursor:pointer;margin-top:10px;">Remove</button>
          `;
          container.appendChild(newItem);
        }

        function removeNavItem(button) {
          if (confirm('Are you sure you want to remove this navigation item?')) {
            button.parentElement.remove();
          }
        }

        async function saveMainNavigation(sha) {
          try {
            console.log('saveMainNavigation called with sha:', sha);
            const container = document.getElementById('nav-items-container');
            const navItems = [];
            
            console.log('Container children count:', container.children.length);
            
            // Collect all navigation items
            for (let i = 0; i < container.children.length; i++) {
              const item = container.children[i];
              const name = item.querySelector('[data-field="name"]').value;
              const url = item.querySelector('[data-field="url"]').value;
              const weight = parseInt(item.querySelector('[data-field="weight"]').value);
              
              console.log('Item', i, ':', { name, url, weight });
              
              if (name && url) {
                navItems.push({ name, url, weight });
              }
            }
            
            console.log('Collected nav items:', navItems);
            
            // Sort by weight
            navItems.sort((a, b) => a.weight - b.weight);
            
            // Get the current config.toml content
            const response = await fetch('https://api.github.com/repos/oos/omarosullivan.com/contents/config.toml', {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });
            
            const file = await response.json();
            let content = decodeURIComponent(escape(atob(file.content)));
            
            // Remove existing menu.main sections
            content = content.replace(/\[\[menu\.main\]\]\s*\n\s*name\s*=\s*"[^"]+"\s*\n\s*url\s*=\s*"[^"]+"\s*\n\s*weight\s*=\s*\d+\s*\n/g, '');
            
            // Add new menu.main sections
            let newMenuItems = '';
            navItems.forEach(item => {
              newMenuItems += `[[menu.main]]
  name = "${item.name}"
  url = "${item.url}"
  weight = ${item.weight}

`;
            });
            
            // Insert new menu items after the [params] section
            const paramsEndMatch = content.match(/(\[params\]\s*\n[\s\S]*?)(?=\n\[|$)/);
            if (paramsEndMatch) {
              content = content.replace(paramsEndMatch[1], paramsEndMatch[1] + '\n' + newMenuItems);
            } else {
              // If no [params] section, add at the beginning
              content = newMenuItems + content;
            }
            
            // Save the updated config
            console.log('Saving config with content length:', content.length);
            const saveResponse = await fetch('https://api.github.com/repos/oos/omarosullivan.com/contents/config.toml', {
              method: 'PUT',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: 'Update main navigation menu',
                content: btoa(unescape(encodeURIComponent(content))),
                sha: sha
              })
            });
            
            console.log('Save response status:', saveResponse.status);
            
            if (saveResponse.ok) {
              console.log('Navigation updated successfully!');
              alert('Navigation updated successfully!');
              document.getElementById('edit-main-nav-modal').remove();
            } else {
              const error = await saveResponse.json();
              console.error('Error updating navigation:', error);
              alert('Error updating navigation: ' + (error.message || 'Unknown error'));
            }
            
          } catch (e) {
            alert('Error saving navigation: ' + e.message);
          }
        }

        // Photography Management Functions
        function showAddPhotographyForm() {
          console.log('showAddPhotographyForm function called');
          
          // Remove any existing modal first
          const existingModal = document.getElementById('add-photography-modal');
          if (existingModal) {
            existingModal.remove();
          }

          const form = document.createElement('div');
          form.id = 'add-photography-modal';
          form.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;';

          form.innerHTML = `
            <div style="background:white;padding:20px;border-radius:8px;width:80%;max-width:600px;max-height:80%;overflow-y:auto;position:relative;">
              <button onclick="document.getElementById('add-photography-modal').remove()" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;">&times;</button>
              <h3>Add New Photo</h3>
              <form id="add-photography-form">
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Title:</label>
                  <input type="text" id="photography-title" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Description:</label>
                  <input type="text" id="photography-description" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Tags (comma-separated):</label>
                  <input type="text" id="photography-tags" placeholder="e.g., street, portrait, landscape" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Photo:</label>
                  <input type="file" id="photography-image" accept="image/*" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Content (Markdown):</label>
                  <textarea id="photography-content" rows="6" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;" placeholder="Describe the photo, context, or any additional information..."></textarea>
                </div>
                <div style="text-align:right;">
                  <button type="button" onclick="document.getElementById('add-photography-modal').remove()" style="background:#6c757d;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;margin-right:10px;">Cancel</button>
                  <button type="submit" style="background:#6f42c1;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;">Add Photo</button>
                </div>
              </form>
            </div>
          `;
          document.body.appendChild(form);

          // Handle form submission
          document.getElementById('add-photography-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
              const title = document.getElementById('photography-title').value;
              const description = document.getElementById('photography-description').value;
              const tags = document.getElementById('photography-tags').value;
              const content = document.getElementById('photography-content').value;
              const imageFile = document.getElementById('photography-image').files[0];

              if (!imageFile) {
                alert('Please select a photo');
                return;
              }

              // Upload image first
              const imagePath = await uploadImage(imageFile);
              
              // Create photography item
              await createPhotographyItem(title, description, tags, content, imagePath);

              form.remove();
              loadPhotographyItems(currentToken);
            } catch (error) {
              alert('Error adding photo: ' + error.message);
            }
          });
        }

        async function createPhotographyItem(title, description, tags, content, imagePath) {
          try {
            const slug = title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
            const filename = slug + '.md';
            const date = new Date().toISOString().split('T')[0];
            
            // Build frontmatter
            let frontmatter = `---
title: "${title}"
date: ${date}
description: "${description}"`;

            if (tags) {
              const tagsArray = tags.split(',').map(tag => tag.trim()).filter(tag => tag);
              if (tagsArray.length > 0) {
                frontmatter += `\ntags: [${tagsArray.map(tag => `"${tag}"`).join(', ')}]`;
              }
            }

            if (imagePath) {
              frontmatter += `\ncover:\n  image: "${imagePath}"`;
            }

            frontmatter += `\n---\n\n`;

            const markdownContent = frontmatter + content;

            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/photography/${filename}`, {
              method: 'PUT',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Add photography post: ${title}`,
                content: btoa(unescape(encodeURIComponent(markdownContent)))
              })
            });

            if (response.ok) {
              alert('Photo added successfully!');
            } else {
              const error = await response.json();
              alert('Error adding photo: ' + (error.message || 'Unknown error'));
            }
          } catch (e) {
            alert('Error adding photo: ' + e.message);
          }
        }

        async function loadPhotographyItems(token) {
          try {
            if (window.isLoadingPhotography) {
              console.log('[api] Already loading photography items, skipping...');
              return;
            }
            
            window.isLoadingPhotography = true;
            console.log('[debug] Starting to load photography items...');
            
            const response = await fetch('https://api.github.com/repos/oos/omarosullivan.com/contents/content/photography', {
              headers: {
                'Authorization': 'token ' + token,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            if (response.ok) {
              const items = await response.json();
              console.log('[api] Loaded photography items');
              console.log('[debug] Photography items loaded:', items);
              
              const photographyList = document.getElementById('photography-list');
              if (photographyList) {
                photographyList.innerHTML = '';
                
                const photographyItems = items.filter(item => item.name.endsWith('.md'));
                console.log('[debug] Filtered photography items:', photographyItems);
                
                photographyItems.forEach(item => {
                  const div = document.createElement('div');
                  div.style.cssText = 'border:1px solid #ddd;padding:10px;margin:5px;border-radius:3px;';
                  
                  // Handle _index.md files differently (these are section pages, not individual photos)
                  if (item.name === '_index.md') {
                    div.innerHTML = `
                      <strong>${item.name} (Photography Section Page)</strong>
                      <button onclick="editPage('photography/${item.name.replace('.md', '')}', '${item.sha}')" style="float:right;background:#007cba;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;margin-left:5px;">Edit Section</button>
                    `;
                  } else {
                    div.innerHTML = `
                      <strong>${item.name}</strong>
                      <button onclick="editPhotographyItem('${item.name}', '${item.sha}')" style="float:right;background:#007cba;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;margin-left:5px;">Edit</button>
                      <button onclick="deletePhotographyItem('${item.name}', '${item.sha}')" style="float:right;background:#dc3545;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;">Delete</button>
                    `;
                  }
                  photographyList.appendChild(div);
                  console.log('[debug] Added photography item to list:', item.name);
                });
                
                return items;
              } else if (response.status === 401) {
                log('[api] Token expired or invalid (401). Clearing tokens and requiring re-authentication.', 'error');
                console.log('[api] Photography: Clearing invalid tokens...');
                clearInvalidTokens();
              } else {
                log(`[api] Failed to load photography items: ${response.status}`, 'error');
              }
            } finally {
              window.isLoadingPhotography = false;
            }
          } catch (e) {
            log(`[api] Error loading photography items: ${e.message}`, 'error');
            window.isLoadingPhotography = false;
          }
        }

        async function editPhotographyItem(filename, sha) {
          try {
            console.log('editPhotographyItem called with filename:', filename, 'sha:', sha);
            // First, get the current content
            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/photography/${filename}`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            if (!response.ok) {
              alert('Error loading photography item');
              return;
            }

            const file = await response.json();
            const content = decodeURIComponent(escape(atob(file.content)));
            
            // Parse frontmatter
            const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);
            let title = filename.replace('.md', '');
            let description = '';
            let tags = '';
            let contentText = '';

            if (frontmatterMatch) {
              const frontmatter = frontmatterMatch[1];
              const titleMatch = frontmatter.match(/title:\s*["']?([^"'\n]+)["']?/);
              const descMatch = frontmatter.match(/description:\s*["']?([^"'\n]+)["']?/);
              const tagsMatch = frontmatter.match(/tags:\s*\[([^\]]*)\]/);
              
              if (titleMatch) title = titleMatch[1].trim();
              if (descMatch) description = descMatch[1].trim();
              if (tagsMatch) tags = tagsMatch[1].trim();
              contentText = frontmatterMatch[2];
            } else {
              contentText = content;
            }

            // Create edit form
            const form = document.createElement('div');
            form.id = 'edit-photography-modal';
            form.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;';

            form.innerHTML = `
              <div style="background:white;padding:20px;border-radius:8px;width:80%;max-width:600px;max-height:80%;overflow-y:auto;position:relative;">
                <button onclick="document.getElementById('edit-photography-modal').remove()" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;">&times;</button>
                <h3>Edit Photo</h3>
                <form id="edit-photography-form">
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Title:</label>
                    <input type="text" id="edit-photography-title" value="${title}" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Description:</label>
                    <input type="text" id="edit-photography-description" value="${description}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Tags (comma-separated):</label>
                    <input type="text" id="edit-photography-tags" value="${tags}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">New Photo (optional):</label>
                    <input type="file" id="edit-photography-image" accept="image/*" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Content (Markdown):</label>
                    <textarea id="edit-photography-content" rows="6" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">${contentText}</textarea>
                  </div>
                  <div style="text-align:right;">
                    <button type="button" onclick="document.getElementById('edit-photography-modal').remove()" style="background:#6c757d;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;margin-right:10px;">Cancel</button>
                    <button type="submit" style="background:#6f42c1;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;">Save</button>
                  </div>
                </form>
              </div>
            `;
            document.body.appendChild(form);

            // Handle form submission
            document.getElementById('edit-photography-form').addEventListener('submit', async (e) => {
              e.preventDefault();
              try {
                const newTitle = document.getElementById('edit-photography-title').value;
                const newDescription = document.getElementById('edit-photography-description').value;
                const newTags = document.getElementById('edit-photography-tags').value;
                const newContent = document.getElementById('edit-photography-content').value;
                const imageFile = document.getElementById('edit-photography-image').files[0];

                let imagePath = null;
                if (imageFile) {
                  imagePath = await uploadImage(imageFile);
                }
                
                await updatePhotographyItem(filename, sha, newTitle, newDescription, newTags, newContent, imagePath);

                form.remove();
                loadPhotographyItems(currentToken);
              } catch (error) {
                alert('Error updating photo: ' + error.message);
              }
            });
          } catch (e) {
            alert('Error loading photography item: ' + e.message);
          }
        }

        async function updatePhotographyItem(filename, sha, title, description, tags, content, imageFile) {
          try {
            console.log('updatePhotographyItem called with filename:', filename, 'sha:', sha);
            const date = new Date().toISOString().split('T')[0];
            
            // First, get the current content to preserve existing image
            const currentResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/photography/${filename}`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            let existingImagePath = null;
            if (currentResponse.ok) {
              const currentFile = await currentResponse.json();
              const currentContent = decodeURIComponent(escape(atob(currentFile.content)));
              const frontmatterMatch = currentContent.match(/^---\n([\s\S]*?)\n---/);
              if (frontmatterMatch) {
                const coverMatch = frontmatterMatch[1].match(/cover:\s*image:\s*["']?([^"'\n]+)["']?/);
                if (coverMatch) {
                  existingImagePath = coverMatch[1].trim();
                }
              }
            }

            // Use new image if provided, otherwise keep existing
            const imagePath = imageFile ? await uploadImage(imageFile) : existingImagePath;
            
            // Build frontmatter
            let frontmatter = `---
title: "${title}"
date: ${date}
description: "${description}"`;

            if (tags) {
              const tagsArray = tags.split(',').map(tag => tag.trim()).filter(tag => tag);
              if (tagsArray.length > 0) {
                frontmatter += `\ntags: [${tagsArray.map(tag => `"${tag}"`).join(', ')}]`;
              }
            }

            if (imagePath) {
              frontmatter += `\ncover:\n  image: "${imagePath}"`;
            }

            frontmatter += `\n---\n\n`;

            const markdownContent = frontmatter + content;

            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/photography/${filename}`, {
              method: 'PUT',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Update photography post: ${title}`,
                content: btoa(unescape(encodeURIComponent(markdownContent))),
                sha: sha
              })
            });

            if (response.ok) {
              alert('Photo updated successfully!');
              await loadPhotographyItems(currentToken);
            } else {
              const error = await response.json();
              alert('Error updating photo: ' + (error.message || 'Unknown error'));
            }
          } catch (e) {
            alert('Error updating photo: ' + e.message);
          }
        }

        async function deletePhotographyItem(filename, sha) {
          try {
            if (!confirm(`Are you sure you want to delete the photo "${filename}"? This action cannot be undone.`)) {
              return;
            }

            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/photography/${filename}`, {
              method: 'DELETE',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Delete photography post: ${filename}`,
                sha: sha
              })
            });

            if (response.ok) {
              alert('Photo deleted successfully!');
              await loadPhotographyItems(currentToken);
            } else {
              const error = await response.json();
              alert('Error deleting photo: ' + (error.message || 'Unknown error'));
            }
          } catch (e) {
            alert('Error deleting photo: ' + e.message);
          }
        }

        // Site Settings Functions
        async function editSiteSettings() {
          console.log('editSiteSettings function called');
          try {
            console.log('Loading config.toml...');
            // First, get the current config.toml content
            const response = await fetch('https://api.github.com/repos/oos/omarosullivan.com/contents/config.toml', {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            if (!response.ok) {
              alert('Error loading site settings');
              return;
            }

            const file = await response.json();
            const content = decodeURIComponent(escape(atob(file.content)));
            
            // Parse current title from config.toml
            const titleMatch = content.match(/title\s*=\s*["']([^"']+)["']/);
            const descMatch = content.match(/description\s*=\s*["']([^"']+)["']/);
            
            const currentTitle = titleMatch ? titleMatch[1] : 'Omar O\'Sullivan â€” Portfolio';
            const currentDescription = descMatch ? descMatch[1] : 'Work, notes, and experiments.';

            // Remove any existing modal first
            const existingModal = document.getElementById('edit-site-settings-modal');
            if (existingModal) {
              existingModal.remove();
            }
            
            // Show edit form
            const form = document.createElement('div');
            form.id = 'edit-site-settings-modal';
            form.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;';
            form.innerHTML = `
              <div style="background:white;padding:20px;border-radius:8px;width:80%;max-width:600px;max-height:80%;overflow-y:auto;position:relative;">
                <button onclick="document.getElementById('edit-site-settings-modal').remove()" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;">&times;</button>
                <h3>Edit Site Settings</h3>
                <form id="edit-site-settings-form">
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Site Title:</label>
                    <input type="text" id="site-title" value="${currentTitle}" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                    <small style="color:#666;">This appears in the browser tab and as the main site title</small>
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Site Description:</label>
                    <textarea id="site-description" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;height:80px;">${currentDescription}</textarea>
                    <small style="color:#666;">This appears in search results and social media previews</small>
                  </div>
                  <div style="text-align:right;">
                    <button type="button" onclick="document.getElementById('edit-site-settings-modal').remove()" style="background:#6c757d;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;margin-right:10px;">Cancel</button>
                    <button type="submit" style="background:#28a745;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">Save Settings</button>
                  </div>
                </form>
              </div>
            `;
            document.body.appendChild(form);
            
            document.getElementById('edit-site-settings-form').addEventListener('submit', async (e) => {
              e.preventDefault();
              const newTitle = document.getElementById('site-title').value;
              const newDescription = document.getElementById('site-description').value;
              
              console.log('Updating site settings:', { newTitle, newDescription, sha: file.sha });
              
              try {
                await updateSiteSettings(file.sha, newTitle, newDescription, content);
                form.remove();
              } catch (error) {
                console.error('Error updating site settings:', error);
                alert('Error updating site settings: ' + error.message);
              }
            });
          } catch (e) {
            alert('Error loading site settings: ' + e.message);
          }
        }

        async function updateSiteSettings(sha, title, description, content) {
          try {
            console.log('updateSiteSettings called with:', { sha, title, description, currentToken: currentToken ? 'exists' : 'missing' });
            console.log('Original content preview:', content.substring(0, 200) + '...');
            
            // Update title and description in the content
            let updatedContent = content.replace(/title\s*=\s*["'][^"']*["']/, `title = "${title}"`);
            updatedContent = updatedContent.replace(/description\s*=\s*["'][^"']*["']/, `description = "${description}"`);

            console.log('Updated content preview:', updatedContent.substring(0, 200) + '...');
            console.log('Content changed:', content !== updatedContent);

            // Update the file
            const updateResponse = await fetch('https://api.github.com/repos/oos/omarosullivan.com/contents/config.toml', {
              method: 'PUT',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Update site settings: ${title}`,
                content: btoa(unescape(encodeURIComponent(updatedContent))),
                sha: sha
              })
            });

            console.log('Update response status:', updateResponse.status);

            if (updateResponse.ok) {
              const result = await updateResponse.json();
              console.log('Update successful:', result);
              alert('Site settings updated successfully! The changes will be visible after the next site build.');
            } else {
              const error = await updateResponse.json();
              console.error('GitHub API error:', error);
              console.error('Full error response:', error);
              alert('Error updating site settings: ' + (error.message || 'Unknown error') + '\n\nCheck console for details.');
            }
          } catch (e) {
            console.error('Exception in updateSiteSettings:', e);
            alert('Error updating site settings: ' + e.message);
          }
        }

        // Try to authenticate on page load - check immediately and with retry
        function initializeAuth() {
          log('[boot] Initializing authentication...');
          debugStorage();
          
          // Check for existing token immediately
          const existingToken = extractTokenFromStorage();
          if (existingToken) {
            log('[boot] Found existing token, testing authentication...');
            testGitHubAPI(existingToken).then(user => {
              if (user) {
                currentToken = existingToken;
                isAuthenticated = true;
                log('[boot] Authentication successful! Welcome ' + user.login, 'token');
                
                // Hide login section and show CMS interface
                loginSection.style.display = 'none';
                cmsInterface.style.display = 'block';
                
                // Set up button event listeners now that CMS interface is visible
                console.log('About to call setupButtonListeners from init...');
                setupButtonListeners();
                console.log('setupButtonListeners called from init');
                
                // Load content
                loadPortfolioItems(currentToken);
                loadPhotographyItems(currentToken);
                loadPoetryItems(currentToken);
                loadPages(currentToken);
              } else {
                log('[boot] Existing token invalid, clearing storage...');
                clearInvalidTokens();
              }
            }).catch(err => {
              log('[boot] Error testing token: ' + err.message, 'error');
              clearInvalidTokens();
            });
          } else {
            log('[boot] No existing token found');
          }
        }
        
        // Initialize with multiple attempts to handle race conditions
        initializeAuth();
        setTimeout(initializeAuth, 500);
        setTimeout(initializeAuth, 1500);
        setTimeout(initializeAuth, 3000);
        
        // Run regression tests after initialization
        setTimeout(() => {
          console.log('ðŸ” Running automatic regression tests...');
          window.runRegressionTests();
        }, 4000);

        // Update the global function references to point to the actual functions
        window.editPortfolioItem = editPortfolioItem;
        window.editPoetryItem = editPoetryItem;
        window.editPageInternal = editPage;
        window.deletePortfolioItem = deletePortfolioItem;
        window.deletePoetryItem = deletePoetryItem;
        window.deletePageAndMenu = deletePageAndMenu;
        
        // Expose all required functions for regression testing
        window.showAddPortfolioForm = showAddPortfolioForm;
        window.showAddPageForm = showAddPageForm;
        window.showAddPoetryForm = showAddPoetryForm;
        window.loadPortfolioItems = loadPortfolioItems;
        window.loadPages = loadPages;
        window.loadPhotographyItems = loadPhotographyItems;
        window.loadPoetryItems = loadPoetryItems;
        window.createPoetryItem = createPoetryItem;
        window.showAddPhotographyForm = showAddPhotographyForm;
        window.createPhotographyItem = createPhotographyItem;
        window.editPhotographyItem = editPhotographyItem;
        window.updatePhotographyItem = updatePhotographyItem;
        window.deletePhotographyItem = deletePhotographyItem;
        window.editMainNavigation = editMainNavigation;
        window.addNavItem = addNavItem;
        window.removeNavItem = removeNavItem;
        window.saveMainNavigation = saveMainNavigation;
        window.editSiteSettings = editSiteSettings;
        window.setupButtonListeners = setupButtonListeners;
      })();


    </script>
  </body>
</html>