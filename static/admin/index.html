<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Content Manager (Custom Auth)</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <!-- Quill.js WYSIWYG Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    
    <style>
      h5 { font-size: 24px !important; font-weight: bold !important; margin: 20px 0 10px 0 !important; }
      h6 { font-size: 20px !important; font-weight: bold !important; margin: 15px 0 8px 0 !important; }
      
      /* WYSIWYG Editor Styles */
      .editor-container {
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 15px;
      }
      
      .editor-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: #f8f9fa;
        border-bottom: 1px solid #ddd;
        border-radius: 4px 4px 0 0;
      }
      
      .editor-mode-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .editor-mode-toggle label {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 12px;
        color: #666;
        cursor: pointer;
      }
      
      .editor-mode-toggle input[type="radio"] {
        margin: 0;
      }
      
      .quill-editor {
        min-height: 200px;
      }
      
      .html-editor {
        display: none;
        width: 100%;
        min-height: 200px;
        padding: 12px;
        border: none;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 13px;
        line-height: 1.4;
        resize: vertical;
        outline: none;
      }
      
      .html-editor.active {
        display: block;
      }
      
      .quill-editor.active {
        display: block;
      }
      
      .quill-editor:not(.active) {
        display: none;
      }
      
      /* Quill editor customization */
      .ql-editor {
        min-height: 180px;
        font-size: 14px;
        line-height: 1.6;
      }
      
      .ql-toolbar {
        border-bottom: 1px solid #ccc;
      }
      
      .ql-container {
        border: none;
      }
    </style>
  </head>
  <body>
    <div id="login-section" style="text-align:center;margin:20px;">
      <h4>Login with GitHub</h4>
      <button id="login-btn" style="background:#333;color:white;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;">
        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDBDNS4zNzQgMCAwIDUuMzc0IDAgMTJjMCA1LjMwMiAzLjQzOCA5LjggOC4yMDcgMTEuMzg3LjYuMTExLjgyOS0uMjYxLjgyOS0uNTc3di0yLjIzNGMtMy4zMzguNzI2LTQuMDMzLTEuNDE2LTQuMDMzLTEuNDE2LS41NDYtMS4zODctMS4zMzMtMS43NTYtMS4zMzMtMS43NTYtMS4wODktLjc0NS4wODMtLjcyOS4wODMtLjcyOSAxLjIwNS4wODQgMS44MzggMS4yMzcgMS44MzggMS4yMzcgMS4wNyAxLjgzNCAyLjc3NyAxLjMwNCAzLjQ1Mi45OTcuMTA3LS43NzYuNDE1LTEuMzA1Ljc1NS0xLjYwNS0Mi42NjUtLjMwNS01LjQ2Ni0xLjMzNC01LjQ2Ni01LjkzMSAwLTEuMzExLjQ2OS0yLjM4MSAxLjIzNi0zLjIyMS0uMTI0LS4zMDUtLjUzNS0xLjUyNC4xMTctMy4xNzYgMCAwIDEuMDA4LS4zMjIgMy4zMDEgMS4yMy45NTctLjI2NiAxLjk4My0uMzk5IDMuMDAzLS40MDQgMS4wMi4wMDUgMi4wNDcuMTM4IDMuMDA2LjQwNCAyLjI5LTEuNTUyIDMuMjk3LTEuMjMgMy4yOTctMS4yMy42NTMgMS42NTIuMjQyIDIuODcuMTE4IDMuMTc2LjkyLjg0IDEuMjM1IDEuOTExIDEuMjM1IDMuMjIxIDAgNC42MDktMi44MDcgNS42MjQtNS40NzkgNS45MjEuNDI5LjM2OS44MTEuMS4xMS0uODA4LjEwOC0uODM0LjEwOC0xLjczNSAwLTEuNjA1LS4wMTUtMi45MzUtLjAxNS01LjMzNHYtMi4yNDZjMC0uMzE1LjE5OS0uNjg4LjgyOS0uNTc3QzIwLjU2MiAyMS43OTcgMjQgMTcuMzAyIDI0IDEyYzAtNi42MjYtNS4zNzQtMTItMTItMTJ6IiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K" style="width:20px;height:20px;margin-right:8px;vertical-align:middle;">
        Login with GitHub
      </button>
    </div>

    <div id="cms-interface" style="display:none;">
      <h4>Content Management System</h4>
      <div id="collections">
        <h5>Main Navigation</h5>
        <div id="main-nav-section">
          <button id="edit-main-nav" style="background:#007cba;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;margin:5px;">Edit Main Navigation</button>
        </div>
        <h5>Site Settings</h5>
        <div id="site-settings-section">
          <button id="edit-site-settings" style="background:#28a745;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;margin:5px;">Edit Site Settings</button>
        </div>
        <h5>Pages</h5>
        <div id="pages-section">
          <h6>Pages</h6>
          <button id="add-page" style="background:#28a745;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;margin:5px;">Add New Page</button>
          <button id="edit-about" style="background:#007cba;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;margin:5px;">Edit About Page</button>
          <div id="pages-list"></div>
        </div>
        <h5>Collections</h5>
        <div id="poetry-section">
          <h6>Poetry</h6>
          <button id="add-poetry" style="background:#e83e8c;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;margin:5px;">Add New Poetry Post</button>
          <button id="bulk-upload-poetry" style="background:#e83e8c;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;margin:5px;opacity:0.8;">Bulk Upload Poetry</button>
          <div id="poetry-list"></div>
        </div>
        <div id="portfolio-section">
          <h6>Sketches</h6>
          <button id="add-portfolio" style="background:#007cba;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;margin:5px;">Add New Sketch</button>
          <button id="bulk-upload-portfolio" style="background:#007cba;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;margin:5px;opacity:0.8;">Bulk Upload Sketches</button>
          <div id="portfolio-list"></div>
        </div>
        <div id="videography-section">
          <h6>Videography</h6>
          <button id="add-videography" style="background:#fd7e14;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;margin:5px;">Add New Video</button>
          <button id="bulk-upload-videography" style="background:#fd7e14;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;margin:5px;opacity:0.8;">Bulk Upload Videos</button>
          <div id="videography-list"></div>
        </div>
        <div id="photography-section">
          <h6>Photography</h6>
          <button id="add-photography" style="background:#6f42c1;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;margin:5px;">Add New Photo</button>
          <button id="bulk-upload-photography" style="background:#6f42c1;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;margin:5px;opacity:0.8;">Bulk Upload Photos</button>
          <div id="photography-list"></div>
        </div>
      </div>
    </div>

    <script>
      console.log('Admin script starting...');
      
      // Define global functions immediately - before IIFE
      window.editFile = function(filename, sha) {
        console.log('editFile called with:', filename, sha);
        
        // Determine if this is a poetry file or portfolio file based on context
        // Check if we're in the poetry section by looking at the current URL or context
        const isPoetryFile = window.location.hash.includes('poetry') || 
                           document.querySelector('#poetry-list')?.contains(event?.target) ||
                           filename.includes('poetry');
        
        if (isPoetryFile && window.editPoetryItem) {
          console.log('Editing poetry file:', filename);
          window.editPoetryItem(filename, sha);
        } else if (window.editPortfolioItem) {
          console.log('Editing portfolio file:', filename);
              window.editPortfolioItem(filename, sha);
            } else {
              alert('Please wait for the page to load completely');
        }
      };

      window.editPage = function(pageName) {
        console.log('editPage called with:', pageName);
        // Wait for the page to be fully loaded
        if (document.readyState === 'complete' && window.editPageInternal) {
          window.editPageInternal(pageName);
        } else {
          // Retry after a short delay
          setTimeout(() => {
            if (window.editPageInternal) {
              window.editPageInternal(pageName);
            } else {
              alert('Please wait for the page to load completely');
            }
          }, 100);
        }
      };

      window.deleteFile = function(filename, sha) {
        if (confirm('Are you sure you want to delete ' + filename + '?')) {
          // Wait for the page to be fully loaded
          if (document.readyState === 'complete' && window.deletePortfolioItem) {
            window.deletePortfolioItem(filename, sha);
          } else {
            // Retry after a short delay
            setTimeout(() => {
              if (window.deletePortfolioItem) {
                window.deletePortfolioItem(filename, sha);
              } else {
                alert('Please wait for the page to load completely');
              }
            }, 100);
          }
        }
      };

      window.deletePage = function(pageName, sha) {
        if (confirm('Are you sure you want to delete the ' + pageName + ' page? This will also remove it from the navigation menu.')) {
          // Wait for the page to be fully loaded
          if (document.readyState === 'complete' && window.deletePageAndMenu) {
            window.deletePageAndMenu(pageName, sha);
          } else {
            // Retry after a short delay
            setTimeout(() => {
              if (window.deletePageAndMenu) {
                window.deletePageAndMenu(pageName, sha);
              } else {
                alert('Please wait for the page to load completely');
              }
            }, 100);
          }
        }
      };

      window.confirmDeletePage = function(pageName, sha, displayName) {
        if (confirm(`Are you sure you want to delete the "${displayName}" page? This will also remove it from the navigation menu.`)) {
          // Wait for the page to be fully loaded
          if (document.readyState === 'complete' && window.deletePageAndMenu) {
            window.deletePageAndMenu(pageName, sha);
          } else {
            // Retry after a short delay
            setTimeout(() => {
              if (window.deletePageAndMenu) {
                window.deletePageAndMenu(pageName, sha);
              } else {
                alert('Please wait for the page to load completely');
              }
            }, 100);
          }
        }
      };

      window.testGlobalFunctions = function() {
        console.log('Testing global functions...');
        console.log('window.editFile exists:', !!window.editFile);
        console.log('window.editPage exists:', !!window.editPage);
        console.log('window.editPortfolioItem exists:', !!window.editPortfolioItem);
        console.log('window.editPageInternal exists:', !!window.editPageInternal);
        return 'Global functions test complete';
      };

      // Regression test suite to prevent breaking existing functionality
      window.runRegressionTests = function() {
        console.log('🧪 Running regression tests...');
        const tests = [];
        
        // Test 1: Check if all required DOM elements exist
        const requiredElements = [
          'login-section',
          'cms-interface', 
          'login-btn',
          'portfolio-list',
          'pages-list',
          'poetry-list',
          'add-portfolio',
          'add-page',
          'add-poetry',
          'edit-site-settings'
        ];
        
        requiredElements.forEach(id => {
          const element = document.getElementById(id);
          const exists = !!element;
          tests.push({ test: `Element ${id} exists`, passed: exists });
          if (!exists) console.error(`❌ Missing element: ${id}`);
        });
        
        // Test 2: Check if all required functions exist
        const requiredFunctions = [
          'showAddPortfolioForm',
          'showAddPageForm', 
          'showAddPoetryForm',
          'loadPortfolioItems',
          'loadPages',
          'loadPoetryItems',
          'createPoetryItem',
          'editSiteSettings',
          'setupButtonListeners'
        ];
        
        requiredFunctions.forEach(funcName => {
          const exists = typeof window[funcName] === 'function';
          tests.push({ test: `Function ${funcName} exists`, passed: exists });
          if (!exists) console.error(`❌ Missing function: ${funcName}`);
        });
        
        // Test 3: Check if authentication variables are defined
        const authVars = ['currentToken', 'isAuthenticated', 'isLoading'];
        authVars.forEach(varName => {
          const exists = window.hasOwnProperty(varName);
          tests.push({ test: `Variable ${varName} defined`, passed: exists });
          if (!exists) console.error(`❌ Missing variable: ${varName}`);
        });
        
        // Test 4: Check if event listeners are properly attached
        const buttons = ['add-portfolio', 'add-page', 'add-poetry', 'edit-site-settings'];
        buttons.forEach(buttonId => {
          const button = document.getElementById(buttonId);
          if (button) {
            const hasListeners = button.onclick !== null || button.addEventListener !== undefined;
            tests.push({ test: `Button ${buttonId} has listeners`, passed: hasListeners });
            if (!hasListeners) console.error(`❌ Button ${buttonId} missing listeners`);
          }
        });
        
        // Test 5: Check if poetry items are displayed in admin
        const poetryList = document.getElementById('poetry-list');
        if (poetryList) {
          const hasPoetryItems = poetryList.children.length > 0;
          tests.push({ test: 'Poetry items displayed in admin', passed: hasPoetryItems });
          if (!hasPoetryItems) console.error('❌ No poetry items displayed in admin interface');
        }
        
        // Summary
        const passed = tests.filter(t => t.passed).length;
        const total = tests.length;
        const success = passed === total;
        
        console.log(`🧪 Regression tests complete: ${passed}/${total} passed`);
        if (success) {
          console.log('✅ All regression tests passed!');
        } else {
          console.log('❌ Some regression tests failed!');
        }
        
        return { passed, total, success, tests };
      };

      window.showLoginForm = function() {
        // Reset authentication state
        window.currentToken = null;
        window.isAuthenticated = false;
        
        // Show login form and hide CMS interface
        const loginSection = document.getElementById('login-section');
        const cmsInterface = document.getElementById('cms-interface');
        
        if (loginSection) loginSection.style.display = 'block';
        if (cmsInterface) cmsInterface.style.display = 'none';
        
        console.log('[auth] Showing login form due to token expiration');
      };

      (function () {
        console.log('IIFE starting...');
        const loginSection = document.getElementById('login-section');
        const cmsInterface = document.getElementById('cms-interface');
        const loginBtn = document.getElementById('login-btn');
        const portfolioList = document.getElementById('portfolio-list');

        // Expose internal functions to global scope immediately
        window.editPortfolioItem = function(filename, sha) {
          // This will be defined later in the IIFE
          if (typeof editPortfolioItem === 'function') {
            return editPortfolioItem(filename, sha);
          } else {
            alert('Please wait for the page to load completely');
          }
        };

        window.editPageInternal = function(pageName) {
          // This will be defined later in the IIFE
          if (typeof editPage === 'function') {
            return editPage(pageName);
          } else {
            alert('Please wait for the page to load completely');
          }
        };

        window.deletePortfolioItem = function(filename, sha) {
          // This will be defined later in the IIFE
          if (typeof deletePortfolioItem === 'function') {
            return deletePortfolioItem(filename, sha);
          } else {
            alert('Please wait for the page to load completely');
          }
        };

        window.deletePageAndMenu = function(pageName, sha) {
          // This will be defined later in the IIFE
          if (typeof deletePageAndMenu === 'function') {
            return deletePageAndMenu(pageName, sha);
          } else {
            alert('Please wait for the page to load completely');
          }
        };

        let currentToken = null;
        let isLoading = false;
        let isAuthenticated = false;

        function log(msg, kind) {
          // Debug logging disabled for production - only console logging
          if (kind === 'token') {
            console.log('%c' + msg, 'background:#222;color:#0f0;font-weight:bold;padding:2px 6px;');
          } else if (kind === 'error') {
            console.log('%c' + msg, 'background:#222;color:#f00;font-weight:bold;padding:2px 6px;');
          } else {
            console.log(msg);
          }
        }

        // WYSIWYG Editor Helper Functions
        function createWysiwygEditor(containerId, initialContent = '') {
          const container = document.getElementById(containerId);
          if (!container) return null;

          // Create editor container
          const editorContainer = document.createElement('div');
          editorContainer.className = 'editor-container';
          editorContainer.innerHTML = `
            <div class="editor-toolbar">
              <div class="editor-mode-toggle">
                <label>
                  <input type="radio" name="${containerId}-mode" value="wysiwyg" checked>
                  <span>✏️ Visual Editor</span>
                </label>
                <label>
                  <input type="radio" name="${containerId}-mode" value="html">
                  <span>📝 HTML Code</span>
                </label>
              </div>
            </div>
            <div id="${containerId}-quill" class="quill-editor active"></div>
            <textarea id="${containerId}-html" class="html-editor" placeholder="HTML content...">${initialContent}</textarea>
          `;

          // Replace the original textarea
          container.parentNode.insertBefore(editorContainer, container);
          container.style.display = 'none';

          // Initialize Quill editor
          const quill = new Quill(`#${containerId}-quill`, {
            theme: 'snow',
            modules: {
              toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'indent': '-1'}, { 'indent': '+1' }],
                [{ 'align': [] }],
                ['link', 'image'],
                ['clean']
              ]
            }
          });

          // Set initial content
          if (initialContent) {
            quill.root.innerHTML = initialContent;
          }

          // Mode toggle functionality
          const modeRadios = editorContainer.querySelectorAll(`input[name="${containerId}-mode"]`);
          const quillDiv = editorContainer.querySelector('.quill-editor');
          const htmlTextarea = editorContainer.querySelector('.html-editor');

          modeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
              if (this.value === 'wysiwyg') {
                // Switch to WYSIWYG mode
                quillDiv.classList.add('active');
                htmlTextarea.classList.remove('active');
                // Sync HTML content to Quill
                quill.root.innerHTML = htmlTextarea.value;
              } else {
                // Switch to HTML mode
                quillDiv.classList.remove('active');
                htmlTextarea.classList.add('active');
                // Sync Quill content to HTML textarea
                htmlTextarea.value = quill.root.innerHTML;
              }
            });
          });

          // Return object with methods to get/set content
          return {
            getContent: function() {
              if (quillDiv.classList.contains('active')) {
                return quill.root.innerHTML;
              } else {
                return htmlTextarea.value;
              }
            },
            setContent: function(content) {
              quill.root.innerHTML = content;
              htmlTextarea.value = content;
            },
            getQuill: function() {
              return quill;
            }
          };
        }

        function extractTokenFromStorage() {
          const keys = ['netlify-cms.oauth', 'decap-cms.oauth', 'cms.oauth', 'github-token'];
          log('[storage] Starting token extraction...');
          
          for (const key of keys) {
            // Check localStorage first, then sessionStorage as fallback
            let raw = localStorage.getItem(key);
            if (!raw) {
              raw = sessionStorage.getItem(key);
            }
            
            log('[storage] Checking ' + key + ': ' + (raw ? 'found' : 'not found'));
            
            if (raw) {
              log('[storage] Found token in ' + key + ': ' + raw.substring(0, 50) + '...');
              try {
                // Try JSON format first
                if (raw[0] === '{') {
                  const obj = JSON.parse(raw);
                  if (obj && obj.token) {
                    log('[storage] Extracted token from JSON: ' + obj.token.substring(0, 20) + '...');
                    return obj.token;
                  }
                } 
                // Try string format
                else {
                  const m = /authorization:github:success:([^:]+)$/.exec(raw);
                  if (m && m[1]) {
                    log('[storage] Extracted token from string: ' + m[1].substring(0, 20) + '...');
                    return m[1];
                  }
                  // Try direct token format
                  else if (raw.startsWith('gho_')) {
                    log('[storage] Extracted direct token: ' + raw.substring(0, 20) + '...');
                    return raw;
                  }
                }
              } catch (e) {
                log('[storage] Error parsing ' + key + ': ' + e.message, 'error');
              }
            }
          }
          
          log('[storage] No valid token found in any storage key', 'error');
          return null;
        }

        function saveTokenInAllFormats(token) {
          const formats = [
            'authorization:github:success:' + token,
            JSON.stringify({ provider: 'github', type: 'success', token: token }),
            token
          ];
          
          const keys = ['netlify-cms.oauth', 'decap-cms.oauth', 'cms.oauth', 'github-token'];
          
          keys.forEach(key => {
            formats.forEach(format => {
              try {
                // Save to both localStorage and sessionStorage for persistence
                localStorage.setItem(key, format);
                sessionStorage.setItem(key, format);
                log('[storage] Set ' + key + ' = ' + format.substring(0, 50) + '...', 'token');
              } catch (e) {
                log('[storage] Error setting ' + key + ': ' + e.message, 'error');
              }
            });
          });
        }

        function clearInvalidTokens() {
          const keys = ['netlify-cms.oauth', 'decap-cms.oauth', 'cms.oauth', 'github-token'];
          keys.forEach(key => {
            try {
              localStorage.removeItem(key);
              sessionStorage.removeItem(key);
              log('[storage] Cleared invalid token from ' + key);
            } catch (e) {
              log('[storage] Error clearing ' + key + ': ' + e.message, 'error');
            }
          });
        }



        function debugStorage() {
          const keys = ['netlify-cms.oauth', 'decap-cms.oauth', 'cms.oauth', 'github-token'];
          log('[debug] === STORAGE DEBUG ===');
          keys.forEach(key => {
            const local = localStorage.getItem(key);
            const session = sessionStorage.getItem(key);
            log('[debug] ' + key + ' - localStorage: ' + (local ? local.substring(0, 30) + '...' : 'null'));
            log('[debug] ' + key + ' - sessionStorage: ' + (session ? session.substring(0, 30) + '...' : 'null'));
          });
          log('[debug] === END STORAGE DEBUG ===');
        }

        async function testGitHubAPI(token) {
          try {
            log('[api] Testing GitHub API with token...', 'token');
            const response = await fetch('https://api.github.com/user', {
              headers: {
                'Authorization': 'token ' + token,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            if (response.ok) {
              const user = await response.json();
              log('[api] GitHub API successful! User: ' + user.login, 'token');
              return user;
            } else {
              log('[api] GitHub API failed: ' + response.status, 'error');
              return null;
            }
          } catch (e) {
            log('[api] GitHub API error: ' + e.message, 'error');
            return null;
          }
        }


        async function loadPortfolioItems(token) {
          if (window.isLoadingPortfolio) {
            console.log('[api] Already loading sketches, skipping...');
            return;
          }
          
          window.isLoadingPortfolio = true;
          try {
            console.log('[api] Loading sketches...');
            const response = await fetch('https://api.github.com/repos/oos/omarosullivan.com/contents/content/portfolio', {
              headers: {
                'Authorization': 'token ' + token,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            if (response.ok) {
              const items = await response.json();
              console.log('[api] Loaded', items.length, 'sketches');
              
              // Show loading indicator
              if (portfolioList) {
                portfolioList.innerHTML = '<div style="text-align:center;padding:20px;color:#666;">Loading sketches...</div>';
              } else {
                console.error('portfolioList element not found!');
                return [];
              }
              
              // Filter out non-markdown files and prepare for parallel loading
              const markdownItems = items.filter(item => item.name.endsWith('.md'));
              
              // Create all divs first
              const itemsWithMetadata = [];
              
              for (const item of markdownItems) {
                  const div = document.createElement('div');
                  div.style.cssText = 'border:1px solid #ddd;padding:10px;margin:5px;border-radius:3px;';
                
                // Handle _index.md files differently (these are section pages, not individual portfolio items)
                if (item.name === '_index.md') {
                  itemsWithMetadata.push({
                    item: item,
                    isSectionPage: true,
                    order: 0, // Section pages always come first
                    displayTitle: item.name + ' (Portfolio Section Page)',
                    div: div
                  });
                } else {
                  // Prepare for parallel loading
                  itemsWithMetadata.push({
                    item: item,
                    isSectionPage: false,
                    order: 999, // Default order
                    displayTitle: item.name.replace('.md', ''), // Fallback title
                    isFeatured: false,
                    featuredDate: null,
                    content: '',
                    div: div
                  });
                }
              }
              
              // Load all file contents in parallel
              const filePromises = markdownItems
                .filter(item => item.name !== '_index.md')
                .map(async (item) => {
                  try {
                    const fileResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/portfolio/${item.name}`, {
                      headers: {
                        'Authorization': 'token ' + token,
                        'Accept': 'application/vnd.github.v3+json'
                      }
                    });
                    
                    if (fileResponse.ok) {
                      const fileData = await fileResponse.json();
                      const content = decodeURIComponent(escape(atob(fileData.content)));
                      const titleMatch = content.match(/title:\s*["']([^"\n]+)["']/);
                      const displayTitle = titleMatch ? titleMatch[1].trim() : item.name.replace('.md', '');
                      
                      // Check if this item is featured
                      const featuredMatch = content.match(/featured:\s*(true|false)/i);
                      const isFeatured = featuredMatch ? featuredMatch[1].toLowerCase() === 'true' : false;
                      
                      // Check for featured_date field
                      const featuredDateMatch = content.match(/featured_date:\s*([^\n]+)/);
                      const featuredDate = featuredDateMatch ? featuredDateMatch[1].trim() : null;
                      
                      // Check for order field
                      const orderMatch = content.match(/order:\s*(\d+)/);
                      const currentOrder = orderMatch ? parseInt(orderMatch[1]) : 999;
                      
                      return {
                        filename: item.name,
                        displayTitle,
                        isFeatured,
                        featuredDate,
                        order: currentOrder,
                        content
                      };
                    }
                  } catch (e) {
                    console.error('Error loading file content for', item.name, ':', e);
                  }
                  
                  return {
                    filename: item.name,
                    displayTitle: item.name.replace('.md', ''),
                    isFeatured: false,
                    featuredDate: null,
                    order: 999,
                    content: ''
                  };
                });
              
              // Wait for all file contents to load
              console.log('[debug] Waiting for', filePromises.length, 'file promises to complete...');
              const fileResults = await Promise.all(filePromises);
              console.log('[debug] File promises completed, got', fileResults.length, 'results');
              
              // Update the items with the loaded data
              fileResults.forEach(result => {
                const item = itemsWithMetadata.find(i => i.item.name === result.filename);
                if (item) {
                  item.displayTitle = result.displayTitle;
                  item.isFeatured = result.isFeatured;
                  item.featuredDate = result.featuredDate;
                  item.order = result.order;
                  item.content = result.content;
                }
              });
              
              // Sort items: section pages first, then by order field, then by title
              itemsWithMetadata.sort((a, b) => {
                if (a.isSectionPage && !b.isSectionPage) return -1;
                if (!a.isSectionPage && b.isSectionPage) return 1;
                
                // Sort by order field first (lower numbers first)
                if (a.order !== b.order) {
                  return a.order - b.order;
                }
                
                // If order is the same, sort by title alphabetically
                return a.displayTitle.localeCompare(b.displayTitle);
              });
              
              // Clear the loading indicator before populating content
              portfolioList.innerHTML = '';
              
              // Now display the sorted items
              console.log('[debug] Displaying', itemsWithMetadata.length, 'sorted portfolio items');
              for (const itemData of itemsWithMetadata) {
                if (itemData.isSectionPage) {
                  itemData.div.innerHTML = `
                    <strong>${itemData.displayTitle}</strong>
                    <button onclick="editPage('portfolio')" style="float:right;background:#007cba;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;margin-left:5px;">Edit Section</button>
                  `;
                } else {
                  const currentOrder = itemData.order;
                  const isFeatured = itemData.isFeatured;
                  const featuredDate = itemData.featuredDate;
                  const displayTitle = itemData.displayTitle;
                  const item = itemData.item;
                  
                  // Format featured date for display
                  let featuredDateDisplay = '';
                  if (featuredDate) {
                    const date = new Date(featuredDate);
                    featuredDateDisplay = ` (${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'})})`;
                  }
                  
                  itemData.div.innerHTML = `
                    <div style="display:flex;align-items:center;justify-content:space-between;">
                      <div style="display:flex;align-items:center;gap:8px;flex:1;">
                        <label style="display:flex;align-items:center;gap:8px;">
                          <input type="checkbox" ${isFeatured ? 'checked' : ''} onchange="togglePortfolioFeatured('${item.name}', '${item.sha}', this.checked)" style="margin:0;">
                          <strong>${displayTitle}</strong>
                          ${isFeatured ? '<span style="background:#28a745;color:white;padding:2px 6px;border-radius:3px;font-size:11px;margin-left:8px;">Featured on Homepage' + featuredDateDisplay + '</span>' : ''}
                        </label>
                        <div style="display:flex;gap:5px;margin-left:10px;">
                          <button onclick="editPortfolioItem('${item.name}', '${item.sha}')" style="background:#007cba;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;">Edit</button>
                          <button onclick="deletePortfolioItem('${item.name}', '${item.sha}')" style="background:#dc3545;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;">Delete</button>
                        </div>
                        <div style="display:flex;align-items:center;gap:5px;margin-left:20px;">
                          <label style="font-size:12px;color:#666;">Order:</label>
                          <div style="display:inline-flex;align-items:center;gap:5px;">
                            <input type="number" value="${currentOrder}" min="1" max="999" onchange="updatePortfolioOrder('${item.name}', '${item.sha}', this.value)" oninput="showSaveIcon(this)" style="width:60px;padding:2px 4px;border:1px solid #ccc;border-radius:3px;font-size:12px;">
                            <span class="save-icon" style="display:none;color:#28a745;cursor:pointer;font-size:16px;font-weight:bold;" onclick="updatePortfolioOrder('${item.name}', '${item.sha}', this.previousElementSibling.value)">✓</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  `;
                }
                portfolioList.appendChild(itemData.div);
              }
              
              return items;
            } else if (response.status === 401) {
              log('[api] Token expired or invalid (401). Clearing tokens and requiring re-authentication.', 'error');
              console.log('[api] Portfolio: Clearing invalid tokens...');
              clearInvalidTokens();
              console.log('[api] Portfolio: Showing login form...');
              window.showLoginForm();
              console.log('[api] Portfolio: Login form should be visible now');
              return [];
            } else {
              log('[api] Failed to load sketches: ' + response.status, 'error');
              return [];
            }
                      } catch (e) {
            console.error('[api] Error loading sketches:', e);
            console.error('[api] Error stack:', e.stack);
            return [];
          } finally {
            window.isLoadingPortfolio = false;
            // Ensure loading indicator is cleared even if there's an error
            const portfolioList = document.getElementById('portfolio-list');
            if (portfolioList && portfolioList.innerHTML.includes('Loading sketches')) {
              portfolioList.innerHTML = '<div style="text-align:center;padding:20px;color:#666;">Error loading sketches. Please refresh the page.</div>';
            }
          }
        }

        async function loadPages(token) {
          try {
            log('[api] Loading pages...', 'token');
            const response = await fetch('https://api.github.com/repos/oos/omarosullivan.com/contents/content', {
              headers: {
                'Authorization': 'token ' + token,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            if (response.ok) {
              const items = await response.json();
              const pagesList = document.getElementById('pages-list');
              
              pagesList.innerHTML = '';
              
              // Filter for .md files and section directories, avoiding duplicates
              const pages = items.filter(item => {
                if (item.type === 'file') {
                  // Include .md files that are not in subdirectories, include _index.md but exclude other _ files
                  // Exclude sketches.md if portfolio/ directory exists
                  const isSketchesFile = item.name === 'sketches.md';
                  const hasPortfolioDir = items.some(i => i.type === 'dir' && i.name === 'portfolio');
                  
                  return item.name.endsWith('.md') && 
                (item.name === '_index.md' || !item.name.startsWith('_')) && 
                         !(isSketchesFile && hasPortfolioDir);
                } else if (item.type === 'dir') {
                  // Include directories that have _index.md files (sections)
                  // Exclude contact directory if contact.md exists to avoid duplicates
                  const isContactDir = item.name === 'contact';
                  const hasContactFile = items.some(i => i.type === 'file' && i.name === 'contact.md');
                  
                  return !item.name.startsWith('_') && 
                         item.name !== 'posts' && 
                         !(isContactDir && hasContactFile);
                }
                return false;
              });
              
              log('[api] Loaded ' + pages.length + ' pages', 'token');
              
              // Sort pages according to website menu order
              const menuOrder = ['_index', 'about', 'portfolio', 'photography', 'videography', 'poetry', 'contact'];
              pages.sort((a, b) => {
                const aName = a.type === 'file' ? a.name.replace('.md', '') : a.name;
                const bName = b.type === 'file' ? b.name.replace('.md', '') : b.name;
                const aIndex = menuOrder.indexOf(aName);
                const bIndex = menuOrder.indexOf(bName);
                
                // If both are in menu order, sort by menu order
                if (aIndex !== -1 && bIndex !== -1) {
                  return aIndex - bIndex;
                }
                // If only one is in menu order, prioritize it
                if (aIndex !== -1) return -1;
                if (bIndex !== -1) return 1;
                // If neither is in menu order, sort alphabetically
                return aName.localeCompare(bName);
              });
              
              pages.forEach(page => {
                let pageName, displayName;
                
                if (page.type === 'file') {
                  pageName = page.name.replace('.md', '');
                  displayName = pageName === '_index' ? 'Homepage' : pageName.charAt(0).toUpperCase() + pageName.slice(1);
                } else {
                  // It's a directory (section)
                  pageName = page.name;
                  // Special handling for display names
                  if (pageName === 'portfolio') {
                    displayName = 'Sketches';
                  } else {
                    displayName = page.name.charAt(0).toUpperCase() + page.name.slice(1);
                  }
                }
                
                const div = document.createElement('div');
                div.style.cssText = 'border:1px solid #ddd;padding:10px;margin:5px;border-radius:3px;';
                const isHomepage = pageName === '_index';
                const deleteButton = isHomepage ? 
                  '<span style="float:right;color:#666;font-size:12px;padding:4px 8px;">Cannot delete homepage</span>' :
                  `<button onclick="confirmDeletePage('${pageName}', '${page.sha}', '${displayName}')" style="float:right;background:#dc3545;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;">Delete</button>`;
                
                div.innerHTML = `
                  <strong>${displayName}</strong>
                  <button onclick="editPage('${pageName}')" style="float:right;background:#007cba;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;margin-left:5px;">Edit</button>
                  ${deleteButton}
                `;
                pagesList.appendChild(div);
              });
              
              return pages;
            } else if (response.status === 401) {
              log('[api] Token expired or invalid (401). Clearing tokens and requiring re-authentication.', 'error');
              console.log('[api] Pages: Clearing invalid tokens...');
              clearInvalidTokens();
              console.log('[api] Pages: Showing login form...');
              window.showLoginForm();
              console.log('[api] Pages: Login form should be visible now');
              return [];
            } else {
              log('[api] Failed to load pages: ' + response.status, 'error');
              return [];
            }
          } catch (e) {
            log('[api] Error loading pages: ' + e.message, 'error');
            return [];
          }
        }

        async function authenticate() {
          if (isAuthenticated) {
            log('[auth] Already authenticated, skipping...', 'token');
            return true;
          }
          
          const token = extractTokenFromStorage();
          if (!token) {
            log('[auth] No token found in storage', 'error');
            return false;
          }

          log('[auth] Found token, testing authentication...', 'token');
          const user = await testGitHubAPI(token);
          
          if (user) {
            currentToken = token;
            isAuthenticated = true;
            log('[auth] Authentication successful! Welcome ' + user.login, 'token');
            
            // Hide login section and show CMS interface
            loginSection.style.display = 'none';
            cmsInterface.style.display = 'block';
            
            // Set up button event listeners now that CMS interface is visible
            console.log('About to call setupButtonListeners...');
            setupButtonListeners();
            console.log('setupButtonListeners called');
            
            // Load all content types
              await loadPoetryItems(token);
              await loadPortfolioItems(token);
            await loadVideographyItems(token);
            await loadPhotographyItems(token);
              await loadPages(token);
            
            return true;
          } else {
            log('[auth] Authentication failed', 'error');
            return false;
          }
        }

        // Listen for OAuth popup messages
        window.addEventListener('message', (e) => {
          const m = e.data;
          
          // Log all messages for debugging
          log('[message] Received message: ' + JSON.stringify(m));
          
          // Filter out non-OAuth messages to reduce noise
          if (typeof m === 'string' && m.startsWith('authorization:github:success:')) {
            log('[message] OAuth success message received', 'token');
          } else if (m && typeof m === 'object' && m.provider === 'github' && m.type === 'success') {
            log('[message] OAuth success object received', 'token');
          } else {
            // Skip logging non-OAuth messages to reduce noise
            return;
          }
          
          let saved = false;
          try {
            if (typeof m === 'string' && m.startsWith('authorization:github:success:')) {
              const token = m.replace('authorization:github:success:', '');
              saveTokenInAllFormats(token);
              saved = true;
            } else if (m && typeof m === 'object' && m.provider === 'github' && m.type === 'success' && m.token) {
              saveTokenInAllFormats(m.token);
              saved = true;
            }
          } catch (err) {
            log('[message] Error processing message: ' + err.message, 'error');
          }

          if (saved && !isAuthenticated) {
            log('[message] Token saved, attempting authentication...', 'token');
            
            // Single authentication attempt
            setTimeout(() => {
              if (!isAuthenticated) {
                authenticate();
              }
            }, 100);
          }
        });

        // Handle URL token fallback
        try {
          const hash = location.hash || '';
          const qIndex = hash.indexOf('?');
          let urlToken = null;
          if (qIndex !== -1) {
            const qs = hash.slice(qIndex + 1);
            const hp = new URLSearchParams(qs);
            urlToken = hp.get('token');
          }
          const qpToken = new URLSearchParams(location.search).get('token');
          if (qpToken && !urlToken) urlToken = qpToken;

          if (urlToken) {
            saveTokenInAllFormats(urlToken);
            log('[url] TOKEN STORED: ' + urlToken, 'token');
            history.replaceState(null, '', location.pathname + '#/');
            setTimeout(() => {
              if (!isAuthenticated) {
                authenticate();
              }
            }, 100);
            return;
          }
        } catch (e) {
          log('[url] Error parsing URL token: ' + e.message, 'error');
        }

        // Image upload function
        async function uploadImage(file, filename) {
          try {
            // Generate filename if not provided
            if (!filename) {
              const timestamp = Date.now();
              const extension = file.name.split('.').pop();
              filename = `photo-${timestamp}.${extension}`;
            }
            
            const reader = new FileReader();
            return new Promise((resolve, reject) => {
              reader.onload = async function(e) {
                try {
                  const base64Content = e.target.result.split(',')[1];
                  
                  // First check if file exists to get sha
                  let sha = null;
                  try {
                    const checkResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/static/uploads/${filename}`, {
                      headers: {
                        'Authorization': 'token ' + currentToken,
                        'Accept': 'application/vnd.github.v3+json'
                      }
                    });
                    if (checkResponse.ok) {
                      const fileData = await checkResponse.json();
                      sha = fileData.sha;
                    }
                  } catch (e) {
                    // File doesn't exist, that's fine
                  }
                  
                  const requestBody = {
                    message: `Upload image: ${filename}`,
                    content: base64Content
                  };
                  
                  // Add sha if file exists (for updates)
                  if (sha) {
                    requestBody.sha = sha;
                  }
                  
                  const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/static/uploads/${filename}`, {
                    method: 'PUT',
                    headers: {
                      'Authorization': 'token ' + currentToken,
                      'Accept': 'application/vnd.github.v3+json',
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                  });

                  if (response.ok) {
                    resolve(`/uploads/${filename}`);
                  } else {
                    const error = await response.json();
                    reject(new Error('Error uploading image: ' + (error.message || 'Unknown error')));
                  }
                } catch (e) {
                  reject(new Error('Error uploading image: ' + e.message));
                }
              };
              reader.readAsDataURL(file);
            });
          } catch (e) {
            alert('Error uploading image: ' + e.message);
            return false;
          }
        }

        // CRUD Functions
        function showAddPortfolioForm() {
          // Remove any existing modal first
          const existingModal = document.getElementById('add-portfolio-modal');
          if (existingModal) {
            existingModal.remove();
          }
          
          const form = document.createElement('div');
          form.id = 'add-portfolio-modal';
          form.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;';
          form.innerHTML = `
            <div style="background:white;padding:20px;border-radius:8px;width:80%;max-width:600px;max-height:80%;overflow-y:auto;position:relative;">
              <button onclick="document.getElementById('add-portfolio-modal').remove()" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;">&times;</button>
              <h3>Add New Sketch</h3>
              <form id="add-portfolio-form">
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Title:</label>
                  <input type="text" id="portfolio-title" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Description:</label>
                  <textarea id="portfolio-description" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;height:100px;"></textarea>
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Tags/Labels:</label>
                  <input type="text" id="portfolio-tags" placeholder="Oil, Landscape, Painting" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  <small style="color:#666;">Separate multiple tags with commas (e.g., Oil, Landscape, Painting)</small>
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Cover Image:</label>
                  <input type="file" id="portfolio-image" accept="image/*" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  <div id="image-preview" style="margin-top:10px;display:none;">
                    <img id="preview-img" style="max-width:200px;max-height:150px;border:1px solid #ddd;border-radius:4px;">
                    <div id="image-info" style="margin-top:5px;font-size:0.9em;color:#666;"></div>
                  </div>
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Content (Markdown):</label>
                  <textarea id="portfolio-content" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;height:200px;"></textarea>
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:flex;align-items:center;gap:8px;font-weight:bold;">
                    <input type="checkbox" id="portfolio-featured" style="margin:0;">
                    Featured on Homepage
                  </label>
                </div>
                <div style="text-align:right;">
                  <button type="button" onclick="document.getElementById('add-portfolio-modal').remove()" style="background:#6c757d;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;margin-right:10px;">Cancel</button>
                  <button type="submit" style="background:#007cba;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">Create</button>
                </div>
              </form>
            </div>
          `;
          document.body.appendChild(form);
          
          // Image preview handler for add form
          document.getElementById('portfolio-image').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = function(e) {
                document.getElementById('preview-img').src = e.target.result;
                document.getElementById('image-preview').style.display = 'block';
                document.getElementById('image-info').textContent = `File: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
              };
              reader.readAsDataURL(file);
            } else {
              document.getElementById('image-preview').style.display = 'none';
            }
          });

          document.getElementById('add-portfolio-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('portfolio-title').value;
            const description = document.getElementById('portfolio-description').value;
            const tags = document.getElementById('portfolio-tags').value;
            const content = document.getElementById('portfolio-content').value;
            const featured = document.getElementById('portfolio-featured').checked;
            const imageFile = document.getElementById('portfolio-image').files[0];
            
            await createPortfolioItem(title, description, tags, content, imageFile, featured);
            form.remove();
          });
        }

        async function createPortfolioItem(title, description, tags, content, imageFile, featured = false, order = null) {
          try {
            const slug = title.toLowerCase().replace(/[^a-z0-9\s]+/g, '').replace(/\s+/g, '-').replace(/^-|-$/g, '');
            const filename = slug + '.md';
            const date = new Date().toISOString().split('T')[0];
            
            let coverImage = '';
            if (imageFile) {
              // Upload image first
              const imageFilename = slug + '-' + Date.now() + '.' + imageFile.name.split('.').pop();
              const imageResponse = await uploadImage(imageFile, imageFilename);
              if (imageResponse) {
                coverImage = `cover:\n  image: "/uploads/${imageFilename}"`;
              }
            }
            
            // Process tags
            let tagsYaml = '';
            if (tags && tags.trim()) {
              const tagArray = tags.split(',').map(tag => tag.trim()).filter(tag => tag);
              if (tagArray.length > 0) {
                tagsYaml = `tags:\n${tagArray.map(tag => `  - "${tag}"`).join('\n')}`;
              }
            }
            
            const markdownContent = `---
title: "${title}"
date: ${date}
description: "${description}"
${coverImage}
${tagsYaml}
${featured ? 'featured: true' : ''}
${order !== null ? `order: ${order}` : ''}
---

${content}
`;

            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/portfolio/${filename}`, {
              method: 'PUT',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Add sketch: ${title}`,
                content: btoa(unescape(encodeURIComponent(markdownContent)))
              })
            });

            if (response.ok) {
              alert('Sketch created successfully!');
              await loadPortfolioItems(currentToken);
            } else {
              const error = await response.json();
              alert('Error creating sketch: ' + (error.message || 'Unknown error'));
            }
          } catch (e) {
            alert('Error creating sketch: ' + e.message);
          }
        }

        async function editPortfolioItem(filename, sha) {
          try {
            // First, get the current content
            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/portfolio/${filename}`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            if (!response.ok) {
              alert('Error loading sketch');
              return;
            }

            const file = await response.json();
            const content = decodeURIComponent(escape(atob(file.content)));
            
            // Parse frontmatter
            const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);
            let title = filename.replace('.md', '');
            let description = '';
            let tags = '';
            let featured = false;
            let body = content;
            
            if (frontmatterMatch) {
              const frontmatter = frontmatterMatch[1];
              const bodyContent = frontmatterMatch[2];
              
              const titleMatch = frontmatter.match(/title:\s*["']?([^"'\n]+)["']?/);
              const descMatch = frontmatter.match(/description:\s*["']?([^"'\n]*)["']?/);
              const featuredMatch = frontmatter.match(/featured:\s*(true|false)/);
              
              // Parse tags from YAML array format
              const tagsMatch = frontmatter.match(/tags:\s*\n((?:\s*-\s*["'][^"\n]+["']\s*\n?)*)/);
              if (tagsMatch) {
                const tagsLines = tagsMatch[1].split('\n').filter(line => line.trim());
                const tagArray = tagsLines.map(line => {
                  const match = line.match(/-\s*["']([^"\n]+)["']/);
                  return match ? match[1] : '';
                }).filter(tag => tag);
                tags = tagArray.join(', ');
              }
              
              if (titleMatch) title = titleMatch[1];
              if (descMatch) description = descMatch[1];
              if (featuredMatch) featured = featuredMatch[1] === 'true';
              body = bodyContent;
            }

            // Remove any existing modal first
            const existingModal = document.getElementById('edit-portfolio-modal');
            if (existingModal) {
              existingModal.remove();
            }
            
            // Show edit form
            const form = document.createElement('div');
            form.id = 'edit-portfolio-modal';
            form.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;';
            form.innerHTML = `
              <div style="background:white;padding:20px;border-radius:8px;width:80%;max-width:600px;max-height:80%;overflow-y:auto;position:relative;">
                <button onclick="document.getElementById('edit-portfolio-modal').remove()" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;">&times;</button>
                <h3>Edit Sketch</h3>
                <form id="edit-portfolio-form">
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Title:</label>
                    <input type="text" id="edit-portfolio-title" value="${title}" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Description:</label>
                    <textarea id="edit-portfolio-description" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;height:100px;">${description}</textarea>
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Tags/Labels:</label>
                    <input type="text" id="edit-portfolio-tags" value="${tags}" placeholder="Oil, Landscape, Painting" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                    <small style="color:#666;">Separate multiple tags with commas (e.g., Oil, Landscape, Painting)</small>
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Cover Image:</label>
                    <div id="current-image-display" style="margin-bottom:10px;padding:10px;background:#f8f9fa;border:1px solid #dee2e6;border-radius:4px;">
                      <label style="display:block;margin-bottom:5px;font-weight:bold;color:#333;">Existing Image:</label>
                      <div id="current-image-container"></div>
                    </div>
                    <div style="margin-bottom:10px;">
                      <label style="display:block;margin-bottom:5px;font-weight:bold;color:#333;">Replace Image:</label>
                    <input type="file" id="edit-portfolio-image" accept="image/*" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                    <div id="edit-image-preview" style="margin-top:10px;display:none;">
                        <img id="edit-preview-img" style="max-width:200px;max-height:150px;border:1px solid #ddd;border-radius:4px;object-fit:cover;">
                      <div id="edit-image-info" style="margin-top:5px;font-size:0.9em;color:#666;"></div>
                    </div>
                      <div id="edit-portfolio-upload-status" style="display:none;color:#007cba;font-weight:bold;margin-top:5px;"></div>
                    </div>
                    <small style="color:#666;display:block;margin-top:5px;">Select a new image to replace the current one, or leave empty to keep the current image.</small>
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Content:</label>
                    <textarea id="edit-portfolio-content" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;height:200px;">${body}</textarea>
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:flex;align-items:center;gap:8px;font-weight:bold;">
                      <input type="checkbox" id="edit-portfolio-featured" ${featured ? 'checked' : ''} style="margin:0;">
                      Featured on Homepage
                    </label>
                  </div>
                  <div style="text-align:right;">
                    <button type="button" onclick="document.getElementById('edit-portfolio-modal').remove()" style="background:#6c757d;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;margin-right:10px;">Cancel</button>
                    <button type="submit" style="background:#007cba;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">Save</button>
                  </div>
                </form>
              </div>
            `;
            document.body.appendChild(form);
            
            // Initialize WYSIWYG editor for content
            const contentEditor = createWysiwygEditor('edit-portfolio-content', body);
            
            // Display current image
            const currentImageContainer = document.getElementById('current-image-container');
            const currentCoverMatch = content.match(/cover:\s*\n\s*image:\s*["']([^"\n]+)["']/);
            if (currentCoverMatch) {
              const currentImagePath = currentCoverMatch[1];
              currentImageContainer.innerHTML = `
                <img src="${currentImagePath}" style="max-width:200px;max-height:150px;border:1px solid #ddd;border-radius:4px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <div style="display:none;color:#666;font-style:italic;">Image not found: ${currentImagePath}</div>
              `;
            } else {
              currentImageContainer.innerHTML = '<div style="color:#666;font-style:italic;">No current image</div>';
            }
            
            // Image preview handler for edit form
            document.getElementById('edit-portfolio-image').addEventListener('change', function(e) {
              const file = e.target.files[0];
              if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                  document.getElementById('edit-preview-img').src = e.target.result;
                  document.getElementById('edit-image-preview').style.display = 'block';
                  document.getElementById('edit-image-info').textContent = `File: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                };
                reader.readAsDataURL(file);
              } else {
                document.getElementById('edit-image-preview').style.display = 'none';
              }
            });


            document.getElementById('edit-portfolio-form').addEventListener('submit', async (e) => {
              e.preventDefault();
              const newTitle = document.getElementById('edit-portfolio-title').value;
              const newDescription = document.getElementById('edit-portfolio-description').value;
              const newTags = document.getElementById('edit-portfolio-tags').value;
              const newContent = contentEditor ? contentEditor.getContent() : document.getElementById('edit-portfolio-content').value;
              const newFeatured = document.getElementById('edit-portfolio-featured').checked;
              const imageFile = document.getElementById('edit-portfolio-image').files[0];
              const uploadStatus = document.getElementById('edit-portfolio-upload-status');
              
              if (imageFile) {
                try {
                  uploadStatus.textContent = `Uploading ${imageFile.name}...`;
                  uploadStatus.style.display = 'block';
                  uploadStatus.style.color = '#007cba';
                } catch (error) {
                  uploadStatus.textContent = `✗ Upload failed: ${error.message}`;
                  uploadStatus.style.color = '#dc3545';
                  alert(error.message);
                  return;
                }
              }
              
              await updatePortfolioItem(filename, sha, newTitle, newDescription, newTags, newContent, imageFile, newFeatured);
              
              if (imageFile) {
                uploadStatus.textContent = `✓ ${imageFile.name} uploaded successfully`;
                uploadStatus.style.color = '#28a745';
              }
              
              form.remove();
            });
          } catch (e) {
            alert('Error loading portfolio item: ' + e.message);
          }
        }

        async function updatePortfolioItem(filename, sha, title, description, tags, content, imageFile, featured = false) {
          try {
            const date = new Date().toISOString().split('T')[0];
            
            // First, get the current content to preserve existing image
            const currentResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/portfolio/${filename}`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });
            
            let existingCoverImage = '';
            let existingOrder = '';
            if (currentResponse.ok) {
              const currentFile = await currentResponse.json();
              const currentContent = decodeURIComponent(escape(atob(currentFile.content)));
              const coverMatch = currentContent.match(/cover:\s*\n\s*image:\s*["']([^"\n]+)["']/);
              if (coverMatch) {
                existingCoverImage = `cover:\n  image: "${coverMatch[1]}"`;
              }
              const orderMatch = currentContent.match(/order:\s*(\d+)/);
              if (orderMatch) {
                existingOrder = `order: ${orderMatch[1]}`;
              }
            }
            
            let coverImage = existingCoverImage; // Preserve existing image by default
            if (imageFile) {
              // Upload new image only if one is provided
              const slug = title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
              const imageFilename = slug + '-' + Date.now() + '.' + imageFile.name.split('.').pop();
              try {
              const imageResponse = await uploadImage(imageFile, imageFilename);
                coverImage = `cover:\n  image: "/uploads/${imageFilename}"`;
              } catch (error) {
                // If image upload failed, show error and don't proceed with update
                alert(error.message);
                return;
              }
            }
            
            // Process tags
            let tagsYaml = '';
            if (tags && tags.trim()) {
              const tagArray = tags.split(',').map(tag => tag.trim()).filter(tag => tag);
              if (tagArray.length > 0) {
                tagsYaml = `tags:\n${tagArray.map(tag => `  - "${tag}"`).join('\n')}`;
              }
            }
            
            const markdownContent = `---
title: "${title}"
date: ${date}
description: "${description}"
featured: ${featured}
${existingOrder ? existingOrder + '\n' : ''}${coverImage}
${tagsYaml}
---

${content}
`;

            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/portfolio/${filename}`, {
              method: 'PUT',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Update sketch: ${title}`,
                content: btoa(unescape(encodeURIComponent(markdownContent))),
                sha: sha
              })
            });

            if (response.ok) {
              alert('Sketch updated successfully!');
              await loadPortfolioItems(currentToken);
            } else {
              const error = await response.json();
              alert('Error updating sketch: ' + (error.message || 'Unknown error'));
            }
          } catch (e) {
            alert('Error updating sketch: ' + e.message);
          }
        }

        async function deletePortfolioItem(filename, sha) {
          try {
            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/portfolio/${filename}`, {
              method: 'DELETE',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Delete sketch: ${filename}`,
                sha: sha
              })
            });

            if (response.ok) {
              alert('Sketch deleted successfully!');
              console.log('Sketch deleted, reloading portfolio items...');
              try {
                await loadPortfolioItems(currentToken);
                console.log('Portfolio items reloaded successfully');
              } catch (error) {
                console.error('Error reloading portfolio items:', error);
                alert('Sketch deleted but failed to refresh the list. Please refresh the page.');
              }
            } else {
              const error = await response.json();
              alert('Error deleting sketch: ' + (error.message || 'Unknown error'));
            }
          } catch (e) {
            alert('Error deleting sketch: ' + e.message);
          }
        }

        async function toggleFeatured(section, filename, sha, currentFeatured) {
          try {
            // Get current content to preserve all fields
            const currentResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/${section}/${filename}`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            if (!currentResponse.ok) {
              alert('Error fetching current content');
              return;
            }

            const currentFile = await currentResponse.json();
            const currentContent = decodeURIComponent(escape(atob(currentFile.content)));
            
            // Parse frontmatter
            const frontmatterMatch = currentContent.match(/^---\n([\s\S]*?)\n---/);
            if (!frontmatterMatch) {
              alert('Error parsing frontmatter');
              return;
            }

            const frontmatter = frontmatterMatch[1];
            const content = currentContent.replace(/^---\n[\s\S]*?\n---\n\n?/, '');

            // Toggle featured status
            const newFeatured = !currentFeatured;
            const featuredDate = new Date().toISOString();

            // Update frontmatter
            let updatedFrontmatter = frontmatter
              .replace(/featured:\s*(true|false)/, `featured: ${newFeatured}`)
              .replace(/featured_date:\s*[^\n]+/, ''); // Remove existing featured_date

            // Add or update featured field
            if (updatedFrontmatter.includes('featured:')) {
              // Replace existing featured line
              updatedFrontmatter = updatedFrontmatter.replace(/featured:\s*(true|false)/, `featured: ${newFeatured}`);
            } else {
              // Add featured field
              updatedFrontmatter += `\nfeatured: ${newFeatured}`;
            }

            // Add featured_date if featured is true
            if (newFeatured) {
              updatedFrontmatter += `\nfeatured_date: ${featuredDate}`;
            }

            const updatedContent = `---\n${updatedFrontmatter}\n---\n\n${content}`;

            // Update the file
            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/${section}/${filename}`, {
              method: 'PUT',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `${newFeatured ? 'Feature' : 'Unfeature'} ${section} item: ${filename}`,
                content: btoa(unescape(encodeURIComponent(updatedContent))),
                sha: sha
              })
            });

            if (response.ok) {
              alert(`Item ${newFeatured ? 'featured' : 'unfeatured'} successfully!`);
              // Reload the appropriate section
              if (section === 'portfolio') {
                await loadPortfolioItems(currentToken);
              } else if (section === 'poetry') {
                await loadPoetryItems(currentToken);
              } else if (section === 'videography') {
                await loadVideographyItems(currentToken);
              }
            } else {
              const error = await response.json();
              alert('Error updating featured status: ' + (error.message || 'Unknown error'));
            }
          } catch (e) {
            alert('Error toggling featured status: ' + e.message);
          }
        }

        async function editPage(pageName) {
          try {
            // Determine if this is a section (directory) or individual page
            const isSection = ['photography', 'poetry', 'portfolio'].includes(pageName);
            const filePath = isSection ? `${pageName}/_index.md` : `${pageName}.md`;
            
            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/${filePath}`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            if (!response.ok) {
              alert('Error loading page');
              return;
            }

            const file = await response.json();
            const content = decodeURIComponent(escape(atob(file.content)));
            
            // Parse frontmatter
            const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);
            let title = pageName.charAt(0).toUpperCase() + pageName.slice(1);
            let body = content;
            
            if (frontmatterMatch) {
              const frontmatter = frontmatterMatch[1];
              const bodyContent = frontmatterMatch[2];
              
              const titleMatch = frontmatter.match(/title:\s*["']([^"\n]+)["']/);
              
              if (titleMatch) title = titleMatch[1];
              body = bodyContent;
            }

            // Remove any existing modal first
            const existingModal = document.getElementById('edit-page-modal');
            if (existingModal) {
              existingModal.remove();
            }
            
            // Show edit form
            const form = document.createElement('div');
            form.id = 'edit-page-modal';
            form.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;';
            // Check if this is the About page to add image upload and height control
            const isAboutPage = pageName === 'about';
            
            // Parse existing image dimensions and path from content
            let existingImageWidth = '120px';
            let existingImageHeight = '120px';
            let existingImagePath = null;
            if (isAboutPage && body) {
              const widthMatch = body.match(/width:\s*(\d+px)/);
              const heightMatch = body.match(/height:\s*(\d+px)/);
              const srcMatch = body.match(/src="([^"]+)"/);
              if (widthMatch) {
                existingImageWidth = widthMatch[1];
              }
              if (heightMatch) {
                existingImageHeight = heightMatch[1];
              }
              if (srcMatch) {
                existingImagePath = srcMatch[1];
              }
            }
            
            const imageUploadField = isAboutPage ? `
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Page Image:</label>
                    ${existingImagePath ? `
                      <div style="margin-bottom:10px;">
                        <label style="display:block;margin-bottom:5px;font-weight:bold;color:#333;">Existing Image:</label>
                        <img src="${existingImagePath}" alt="Current image" style="max-width:200px;max-height:150px;border:1px solid #ddd;border-radius:4px;object-fit:cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div style="display:none;color:#666;font-style:italic;padding:10px;border:1px solid #ddd;border-radius:4px;">Image not found: ${existingImagePath}</div>
                      </div>
                      <div style="margin-bottom:10px;">
                        <label style="display:block;margin-bottom:5px;font-weight:bold;color:#333;">Replace Image:</label>
                        <input type="file" id="edit-page-image" accept="image/*" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                        <div id="edit-page-image-preview" style="display:none;margin-top:10px;">
                          <img id="edit-page-preview-img" style="max-width:200px;max-height:150px;border:1px solid #ddd;border-radius:4px;object-fit:cover;">
                          <div id="edit-page-image-info" style="color:#666;font-size:12px;margin-top:5px;"></div>
                        </div>
                        <div id="edit-page-upload-status" style="display:none;color:#007cba;font-weight:bold;margin-top:5px;"></div>
                      </div>
                    ` : `
                      <input type="file" id="edit-page-image" accept="image/*" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                      <div id="edit-page-image-preview" style="display:none;margin-top:10px;">
                        <img id="edit-page-preview-img" style="max-width:200px;max-height:150px;border:1px solid #ddd;border-radius:4px;object-fit:cover;">
                        <div id="edit-page-image-info" style="color:#666;font-size:12px;margin-top:5px;"></div>
                      </div>
                      <div id="edit-page-upload-status" style="display:none;color:#007cba;font-weight:bold;margin-top:5px;"></div>
                    `}
                    <small style="color:#666;font-size:12px;">Select a new image to replace the current one, or leave empty to keep the current image.</small>
                  </div>
                  <div style="margin-bottom:15px;">
                    <div style="display:flex;align-items:center;margin-bottom:10px;">
                      <label style="font-weight:bold;margin-right:10px;">Image Dimensions:</label>
                      <label style="display:flex;align-items:center;cursor:pointer;font-size:14px;color:#666;">
                        <input type="checkbox" id="edit-page-aspect-lock" checked style="margin-right:5px;">
                        <span>🔒 Lock aspect ratio</span>
                      </label>
                    </div>
                    <div style="display:flex;gap:10px;align-items:end;">
                      <div style="flex:1;">
                        <label style="display:block;margin-bottom:5px;font-weight:bold;">Width:</label>
                        <input type="text" id="edit-page-image-width" value="${existingImageWidth}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;" placeholder="e.g., 120px, 150px">
                      </div>
                      <div style="flex:1;">
                        <label style="display:block;margin-bottom:5px;font-weight:bold;">Height:</label>
                        <input type="text" id="edit-page-image-height" value="${existingImageHeight}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;" placeholder="e.g., 200px, 300px">
                      </div>
                    </div>
                    <small style="color:#666;font-size:12px;display:block;margin-top:5px;">When locked, changing one dimension will automatically adjust the other proportionally.</small>
                  </div>
            ` : '';

            // Parse existing description from frontmatter
            let existingDescription = '';
            if (frontmatterMatch) {
              const frontmatter = frontmatterMatch[1];
              const descMatch = frontmatter.match(/description:\s*["']([^"\n]+)["']/);
              if (descMatch) {
                existingDescription = descMatch[1];
              }
            }

            form.innerHTML = `
              <div style="background:white;padding:20px;border-radius:8px;width:80%;max-width:600px;max-height:80%;overflow-y:auto;position:relative;">
                <button onclick="document.getElementById('edit-page-modal').remove()" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;">&times;</button>
                <h3>Edit ${title} Page</h3>
                <form id="edit-page-form">
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Title:</label>
                    <input type="text" id="edit-page-title" value="${title}" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Description:</label>
                    <input type="text" id="edit-page-description" value="${existingDescription}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;" placeholder="Brief description of this page">
                  </div>
                  ${imageUploadField}
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Content - Optional:</label>
                    <textarea id="edit-page-content" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;height:300px;">${body}</textarea>
                  </div>
                  <div style="text-align:right;">
                    <button type="button" onclick="document.getElementById('edit-page-modal').remove()" style="background:#6c757d;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;margin-right:10px;">Cancel</button>
                    <button type="submit" style="background:#007cba;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">Save</button>
                  </div>
                </form>
              </div>
            `;
            document.body.appendChild(form);
            
            // Initialize WYSIWYG editor for content
            const contentEditor = createWysiwygEditor('edit-page-content', body);
            
            // Add image preview functionality for About page
            if (isAboutPage) {
              const imageInput = document.getElementById('edit-page-image');
              const previewDiv = document.getElementById('edit-page-image-preview');
              const previewImg = document.getElementById('edit-page-preview-img');
              const imageInfo = document.getElementById('edit-page-image-info');
              
              imageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                  const reader = new FileReader();
                  reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    previewDiv.style.display = 'block';
                    imageInfo.textContent = `File: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                  };
                  reader.readAsDataURL(file);
                } else {
                  previewDiv.style.display = 'none';
                }
              });

              // Aspect ratio lock functionality
              const aspectLock = document.getElementById('edit-page-aspect-lock');
              const widthInput = document.getElementById('edit-page-image-width');
              const heightInput = document.getElementById('edit-page-image-height');
              let aspectRatio = 1;
              let isUpdating = false;

              // Calculate initial aspect ratio from existing dimensions
              const parseValue = (value) => {
                const match = value.match(/(\d+(?:\.\d+)?)/);
                return match ? parseFloat(match[1]) : 0;
              };

              const formatValue = (value, unit) => {
                return `${Math.round(value)}${unit}`;
              };

              const getUnit = (value) => {
                const match = value.match(/(\d+(?:\.\d+)?)(.*)/);
                return match ? match[2] : 'px';
              };

              // Initialize aspect ratio from existing values
              const initialWidth = parseValue(existingImageWidth);
              const initialHeight = parseValue(existingImageHeight);
              if (initialWidth > 0 && initialHeight > 0) {
                aspectRatio = initialWidth / initialHeight;
              }

              // Update aspect ratio when image changes
              previewImg.addEventListener('load', function() {
                if (this.naturalWidth > 0 && this.naturalHeight > 0) {
                  aspectRatio = this.naturalWidth / this.naturalHeight;
                }
              });

              // Handle width changes
              widthInput.addEventListener('input', function() {
                if (aspectLock.checked && !isUpdating) {
                  isUpdating = true;
                  const newWidth = parseValue(this.value);
                  if (newWidth > 0) {
                    const unit = getUnit(this.value);
                    const newHeight = newWidth / aspectRatio;
                    heightInput.value = formatValue(newHeight, unit);
                  }
                  isUpdating = false;
                }
              });

              // Handle height changes
              heightInput.addEventListener('input', function() {
                if (aspectLock.checked && !isUpdating) {
                  isUpdating = true;
                  const newHeight = parseValue(this.value);
                  if (newHeight > 0) {
                    const unit = getUnit(this.value);
                    const newWidth = newHeight * aspectRatio;
                    widthInput.value = formatValue(newWidth, unit);
                  }
                  isUpdating = false;
                }
              });

              // Update lock icon when toggled
              aspectLock.addEventListener('change', function() {
                const lockSpan = this.nextElementSibling;
                if (this.checked) {
                  lockSpan.textContent = '🔒 Lock aspect ratio';
                  lockSpan.style.color = '#666';
                } else {
                  lockSpan.textContent = '🔓 Unlock aspect ratio';
                  lockSpan.style.color = '#dc3545';
                }
              });
            }
            
            document.getElementById('edit-page-form').addEventListener('submit', async (e) => {
              e.preventDefault();
              const newTitle = document.getElementById('edit-page-title').value;
              const newDescription = document.getElementById('edit-page-description').value;
              const newContent = contentEditor ? contentEditor.getContent() : document.getElementById('edit-page-content').value;
              
              // Handle image upload and dimensions for About page
              let imagePath = null;
              let imageWidth = null;
              let imageHeight = null;
              if (isAboutPage) {
                const imageFile = document.getElementById('edit-page-image').files[0];
                const uploadStatus = document.getElementById('edit-page-upload-status');
                if (imageFile) {
                  try {
                    uploadStatus.textContent = `Uploading ${imageFile.name}...`;
                    uploadStatus.style.display = 'block';
                    imagePath = await uploadImage(imageFile);
                    uploadStatus.textContent = `✓ ${imageFile.name} uploaded successfully`;
                    uploadStatus.style.color = '#28a745';
                  } catch (error) {
                    uploadStatus.textContent = `✗ Upload failed: ${error.message}`;
                    uploadStatus.style.color = '#dc3545';
                    alert(error.message);
                    return;
                  }
                }
                imageWidth = document.getElementById('edit-page-image-width').value;
                imageHeight = document.getElementById('edit-page-image-height').value;
              }
              
              await updatePage(pageName, file.sha, newTitle, newDescription, newContent, imagePath, imageWidth, imageHeight);
              form.remove();
            });
          } catch (e) {
            alert('Error loading page: ' + e.message);
          }
        }

        async function updatePage(pageName, sha, title, description, content, imagePath = null, imageWidth = null, imageHeight = null) {
          try {
            // Determine if this is a section (directory) or individual page
            const isSection = ['photography', 'poetry', 'portfolio'].includes(pageName);
            const filePath = isSection ? `${pageName}/_index.md` : `${pageName}.md`;
            
            // First get the current file to preserve existing frontmatter
            const currentResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/${filePath}`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            let frontmatter = `---
title: "${title}"`;

            if (currentResponse.ok) {
              const currentFile = await currentResponse.json();
              const currentContent = decodeURIComponent(escape(atob(currentFile.content)));
              const frontmatterMatch = currentContent.match(/^---\n([\s\S]*?)\n---/);
              
              if (frontmatterMatch) {
                const existingFrontmatter = frontmatterMatch[1];
                // Preserve date if it exists
                const dateMatch = existingFrontmatter.match(/date:\s*([^\n]+)/);
                if (dateMatch) frontmatter += `\ndate: ${dateMatch[1]}`;
              }
            }

            // Add description
            if (description) {
              frontmatter += `\ndescription: "${description}"`;
            }

            // Note: We don't add cover frontmatter for About page to avoid theme conflicts
            // The image is handled directly in the content

            // Update image dimensions in content for About page
            let updatedContent = content;
            if (pageName === 'about' && (imageWidth || imageHeight)) {
              // Update the width in the img tag
              if (imageWidth) {
                updatedContent = updatedContent.replace(
                  /width:\s*\d+px/g, 
                  `width: ${imageWidth}`
                );
                
                // If no width was found, add it to the existing style
                if (!updatedContent.includes('width:')) {
                  updatedContent = updatedContent.replace(
                    /style="([^"]*)"/g,
                    `style="$1 width: ${imageWidth};"`
                  );
                }
              }
              
              // Update the height in the img tag
              if (imageHeight) {
                updatedContent = updatedContent.replace(
                  /height:\s*\d+px/g, 
                  `height: ${imageHeight}`
                );
                
                // If no height was found, add it to the existing style
                if (!updatedContent.includes('height:')) {
                  updatedContent = updatedContent.replace(
                    /style="([^"]*)"/g,
                    `style="$1 height: ${imageHeight};"`
                  );
                }
              }
            }

            frontmatter += `\n---\n\n${updatedContent}`;

            const markdownContent = frontmatter;

            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/${filePath}`, {
              method: 'PUT',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Update ${pageName} page`,
                content: btoa(unescape(encodeURIComponent(markdownContent))),
                sha: sha
              })
            });

            if (response.ok) {
              alert('Page updated successfully!');
            } else {
              const error = await response.json();
              alert('Error updating page: ' + (error.message || 'Unknown error'));
            }
          } catch (e) {
            alert('Error updating page: ' + e.message);
          }
        }

        // Section Page Functions
        async function editSectionPage(sectionName) {
          try {
            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/${sectionName}/_index.md`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            if (!response.ok) {
              alert('Error loading section page');
              return;
            }

            const file = await response.json();
            const content = decodeURIComponent(escape(atob(file.content)));
            
            // Parse frontmatter
            const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);
            let title = sectionName.charAt(0).toUpperCase() + sectionName.slice(1);
            let description = '';
            let body = content;
            
            if (frontmatterMatch) {
              const frontmatter = frontmatterMatch[1];
              const bodyContent = frontmatterMatch[2];
              
              const titleMatch = frontmatter.match(/title:\s*["']([^"']+)["']/);
              const descMatch = frontmatter.match(/description:\s*["']([^"']+)["']/);
              
              if (titleMatch) title = titleMatch[1];
              if (descMatch) description = descMatch[1];
              body = bodyContent;
            }

            // Remove any existing modal first
            const existingModal = document.getElementById('edit-section-modal');
            if (existingModal) {
              existingModal.remove();
            }
            
            // Show edit form
            const form = document.createElement('div');
            form.id = 'edit-section-modal';
            form.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;';
            form.innerHTML = `
              <div style="background:white;padding:20px;border-radius:8px;width:80%;max-width:600px;max-height:80%;overflow-y:auto;position:relative;">
                <button onclick="document.getElementById('edit-section-modal').remove()" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;">&times;</button>
                <h3>Edit ${title} Section Page</h3>
                <form id="edit-section-form">
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Page Title:</label>
                    <input type="text" id="edit-section-title" value="${title}" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                    <small style="color:#666;">This appears as the main heading on the section page</small>
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Description:</label>
                    <input type="text" id="edit-section-description" value="${description}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                    <small style="color:#666;">Optional description that appears below the title</small>
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Content (Markdown):</label>
                    <textarea id="edit-section-content" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;height:200px;">${body}</textarea>
                    <small style="color:#666;">Optional content that appears above the portfolio items</small>
                  </div>
                  <div style="text-align:right;">
                    <button type="button" onclick="document.getElementById('edit-section-modal').remove()" style="background:#6c757d;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;margin-right:10px;">Cancel</button>
                    <button type="submit" style="background:#6f42c1;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">Save</button>
                  </div>
                </form>
              </div>
            `;
            document.body.appendChild(form);
            
            document.getElementById('edit-section-form').addEventListener('submit', async (e) => {
              e.preventDefault();
              const newTitle = document.getElementById('edit-section-title').value;
              const newDescription = document.getElementById('edit-section-description').value;
              const newContent = document.getElementById('edit-section-content').value;
              
              await updateSectionPage(sectionName, file.sha, newTitle, newDescription, newContent);
              form.remove();
            });
          } catch (e) {
            alert('Error loading section page: ' + e.message);
          }
        }

        async function updateSectionPage(sectionName, sha, title, description, content) {
          try {
            let markdownContent = `---
title: "${title}"`;
            
            if (description && description.trim()) {
              markdownContent += `\ndescription: "${description}"`;
            }
            
            markdownContent += `\n---\n\n${content}`;

            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/${sectionName}/_index.md`, {
              method: 'PUT',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Update ${sectionName} section page`,
                content: btoa(unescape(encodeURIComponent(markdownContent))),
                sha: sha
              })
            });

            if (response.ok) {
              alert('Section page updated successfully!');
            } else {
              const error = await response.json();
              alert('Error updating section page: ' + (error.message || 'Unknown error'));
            }
          } catch (e) {
            alert('Error updating section page: ' + e.message);
          }
        }

        // Poetry Management Functions
        function showAddPoetryForm() {
          console.log('showAddPoetryForm function called');
          
          // Remove any existing modal first
          const existingModal = document.getElementById('add-poetry-modal');
          if (existingModal) {
            existingModal.remove();
          }
          
          const form = document.createElement('div');
          form.id = 'add-poetry-modal';
          form.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;';
          form.innerHTML = `
            <div style="background:white;padding:20px;border-radius:8px;width:80%;max-width:600px;max-height:80%;overflow-y:auto;position:relative;">
              <button onclick="document.getElementById('add-poetry-modal').remove()" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;">&times;</button>
              <h3>Add New Poetry Post</h3>
              <form id="add-poetry-form">
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Title:</label>
                  <input type="text" id="poetry-title" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Description:</label>
                  <textarea id="poetry-description" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;height:100px;"></textarea>
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Tags/Labels:</label>
                  <input type="text" id="poetry-tags" placeholder="Poetry, Nature, Love" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  <small style="color:#666;">Separate multiple tags with commas (e.g., Poetry, Nature, Love)</small>
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Cover Image (Optional):</label>
                  <input type="file" id="poetry-image" accept="image/*" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  <small style="color:#666;">Upload an image to accompany your poetry</small>
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Content (Poetry):</label>
                  <textarea id="poetry-content" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;height:300px;" placeholder="Write your poetry here..."></textarea>
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:flex;align-items:center;cursor:pointer;">
                    <input type="checkbox" id="poetry-featured" style="margin-right:8px;">
                    <span style="font-weight:bold;">Featured on Homepage</span>
                  </label>
                  <small style="color:#666;margin-left:24px;">Check this to display this poetry on the homepage</small>
                </div>
                <div style="text-align:right;">
                  <button type="button" onclick="document.getElementById('add-poetry-modal').remove()" style="background:#6c757d;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;margin-right:10px;">Cancel</button>
                  <button type="submit" style="background:#e83e8c;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">Create</button>
                </div>
              </form>
            </div>
          `;
          document.body.appendChild(form);
          
          // Image preview handler for add form
          document.getElementById('poetry-image').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = function(e) {
                const preview = document.createElement('div');
                preview.innerHTML = `<img src="${e.target.result}" style="max-width:200px;max-height:200px;margin-top:10px;border-radius:4px;">`;
                const existingPreview = document.querySelector('#add-poetry-modal .image-preview');
                if (existingPreview) existingPreview.remove();
                preview.className = 'image-preview';
                document.getElementById('poetry-image').parentNode.appendChild(preview);
              };
              reader.readAsDataURL(file);
            }
          });

          document.getElementById('add-poetry-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('poetry-title').value;
            const description = document.getElementById('poetry-description').value;
            const tags = document.getElementById('poetry-tags').value;
            const content = document.getElementById('poetry-content').value;
            const imageFile = document.getElementById('poetry-image').files[0];
            const featured = document.getElementById('poetry-featured').checked;
            
            try {
              let imagePath = '';
              if (imageFile) {
                try {
                imagePath = await uploadImage(imageFile);
                } catch (error) {
                  alert(error.message);
                  return;
                }
              }
              
              await createPoetryItem(title, description, tags, content, imagePath, featured);
              form.remove();
              loadPoetryItems(currentToken);
            } catch (error) {
              alert('Error creating poetry post: ' + error.message);
            }
          });
        }

        async function loadPoetryItems(token) {
          if (window.isLoadingPoetry) {
            log('[api] Already loading poetry items, skipping...', 'token');
            return;
          }
          
          window.isLoadingPoetry = true;
          console.log('[debug] Starting to load poetry items...');
          try {
            log('[api] Loading poetry items...', 'token');
            const response = await fetch('https://api.github.com/repos/oos/omarosullivan.com/contents/content/poetry', {
              headers: {
                'Authorization': 'token ' + token,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            if (response.ok) {
              const items = await response.json();
              log('[api] Loaded ' + items.length + ' poetry items', 'token');
              console.log('[debug] Poetry items loaded:', items);
              
              const poetryList = document.getElementById('poetry-list');
              console.log('[debug] Poetry list element:', poetryList);
              poetryList.innerHTML = '';
              
              const poetryItems = items.filter(item => item.name.endsWith('.md'));
              console.log('[debug] Filtered poetry items:', poetryItems);
              
              // First, collect all items with their metadata for sorting
              const itemsWithMetadata = [];
              
              for (const item of poetryItems) {
                  const div = document.createElement('div');
                  div.style.cssText = 'border:1px solid #ddd;padding:10px;margin:5px;border-radius:3px;';
                  
                  // Handle _index.md files differently (these are section pages, not individual poems)
                  if (item.name === '_index.md') {
                    itemsWithMetadata.push({
                      item: item,
                      isSectionPage: true,
                      order: 0, // Section pages always come first
                      displayTitle: item.name + ' (Poetry Section Page)',
                      div: div
                    });
                  } else {
                    // Get the title from the file content
                    try {
                      const fileResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/poetry/${item.name}`, {
                        headers: {
                          'Authorization': 'token ' + token,
                          'Accept': 'application/vnd.github.v3+json'
                        }
                      });
                      
                      if (fileResponse.ok) {
                        const fileData = await fileResponse.json();
                        const content = decodeURIComponent(escape(atob(fileData.content)));
                        const titleMatch = content.match(/title:\s*["']([^"\n]+)["']/);
                        const displayTitle = titleMatch ? titleMatch[1].trim() : item.name.replace('.md', '');
                        
                        // Check if this item is featured
                        const featuredMatch = content.match(/featured:\s*(true|false)/i);
                        const isFeatured = featuredMatch ? featuredMatch[1].toLowerCase() === 'true' : false;
                        
                        // Check for featured_date field
                        const featuredDateMatch = content.match(/featured_date:\s*([^\n]+)/);
                        const featuredDate = featuredDateMatch ? featuredDateMatch[1].trim() : null;
                        
                        // Check for order field
                        const orderMatch = content.match(/order:\s*(\d+)/);
                        const currentOrder = orderMatch ? parseInt(orderMatch[1]) : 999;
                        
                        // Store metadata for sorting
                        itemsWithMetadata.push({
                          item: item,
                          isSectionPage: false,
                          order: currentOrder,
                          displayTitle: displayTitle,
                          isFeatured: isFeatured,
                          featuredDate: featuredDate,
                          content: content,
                          div: div
                        });
                      } else {
                        // Fallback to filename if we can't get the title
                        itemsWithMetadata.push({
                          item: item,
                          isSectionPage: false,
                          order: 999,
                          displayTitle: item.name.replace('.md', ''),
                          isFeatured: false,
                          content: '',
                          div: div
                        });
                      }
                    } catch (error) {
                      // Fallback to filename if there's an error
                      itemsWithMetadata.push({
                        item: item,
                        isSectionPage: false,
                        order: 999,
                        displayTitle: item.name.replace('.md', ''),
                        isFeatured: false,
                        content: '',
                        div: div
                      });
                    }
                  }
                  console.log('[debug] Added poetry item to list:', item.name);
                }
              
              // Sort items: section pages first, then by order field, then by title
              itemsWithMetadata.sort((a, b) => {
                if (a.isSectionPage && !b.isSectionPage) return -1;
                if (!a.isSectionPage && b.isSectionPage) return 1;
                
                // Sort by order field first (lower numbers first)
                if (a.order !== b.order) {
                  return a.order - b.order;
                }
                
                // If order is the same, sort by title alphabetically
                return a.displayTitle.localeCompare(b.displayTitle);
              });
              
              // Clear the loading indicator before populating content
              poetryList.innerHTML = '';
              
              // Now display the sorted items
              for (const itemData of itemsWithMetadata) {
                if (itemData.isSectionPage) {
                  itemData.div.innerHTML = `
                    <strong>${itemData.displayTitle}</strong>
                    <button onclick="editPage('poetry')" style="float:right;background:#007cba;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;margin-left:5px;">Edit Section</button>
                  `;
                } else {
                  const currentOrder = itemData.order;
                  const isFeatured = itemData.isFeatured;
                  const featuredDate = itemData.featuredDate;
                  const displayTitle = itemData.displayTitle;
                  const item = itemData.item;
                  
                  // Format featured date for display
                  let featuredDateDisplay = '';
                  if (featuredDate) {
                    const date = new Date(featuredDate);
                    featuredDateDisplay = ` (${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'})})`;
                  }
                  
                  itemData.div.innerHTML = `
                    <div style="display:flex;align-items:center;justify-content:space-between;">
                      <div style="display:flex;align-items:center;gap:8px;flex:1;">
                        <label style="display:flex;align-items:center;gap:8px;">
                          <input type="checkbox" ${isFeatured ? 'checked' : ''} onchange="togglePoetryFeatured('${item.name}', '${item.sha}', this.checked)" style="margin:0;">
                          <strong>${displayTitle}</strong>
                          ${isFeatured ? '<span style="background:#28a745;color:white;padding:2px 6px;border-radius:3px;font-size:11px;margin-left:8px;">Featured on Homepage' + featuredDateDisplay + '</span>' : ''}
                        </label>
                        <div style="display:flex;gap:5px;margin-left:10px;">
                          <button onclick="editPoetryItem('${item.name}', '${item.sha}')" style="background:#007cba;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;">Edit</button>
                          <button onclick="deletePoetryItem('${item.name}', '${item.sha}')" style="background:#dc3545;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;">Delete</button>
                        </div>
                        <div style="display:flex;align-items:center;gap:5px;margin-left:20px;">
                          <label style="font-size:12px;color:#666;">Order:</label>
                          <div style="display:inline-flex;align-items:center;gap:5px;">
                            <input type="number" value="${currentOrder}" min="1" max="999" onchange="updatePoetryOrder('${item.name}', '${item.sha}', this.value)" oninput="showSaveIcon(this)" style="width:60px;padding:2px 4px;border:1px solid #ccc;border-radius:3px;font-size:12px;">
                            <span class="save-icon" style="display:none;color:#28a745;cursor:pointer;font-size:16px;font-weight:bold;" onclick="updatePoetryOrder('${item.name}', '${item.sha}', this.previousElementSibling.value)">✓</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  `;
                }
                poetryList.appendChild(itemData.div);
              }
              
              return items;
            } else if (response.status === 401) {
              log('[api] Token expired or invalid (401). Clearing tokens and requiring re-authentication.', 'error');
              console.log('[api] Poetry: Clearing invalid tokens...');
              clearInvalidTokens();
              console.log('[api] Poetry: Showing login form...');
              window.showLoginForm();
              console.log('[api] Poetry: Login form should be visible now');
              return [];
            } else {
              log('[api] Failed to load poetry items: ' + response.status, 'error');
              const poetryList = document.getElementById('poetry-list');
              if (poetryList) {
                poetryList.innerHTML = '<div style="text-align:center;padding:20px;color:#666;">Error loading poetry. Please refresh the page.</div>';
              }
              return [];
            }
          } catch (e) {
            log('[api] Error loading poetry items: ' + e.message, 'error');
            console.error('[api] Poetry loading error:', e);
            const poetryList = document.getElementById('poetry-list');
            if (poetryList) {
              poetryList.innerHTML = '<div style="text-align:center;padding:20px;color:#666;">Error loading poetry. Please refresh the page.</div>';
            }
            return [];
          } finally {
            window.isLoadingPoetry = false;
          }
        }

        async function editPoetryItem(filename, sha) {
          try {
            console.log('editPoetryItem called with filename:', filename, 'sha:', sha);
            // First, get the current content
            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/poetry/${filename}`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            if (!response.ok) {
              alert('Error loading poetry item');
              return;
            }

            const file = await response.json();
            const content = decodeURIComponent(escape(atob(file.content)));
            
            // Parse frontmatter
            const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);
            let title = filename.replace('.md', '');
            let description = '';
            let tags = '';
            let contentText = '';
            let featured = false;

            if (frontmatterMatch) {
              const frontmatter = frontmatterMatch[1];
              const titleMatch = frontmatter.match(/title:\s*["']?([^"'\n]+)["']?/);
              const descMatch = frontmatter.match(/description:\s*["']?([^"'\n]*)["']?/);
              const tagsMatch = frontmatter.match(/tags:\s*\[([^\]]*)\]/);
              const featuredMatch = frontmatter.match(/featured:\s*(true|false)/);
              
              if (titleMatch) title = titleMatch[1].trim();
              if (descMatch) description = descMatch[1].trim();
              if (tagsMatch) tags = tagsMatch[1].trim();
              if (featuredMatch) featured = featuredMatch[1] === 'true';
              contentText = frontmatterMatch[2];
            } else {
              contentText = content;
            }

            // Create edit form
            const form = document.createElement('div');
            form.id = 'edit-poetry-modal';
            form.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;';

            form.innerHTML = `
              <div style="background:white;padding:20px;border-radius:8px;width:80%;max-width:600px;max-height:80%;overflow-y:auto;position:relative;">
                <button onclick="document.getElementById('edit-poetry-modal').remove()" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;">&times;</button>
                <h3>Edit Poetry Post</h3>
                <form id="edit-poetry-form">
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Title:</label>
                    <input type="text" id="edit-poetry-title" value="${title}" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Description:</label>
                    <input type="text" id="edit-poetry-description" value="${description}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Tags (comma-separated):</label>
                    <input type="text" id="edit-poetry-tags" value="${tags}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Cover Image (optional):</label>
                    <input type="file" id="edit-poetry-image" accept="image/*" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Content (Markdown):</label>
                    <textarea id="edit-poetry-content" rows="10" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">${contentText}</textarea>
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:flex;align-items:center;cursor:pointer;">
                      <input type="checkbox" id="edit-poetry-featured" ${featured ? 'checked' : ''} style="margin-right:8px;">
                      <span style="font-weight:bold;">Featured on Homepage</span>
                    </label>
                    <small style="color:#666;margin-left:24px;">Check this to display this poetry on the homepage</small>
                  </div>
                  <div style="text-align:right;">
                    <button type="button" onclick="document.getElementById('edit-poetry-modal').remove()" style="background:#6c757d;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;margin-right:10px;">Cancel</button>
                    <button type="submit" style="background:#28a745;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;">Save</button>
                  </div>
                </form>
              </div>
            `;
            document.body.appendChild(form);

            // Handle form submission
            document.getElementById('edit-poetry-form').addEventListener('submit', async (e) => {
              e.preventDefault();
              try {
                const newTitle = document.getElementById('edit-poetry-title').value;
                const newDescription = document.getElementById('edit-poetry-description').value;
                const newTags = document.getElementById('edit-poetry-tags').value;
                const newContent = document.getElementById('edit-poetry-content').value;
                const imageFile = document.getElementById('edit-poetry-image').files[0];
                const newFeatured = document.getElementById('edit-poetry-featured').checked;

                let imagePath = null;
                if (imageFile) {
                  try {
                    imagePath = await uploadImage(imageFile);
                  } catch (error) {
                    alert(error.message);
                    return;
                  }
                }
                
                await updatePoetryItem(filename, sha, newTitle, newDescription, newTags, newContent, imagePath, newFeatured);

                form.remove();
                loadPoetryItems(currentToken);
              } catch (error) {
                alert('Error updating poetry post: ' + error.message);
              }
            });
          } catch (e) {
            alert('Error loading poetry item: ' + e.message);
          }
        }

        async function deletePoetryItem(filename, sha) {
          try {
            if (!confirm(`Are you sure you want to delete the poetry post "${filename}"? This action cannot be undone.`)) {
              return;
            }

            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/poetry/${filename}`, {
              method: 'DELETE',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Delete poetry post: ${filename}`,
                sha: sha
              })
            });

            if (response.ok) {
              alert('Poetry post deleted successfully!');
              console.log('Poetry post deleted, reloading poetry items...');
              try {
                await loadPoetryItems(currentToken);
                console.log('Poetry items reloaded successfully');
              } catch (error) {
                console.error('Error reloading poetry items:', error);
                alert('Poetry post deleted but failed to refresh the list. Please refresh the page.');
              }
            } else {
              const error = await response.json();
              alert('Error deleting poetry post: ' + (error.message || 'Unknown error'));
            }
          } catch (e) {
            alert('Error deleting poetry post: ' + e.message);
          }
        }

        async function updatePoetryItem(filename, sha, title, description, tags, content, imageFile, featured = false) {
          try {
            console.log('updatePoetryItem called with filename:', filename, 'sha:', sha);
            const date = new Date().toISOString().split('T')[0];
            
            // First, get the current content to preserve existing image
            const currentResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/poetry/${filename}`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            let existingImagePath = null;
            let existingOrder = '';
            if (currentResponse.ok) {
              const currentFile = await currentResponse.json();
              const currentContent = decodeURIComponent(escape(atob(currentFile.content)));
              const frontmatterMatch = currentContent.match(/^---\n([\s\S]*?)\n---/);
              if (frontmatterMatch) {
                const coverMatch = frontmatterMatch[1].match(/cover:\s*image:\s*["']([^"\n]+)["']/);
                if (coverMatch) {
                  existingImagePath = coverMatch[1].trim();
                }
                const orderMatch = frontmatterMatch[1].match(/order:\s*(\d+)/);
                if (orderMatch) {
                  existingOrder = `order: ${orderMatch[1]}`;
                }
              }
            }

            // Use new image if provided, otherwise keep existing
            let imagePath = existingImagePath;
            if (imageFile) {
              try {
                imagePath = await uploadImage(imageFile);
              } catch (error) {
                alert(error.message);
                return;
              }
            }
            
            // Build frontmatter
            let frontmatter = `---
title: "${title}"
date: ${date}
description: "${description}"`;

            if (existingOrder) {
              frontmatter += `\n${existingOrder}`;
            }

            if (tags) {
              const tagsArray = tags.split(',').map(tag => tag.trim()).filter(tag => tag);
              if (tagsArray.length > 0) {
                frontmatter += `\ntags: [${tagsArray.map(tag => `"${tag}"`).join(', ')}]`;
              }
            }

            if (imagePath) {
              frontmatter += `\ncover:\n  image: "${imagePath}"`;
            }

            frontmatter += `\n---\n\n`;

            const markdownContent = frontmatter + content;

            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/poetry/${filename}`, {
              method: 'PUT',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Update poetry post: ${title}`,
                content: btoa(unescape(encodeURIComponent(markdownContent))),
                sha: sha
              })
            });

            if (response.ok) {
              alert('Poetry post updated successfully!');
              await loadPoetryItems(currentToken);
            } else {
              const error = await response.json();
              alert('Error updating poetry post: ' + (error.message || 'Unknown error'));
            }
          } catch (e) {
            alert('Error updating poetry post: ' + e.message);
          }
        }

        async function createPoetryItem(title, description, tags, content, imagePath, featured = false, order = null) {
          try {
          const slug = title.toLowerCase().replace(/[^a-z0-9\s]+/g, '').replace(/\s+/g, '-').replace(/^-|-$/g, '');
            const filename = slug + '.md';
          const date = new Date().toISOString().split('T')[0];
          
          let frontmatter = `---
title: "${title}"
date: ${date}
`;

          if (description) {
            frontmatter += `description: "${description}"
`;
          }

          if (tags) {
            const tagArray = tags.split(',').map(tag => tag.trim()).filter(tag => tag);
            if (tagArray.length > 0) {
              frontmatter += `tags: [${tagArray.map(tag => `"${tag}"`).join(', ')}]
`;
            }
          }

          if (imagePath) {
            frontmatter += `cover:
  image: "${imagePath}"
`;
            }

            if (featured) {
              frontmatter += `featured: true
`;
          }

          // Add order field
          if (order !== null) {
            frontmatter += `order: ${order}
`;
          }

          frontmatter += `---

${content}`;

            // First check if file exists to get SHA
            const checkResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/poetry/${filename}`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            let requestBody = {
              message: `Add poetry post: ${title}`,
              content: btoa(unescape(encodeURIComponent(frontmatter)))
            };

            // If file exists, add SHA to update it
            if (checkResponse.ok) {
              const existingFile = await checkResponse.json();
              requestBody.sha = existingFile.sha;
              requestBody.message = `Update poetry post: ${title}`;
            }

            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/poetry/${filename}`, {
            method: 'PUT',
            headers: {
              'Authorization': 'token ' + currentToken,
              'Accept': 'application/vnd.github.v3+json',
              'Content-Type': 'application/json'
            },
              body: JSON.stringify(requestBody)
          });

            if (response.ok) {
              alert('Poetry post created successfully!');
              await loadPoetryItems(currentToken);
            } else {
            const error = await response.json();
              console.error('GitHub API Error:', error);
              alert('Error creating poetry post: ' + (error.message || 'Unknown error'));
            }
          } catch (e) {
            alert('Error creating poetry post: ' + e.message);
          }
        }

        // Page Management Functions
        function showAddPageForm() {
          console.log('showAddPageForm function called');
          
          // Remove any existing modal first
          const existingModal = document.getElementById('add-page-modal');
          if (existingModal) {
            existingModal.remove();
          }
          
          const form = document.createElement('div');
          form.id = 'add-page-modal';
          form.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;';
          form.innerHTML = `
            <div style="background:white;padding:20px;border-radius:8px;width:80%;max-width:600px;max-height:80%;overflow-y:auto;position:relative;">
              <button onclick="document.getElementById('add-page-modal').remove()" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;">&times;</button>
              <h3>Add New Page</h3>
              <form id="add-page-form">
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Page Title:</label>
                  <input type="text" id="page-title" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  <small style="color:#666;">This will appear in the navigation menu and as the page heading</small>
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">URL Slug:</label>
                  <input type="text" id="page-slug" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  <small style="color:#666;">URL-friendly version (e.g., "poetry" for /poetry/)</small>
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Menu Weight:</label>
                  <input type="number" id="page-weight" value="40" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  <small style="color:#666;">Lower numbers appear first in the menu (Portfolio=10, About=20, Contact=30)</small>
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Content (Markdown) - Optional:</label>
                  <textarea id="page-content" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;height:200px;" placeholder="Optional markdown content for this page"></textarea>
                </div>
                <div style="text-align:right;">
                  <button type="button" onclick="document.getElementById('add-page-modal').remove()" style="background:#6c757d;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;margin-right:10px;">Cancel</button>
                  <button type="submit" style="background:#28a745;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">Create Page</button>
                </div>
              </form>
            </div>
          `;
          document.body.appendChild(form);
          
          // Auto-generate slug from title
          document.getElementById('page-title').addEventListener('input', function(e) {
            const slug = e.target.value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
            document.getElementById('page-slug').value = slug;
          });

          document.getElementById('add-page-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('page-title').value;
            const slug = document.getElementById('page-slug').value;
            const weight = parseInt(document.getElementById('page-weight').value);
            const content = document.getElementById('page-content').value;
            
            console.log('Add page form submitted:', { title, slug, weight, content });
            
            try {
              await createPageAndMenu(title, slug, weight, content);
              form.remove();
            } catch (error) {
              console.error('Error in add page form submission:', error);
              alert('Error creating page: ' + error.message);
            }
          });
        }

        async function createPageAndMenu(title, slug, weight, content) {
          try {
            console.log('createPageAndMenu called with:', { title, slug, weight, content, currentToken: currentToken ? 'exists' : 'missing' });
            
            // Create the page file
            const markdownContent = `---
title: "${title}"
---

${content}
`;

            console.log('Creating page file...');
            const pageResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/${slug}.md`, {
              method: 'PUT',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Add new page: ${title}`,
                content: btoa(unescape(encodeURIComponent(markdownContent)))
              })
            });

            console.log('Page creation response status:', pageResponse.status);

            if (!pageResponse.ok) {
              const error = await pageResponse.json();
              console.error('Error creating page:', error);
              alert('Error creating page: ' + (error.message || 'Unknown error'));
              return;
            }

            // Update the menu in config.toml
            console.log('Loading config file...');
            const configResponse = await fetch('https://api.github.com/repos/oos/omarosullivan.com/contents/config.toml', {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            console.log('Config loading response status:', configResponse.status);

            if (!configResponse.ok) {
              console.error('Error loading config file:', configResponse.status);
              alert('Error loading config file');
              return;
            }

            const configFile = await configResponse.json();
            let configContent = decodeURIComponent(escape(atob(configFile.content)));
            
            console.log('Config file SHA:', configFile.sha);
            
            // Add the new menu item
            const newMenuItem = `  [[menu.main]]
    name = "${title}"
    url = "/${slug}/"
    weight = ${weight}
`;
            
            // Find the last menu item and add after it
            const lastMenuIndex = configContent.lastIndexOf('[[menu.main]]');
            if (lastMenuIndex !== -1) {
              const insertIndex = configContent.indexOf('\n', configContent.lastIndexOf('weight =', lastMenuIndex)) + 1;
              configContent = configContent.slice(0, insertIndex) + newMenuItem + configContent.slice(insertIndex);
            }

            console.log('Updating config file...');
            const updateConfigResponse = await fetch('https://api.github.com/repos/oos/omarosullivan.com/contents/config.toml', {
              method: 'PUT',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Add ${title} to navigation menu`,
                content: btoa(unescape(encodeURIComponent(configContent))),
                sha: configFile.sha
              })
            });

            console.log('Config update response status:', updateConfigResponse.status);

            if (updateConfigResponse.ok) {
              alert('Page created successfully and added to navigation menu!');
              await loadPages(currentToken);
            } else {
              const error = await updateConfigResponse.json();
              console.error('Error updating config:', error);
              alert('Page created but error updating menu: ' + (error.message || 'Unknown error'));
            }
          } catch (e) {
            console.error('Exception in createPageAndMenu:', e);
            alert('Error creating page: ' + e.message);
          }
        }

        async function deletePageAndMenu(pageName, sha) {
          try {
            // Prevent deletion of homepage
            if (pageName === '_index') {
              alert('Cannot delete the homepage. You can edit it instead.');
              return;
            }
            
            // Delete the page file
            const pageResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/${pageName}.md`, {
              method: 'DELETE',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Delete page: ${pageName}`,
                sha: sha
              })
            });

            if (!pageResponse.ok) {
              const error = await pageResponse.json();
              alert('Error deleting page: ' + (error.message || 'Unknown error'));
              return;
            }

            // Remove from menu in config.toml
            const configResponse = await fetch('https://api.github.com/repos/oos/omarosullivan.com/contents/config.toml', {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            if (!configResponse.ok) {
              alert('Error loading config file');
              return;
            }

            const configFile = await configResponse.json();
            let configContent = decodeURIComponent(escape(atob(configFile.content)));
            
            // Remove the menu item
            const menuItemRegex = new RegExp(`\\s*\\[\\[menu\\.main\\]\\]\\s*\\n\\s*name = "${pageName}"\\s*\\n\\s*url = "/${pageName}/"\\s*\\n\\s*weight = \\d+\\s*\\n`, 'g');
            configContent = configContent.replace(menuItemRegex, '');

            const updateConfigResponse = await fetch('https://api.github.com/repos/oos/omarosullivan.com/contents/config.toml', {
              method: 'PUT',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Remove ${pageName} from navigation menu`,
                content: btoa(unescape(encodeURIComponent(configContent))),
                sha: configFile.sha
              })
            });

            if (updateConfigResponse.ok) {
              alert('Page deleted successfully and removed from navigation menu!');
              await loadPages(currentToken);
            } else {
              const error = await updateConfigResponse.json();
              alert('Page deleted but error updating menu: ' + (error.message || 'Unknown error'));
            }
          } catch (e) {
            alert('Error deleting page: ' + e.message);
          }
        }

        // Login button click handler
        loginBtn.addEventListener('click', () => {
          log('[login] Opening OAuth popup...');
          const popup = window.open(
            'https://decap-oauth.netlify.app/oauth/authorize?site_id=omarosullivan.netlify.app',
            'github-oauth',
            'width=600,height=600,scrollbars=yes,resizable=yes'
          );
        });



        // Function to set up button event listeners
        function setupButtonListeners() {
          console.log('Setting up button listeners...');
          
          // Add portfolio button handler
          const addPortfolioBtn = document.getElementById('add-portfolio');
          console.log('Add Portfolio button found:', !!addPortfolioBtn);
          if (addPortfolioBtn) {
            addPortfolioBtn.addEventListener('click', () => {
              console.log('Add Portfolio button clicked');
              showAddPortfolioForm();
            });
          } else {
            console.error('Add Portfolio button not found');
          }

          // Bulk upload portfolio button handler
          const bulkUploadPortfolioBtn = document.getElementById('bulk-upload-portfolio');
          console.log('Bulk Upload Portfolio button found:', !!bulkUploadPortfolioBtn);
          if (bulkUploadPortfolioBtn) {
            bulkUploadPortfolioBtn.addEventListener('click', () => {
              console.log('Bulk Upload Portfolio button clicked');
              showBulkUploadModal('portfolio');
            });
          } else {
            console.error('Bulk Upload Portfolio button not found');
          }

          // Edit about button handler
          const editAboutBtn = document.getElementById('edit-about');
          console.log('Edit About button found:', !!editAboutBtn);
          if (editAboutBtn) {
            editAboutBtn.addEventListener('click', () => {
              console.log('Edit About button clicked');
              editPage('about');
            });
          } else {
            console.log('Edit About button not found (this is normal if page doesn\'t exist)');
          }

          // Edit contact button handler
          const editContactBtn = document.getElementById('edit-contact');
          console.log('Edit Contact button found:', !!editContactBtn);
          if (editContactBtn) {
            editContactBtn.addEventListener('click', () => {
              console.log('Edit Contact button clicked');
              editPage('contact');
            });
          } else {
            console.log('Edit Contact button not found (this is normal if page doesn\'t exist)');
          }
          
          // Main navigation button handler
          const editMainNavBtn = document.getElementById('edit-main-nav');
          console.log('Edit Main Navigation button found:', !!editMainNavBtn);
          if (editMainNavBtn) {
            editMainNavBtn.addEventListener('click', () => {
              console.log('Edit Main Navigation button clicked');
              editMainNavigation();
            });
          } else {
            console.error('Edit Main Navigation button not found');
          }
          
          // Site settings button handler
          const editSiteSettingsBtn = document.getElementById('edit-site-settings');
          console.log('Edit Site Settings button found:', !!editSiteSettingsBtn);
          if (editSiteSettingsBtn) {
            editSiteSettingsBtn.addEventListener('click', () => {
              console.log('Edit Site Settings button clicked');
              editSiteSettings();
            });
          } else {
            console.error('Edit Site Settings button not found');
          }


          // Add page button handler
          const addPageBtn = document.getElementById('add-page');
          console.log('Add Page button found:', !!addPageBtn);
          if (addPageBtn) {
            addPageBtn.addEventListener('click', () => {
              console.log('Add Page button clicked');
              showAddPageForm();
            });
          } else {
            console.error('Add Page button not found');
          }

          // Add poetry button handler
          const addPoetryBtn = document.getElementById('add-poetry');
          console.log('Add Poetry button found:', !!addPoetryBtn);
          if (addPoetryBtn) {
            addPoetryBtn.addEventListener('click', () => {
              console.log('Add Poetry button clicked');
              showAddPoetryForm();
            });
          } else {
            console.error('Add Poetry button not found');
          }

          // Bulk upload poetry button handler
          const bulkUploadPoetryBtn = document.getElementById('bulk-upload-poetry');
          console.log('Bulk Upload Poetry button found:', !!bulkUploadPoetryBtn);
          if (bulkUploadPoetryBtn) {
            bulkUploadPoetryBtn.addEventListener('click', () => {
              console.log('Bulk Upload Poetry button clicked');
              showBulkUploadModal('poetry');
            });
          } else {
            console.error('Bulk Upload Poetry button not found');
          }

          // Add photography button handler
          const addPhotographyBtn = document.getElementById('add-photography');
          console.log('Add Photography button found:', !!addPhotographyBtn);
          if (addPhotographyBtn) {
            addPhotographyBtn.addEventListener('click', () => {
              console.log('Add Photography button clicked');
              showAddPhotographyForm();
            });
          } else {
            console.error('Add Photography button not found');
          }

          // Bulk upload photography button handler
          const bulkUploadPhotographyBtn = document.getElementById('bulk-upload-photography');
          console.log('Bulk Upload Photography button found:', !!bulkUploadPhotographyBtn);
          if (bulkUploadPhotographyBtn) {
            bulkUploadPhotographyBtn.addEventListener('click', () => {
              console.log('Bulk Upload Photography button clicked');
              showBulkUploadModal('photography');
            });
          } else {
            console.error('Bulk Upload Photography button not found');
          }

          // Add videography button handler
          const addVideographyBtn = document.getElementById('add-videography');
          console.log('Add Videography button found:', !!addVideographyBtn);
          if (addVideographyBtn) {
            addVideographyBtn.addEventListener('click', () => {
              console.log('Add Videography button clicked');
              showAddVideographyForm();
            });
          } else {
            console.error('Add Videography button not found');
          }

          // Bulk upload videography button handler
          const bulkUploadVideographyBtn = document.getElementById('bulk-upload-videography');
          console.log('Bulk Upload Videography button found:', !!bulkUploadVideographyBtn);
          if (bulkUploadVideographyBtn) {
            bulkUploadVideographyBtn.addEventListener('click', () => {
              console.log('Bulk Upload Videography button clicked');
              showBulkUploadModal('videography');
            });
          } else {
            console.error('Bulk Upload Videography button not found');
          }
          
          console.log('Button listeners setup complete');
        }



        // Main Navigation Functions
        async function editMainNavigation() {
          try {
            console.log('editMainNavigation function called');
            
            // Close any existing modals first
            const existingModals = document.querySelectorAll('[id$="-modal"]');
            existingModals.forEach(modal => {
              console.log('Removing existing modal:', modal.id);
              modal.remove();
            });
            
            // Small delay to ensure DOM is updated
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Get the current config.toml file
            const response = await fetch('https://api.github.com/repos/oos/omarosullivan.com/contents/config.toml', {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            if (!response.ok) {
              console.error('Error loading config.toml:', response.status, response.statusText);
              alert('Error loading navigation configuration');
              return;
            }

            console.log('Config.toml loaded successfully');
            const file = await response.json();
            const content = decodeURIComponent(escape(atob(file.content)));
            console.log('Config content length:', content.length);
            
            // Parse the current navigation items
            const navItems = [];
            const navRegex = /\[\[menu\.main\]\]\s*\n\s*name\s*=\s*"([^"]+)"\s*\n\s*url\s*=\s*"([^"]+)"\s*\n\s*weight\s*=\s*(\d+)/g;
            let match;
            while ((match = navRegex.exec(content)) !== null) {
              navItems.push({
                name: match[1],
                url: match[2],
                weight: parseInt(match[3])
              });
            }

            // Sort by weight
            navItems.sort((a, b) => a.weight - b.weight);

            // Create edit form
            const form = document.createElement('div');
            form.id = 'edit-main-nav-modal';
            form.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;';

            let navItemsHtml = '';
            navItems.forEach((item, index) => {
              navItemsHtml += `
                <div style="border:1px solid #ddd;padding:15px;margin:10px 0;border-radius:5px;background:#f9f9f9;">
                  <h4 style="margin:0 0 10px 0;">Navigation Item ${index + 1}</h4>
                  <div style="display:grid;grid-template-columns:1fr 1fr 80px;gap:10px;align-items:end;">
                    <div>
                      <label style="display:block;margin-bottom:5px;font-weight:bold;">Name:</label>
                      <input type="text" value="${item.name}" data-field="name" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                    </div>
                    <div>
                      <label style="display:block;margin-bottom:5px;font-weight:bold;">URL:</label>
                      <input type="text" value="${item.url}" data-field="url" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                    </div>
                    <div>
                      <label style="display:block;margin-bottom:5px;font-weight:bold;">Weight:</label>
                      <input type="number" value="${item.weight}" data-field="weight" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                    </div>
                  </div>
                  <button type="button" onclick="removeNavItem(this)" style="background:#dc3545;color:white;border:none;padding:5px 10px;border-radius:3px;cursor:pointer;margin-top:10px;">Remove</button>
                </div>
              `;
            });

            form.innerHTML = `
              <div style="background:white;padding:20px;border-radius:8px;width:90%;max-width:800px;max-height:90%;overflow-y:auto;position:relative;">
                <button onclick="document.getElementById('edit-main-nav-modal').remove()" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;">&times;</button>
                <h3>Edit Main Navigation</h3>
                <div id="nav-items-container">
                  ${navItemsHtml}
                </div>
                <button type="button" onclick="addNavItem()" style="background:#28a745;color:white;border:none;padding:10px 20px;border-radius:3px;cursor:pointer;margin:10px 0;">Add New Navigation Item</button>
                <div style="text-align:right;margin-top:20px;">
                  <button type="button" onclick="document.getElementById('edit-main-nav-modal').remove()" style="background:#6c757d;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;margin-right:10px;">Cancel</button>
                  <button type="button" onclick="console.log('Save Navigation clicked'); saveMainNavigation('${file.sha}')" style="background:#007cba;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;">Save Navigation</button>
                </div>
              </div>
            `;
            document.body.appendChild(form);

          } catch (e) {
            alert('Error loading navigation configuration: ' + e.message);
          }
        }

        function addNavItem() {
          const container = document.getElementById('nav-items-container');
          const newIndex = container.children.length;
          
          const newItem = document.createElement('div');
          newItem.style.cssText = 'border:1px solid #ddd;padding:15px;margin:10px 0;border-radius:5px;background:#f9f9f9;';
          newItem.innerHTML = `
            <h4 style="margin:0 0 10px 0;">Navigation Item ${newIndex + 1}</h4>
            <div style="display:grid;grid-template-columns:1fr 1fr 80px;gap:10px;align-items:end;">
              <div>
                <label style="display:block;margin-bottom:5px;font-weight:bold;">Name:</label>
                <input type="text" value="New Item" data-field="name" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
              </div>
              <div>
                <label style="display:block;margin-bottom:5px;font-weight:bold;">URL:</label>
                <input type="text" value="/new-page/" data-field="url" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
              </div>
              <div>
                <label style="display:block;margin-bottom:5px;font-weight:bold;">Weight:</label>
                <input type="number" value="${newIndex * 10}" data-field="weight" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
              </div>
            </div>
            <button type="button" onclick="removeNavItem(this)" style="background:#dc3545;color:white;border:none;padding:5px 10px;border-radius:3px;cursor:pointer;margin-top:10px;">Remove</button>
          `;
          container.appendChild(newItem);
        }

        function removeNavItem(button) {
          if (confirm('Are you sure you want to remove this navigation item?')) {
            button.parentElement.remove();
          }
        }

        async function saveMainNavigation(sha) {
          try {
            console.log('saveMainNavigation called with sha:', sha);
            const container = document.getElementById('nav-items-container');
            const navItems = [];
            
            console.log('Container children count:', container.children.length);
            
            // Collect all navigation items
            for (let i = 0; i < container.children.length; i++) {
              const item = container.children[i];
              const name = item.querySelector('[data-field="name"]').value;
              const url = item.querySelector('[data-field="url"]').value;
              const weight = parseInt(item.querySelector('[data-field="weight"]').value);
              
              console.log('Item', i, ':', { name, url, weight });
              
              if (name && url) {
                navItems.push({ name, url, weight });
              }
            }
            
            console.log('Collected nav items:', navItems);
            
            // Sort by weight
            navItems.sort((a, b) => a.weight - b.weight);
            
            // Get the current config.toml content
            const response = await fetch('https://api.github.com/repos/oos/omarosullivan.com/contents/config.toml', {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });
            
            const file = await response.json();
            let content = decodeURIComponent(escape(atob(file.content)));
            
            // Remove existing menu.main sections
            content = content.replace(/\[\[menu\.main\]\]\s*\n\s*name\s*=\s*"[^"]+"\s*\n\s*url\s*=\s*"[^"]+"\s*\n\s*weight\s*=\s*\d+\s*\n/g, '');
            
            // Add new menu.main sections
            let newMenuItems = '';
            navItems.forEach(item => {
              newMenuItems += `[[menu.main]]
  name = "${item.name}"
  url = "${item.url}"
  weight = ${item.weight}

`;
            });
            
            // Insert new menu items after the [params] section
            const paramsEndMatch = content.match(/(\[params\]\s*\n[\s\S]*?)(?=\n\[|$)/);
            if (paramsEndMatch) {
              content = content.replace(paramsEndMatch[1], paramsEndMatch[1] + '\n' + newMenuItems);
            } else {
              // If no [params] section, add at the beginning
              content = newMenuItems + content;
            }
            
            // Save the updated config
            console.log('Saving config with content length:', content.length);
            const saveResponse = await fetch('https://api.github.com/repos/oos/omarosullivan.com/contents/config.toml', {
              method: 'PUT',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: 'Update main navigation menu',
                content: btoa(unescape(encodeURIComponent(content))),
                sha: sha
              })
            });
            
            console.log('Save response status:', saveResponse.status);
            
            if (saveResponse.ok) {
              console.log('Navigation updated successfully!');
              alert('Navigation updated successfully!');
              document.getElementById('edit-main-nav-modal').remove();
            } else {
              const error = await saveResponse.json();
              console.error('Error updating navigation:', error);
              alert('Error updating navigation: ' + (error.message || 'Unknown error'));
            }
            
          } catch (e) {
            alert('Error saving navigation: ' + e.message);
          }
        }

        // Photography Management Functions
        function showAddPhotographyForm() {
          console.log('showAddPhotographyForm function called');
          
          // Remove any existing modal first
          const existingModal = document.getElementById('add-photography-modal');
          if (existingModal) {
            existingModal.remove();
          }

          const form = document.createElement('div');
          form.id = 'add-photography-modal';
          form.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;';

          form.innerHTML = `
            <div style="background:white;padding:20px;border-radius:8px;width:80%;max-width:600px;max-height:80%;overflow-y:auto;position:relative;">
              <button onclick="document.getElementById('add-photography-modal').remove()" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;">&times;</button>
              <h3>Add New Photo</h3>
              <form id="add-photography-form">
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Title:</label>
                  <input type="text" id="photography-title" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Description:</label>
                  <input type="text" id="photography-description" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Tags (comma-separated):</label>
                  <input type="text" id="photography-tags" placeholder="e.g., street, portrait, landscape" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Photo:</label>
                  <input type="file" id="photography-image" accept="image/*" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Content (Markdown):</label>
                  <textarea id="photography-content" rows="6" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;" placeholder="Describe the photo, context, or any additional information..."></textarea>
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:flex;align-items:center;gap:8px;font-weight:bold;">
                    <input type="checkbox" id="photography-featured" style="margin:0;">
                    Featured on Homepage
                  </label>
                </div>
                <div style="text-align:right;">
                  <button type="button" onclick="document.getElementById('add-photography-modal').remove()" style="background:#6c757d;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;margin-right:10px;">Cancel</button>
                  <button type="submit" style="background:#6f42c1;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;">Add Photo</button>
                </div>
              </form>
            </div>
          `;
          document.body.appendChild(form);

          // Handle form submission
          document.getElementById('add-photography-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
              const title = document.getElementById('photography-title').value;
              const description = document.getElementById('photography-description').value;
              const tags = document.getElementById('photography-tags').value;
              const content = document.getElementById('photography-content').value;
              const featured = document.getElementById('photography-featured').checked;
              const imageFile = document.getElementById('photography-image').files[0];

              if (!imageFile) {
                alert('Please select a photo');
                return;
              }

              // Upload image first
              let imagePath;
              try {
                imagePath = await uploadImage(imageFile);
              } catch (error) {
                alert(error.message);
                return;
              }
              
              // Create photography item
              await createPhotographyItem(title, description, tags, content, imagePath, featured);

              form.remove();
              loadPhotographyItems(currentToken);
            } catch (error) {
              alert('Error adding photo: ' + error.message);
            }
          });
        }

        async function createPhotographyItem(title, description, tags, content, imagePath, featured = false, order = null) {
          try {
            const slug = title.toLowerCase().replace(/[^a-z0-9\s]+/g, '').replace(/\s+/g, '-').replace(/^-|-$/g, '');
            const filename = slug + '.md';
            const date = new Date().toISOString().split('T')[0];
            
            // Build frontmatter
            let frontmatter = `---
title: "${title}"
date: ${date}
description: "${description}"`;

            if (tags) {
              const tagsArray = tags.split(',').map(tag => tag.trim()).filter(tag => tag);
              if (tagsArray.length > 0) {
                frontmatter += `\ntags: [${tagsArray.map(tag => `"${tag}"`).join(', ')}]`;
              }
            }

            if (imagePath) {
              frontmatter += `\ncover:\n  image: "${imagePath}"`;
            }

            if (featured) {
              frontmatter += `\nfeatured: true`;
            }

            // Add order field
            if (order !== null) {
              frontmatter += `\norder: ${order}`;
            }

            frontmatter += `\n---\n\n`;

            const markdownContent = frontmatter + content;

            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/photography/${filename}`, {
              method: 'PUT',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Add photography post: ${title}`,
                content: btoa(unescape(encodeURIComponent(markdownContent)))
              })
            });

            if (response.ok) {
              alert('Photo added successfully!');
            } else {
              const error = await response.json();
              alert('Error adding photo: ' + (error.message || 'Unknown error'));
            }
          } catch (e) {
            alert('Error adding photo: ' + e.message);
          }
        }

        async function loadPhotographyItems(token) {
          if (window.isLoadingPhotography) {
            console.log('[api] Already loading photography items, skipping...');
            return;
          }
          
          window.isLoadingPhotography = true;
          console.log('[debug] Starting to load photography items...');
          try {
            
            const response = await fetch('https://api.github.com/repos/oos/omarosullivan.com/contents/content/photography', {
              headers: {
                'Authorization': 'token ' + token,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            if (response.ok) {
              const items = await response.json();
              console.log('[api] Loaded photography items');
              console.log('[debug] Photography items loaded:', items);
              
                          const photographyList = document.getElementById('photography-list');
            if (photographyList) {
              // Clear existing content to prevent duplicates
              photographyList.innerHTML = '';
              console.log('[debug] Cleared photography list');
                
                const photographyItems = items.filter(item => item.name.endsWith('.md'));
                console.log('[debug] Filtered photography items:', photographyItems);
                
                // Show loading indicator
                photographyList.innerHTML = '<div style="text-align:center;padding:20px;color:#666;">Loading photography...</div>';
                
                // Load all items first to get their metadata for sorting
                const itemsWithMetadata = [];
                
                // Handle section pages first
                for (const item of photographyItems) {
                  if (item.name === '_index.md') {
                    itemsWithMetadata.push({
                      ...item,
                      displayTitle: item.name + ' (Photography Section Page)',
                      date: '1900-01-01',
                      content: '',
                      isSectionPage: true
                    });
                  }
                }
                
                // Load all file contents in parallel
                const filePromises = photographyItems
                  .filter(item => item.name !== '_index.md')
                  .map(async (item) => {
                    try {
                      const fileResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/photography/${item.name}`, {
                        headers: {
                          'Authorization': 'token ' + token,
                          'Accept': 'application/vnd.github.v3+json'
                        }
                      });
                        
                      if (fileResponse.ok) {
                        const fileData = await fileResponse.json();
                        const content = decodeURIComponent(escape(atob(fileData.content)));
                        const titleMatch = content.match(/title:\s*["']([^"\n]+)["']/);
                        const dateMatch = content.match(/date:\s*(\d{4}-\d{2}-\d{2})/);
                        const displayTitle = titleMatch ? titleMatch[1].trim() : item.name.replace('.md', '');
                        const date = dateMatch ? dateMatch[1] : '1900-01-01';
                        
                        // Check if this item is featured
                        const featuredMatch = content.match(/featured:\s*(true|false)/i);
                        const isFeatured = featuredMatch ? featuredMatch[1].toLowerCase() === 'true' : false;
                        
                        // Check for featured_date field
                        const featuredDateMatch = content.match(/featured_date:\s*([^\n]+)/);
                        const featuredDate = featuredDateMatch ? featuredDateMatch[1].trim() : null;
                        
                        // Check for order field - make regex more flexible
                        const orderMatch = content.match(/order:\s*(\d+)/m);
                        const order = orderMatch ? parseInt(orderMatch[1]) : 999;
                        console.log(`[debug] Order parsing for ${item.name}:`, { orderMatch, order, content: content.substring(0, 200) });
                        
                        return {
                          ...item,
                          displayTitle,
                          date,
                          content,
                          isFeatured,
                          featuredDate,
                          order,
                          isSectionPage: false
                        };
                      }
                    } catch (error) {
                      console.error('Error loading photography item:', error);
                    }
                    
                    return {
                      ...item,
                      displayTitle: item.name.replace('.md', ''),
                      date: '1900-01-01',
                      content: '',
                      isFeatured: false,
                      featuredDate: null,
                      order: 999,
                      isSectionPage: false
                    };
                  });
                
                // Wait for all file contents to load
                const fileResults = await Promise.all(filePromises);
                
                // Add all results to itemsWithMetadata
                itemsWithMetadata.push(...fileResults);
                
                // Sort items: section pages first, then by order field, then by date, then by title
                itemsWithMetadata.sort((a, b) => {
                  if (a.isSectionPage && !b.isSectionPage) return -1;
                  if (!a.isSectionPage && b.isSectionPage) return 1;
                  
                  // Sort by order field first (lower numbers first)
                  if (a.order !== b.order) {
                    return a.order - b.order;
                  }
                  
                  // If order is the same, sort by date (newest first)
                  if (a.date !== b.date) {
                    return b.date.localeCompare(a.date);
                  }
                  
                  // Finally sort by title alphabetically
                  return a.displayTitle.localeCompare(b.displayTitle);
                });
                
                // Clear the loading indicator before populating content
                photographyList.innerHTML = '';
                
                // Display items in the correct order
                for (const item of itemsWithMetadata) {
                  const div = document.createElement('div');
                  div.style.cssText = 'border:1px solid #ddd;padding:10px;margin:5px;border-radius:3px;';
                  
                  // Handle _index.md files differently (these are section pages, not individual photos)
                  if (item.isSectionPage) {
                    div.innerHTML = `
                      <strong>${item.name} (Photography Section Page)</strong>
                      <button onclick="editPage('photography')" style="float:right;background:#007cba;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;margin-left:5px;">Edit Section</button>
                    `;
                    photographyList.appendChild(div);
                  } else {
                    // Use pre-loaded metadata
                    const content = item.content;
                    const displayTitle = item.displayTitle;
                    const isFeatured = item.isFeatured;
                    const featuredDate = item.featuredDate;
                    const currentOrder = item.order !== undefined ? item.order : 999;
                    console.log(`[debug] Display order for ${item.name}:`, { order: item.order, currentOrder });
                    
                    // Format featured date for display
                    let featuredDateDisplay = '';
                    if (featuredDate) {
                      const date = new Date(featuredDate);
                      featuredDateDisplay = ` (${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'})})`;
                    }
                    
                    div.innerHTML = `
                      <div style="display:flex;align-items:center;justify-content:space-between;">
                        <div style="display:flex;align-items:center;gap:8px;flex:1;">
                          <label style="display:flex;align-items:center;gap:8px;">
                            <input type="checkbox" ${isFeatured ? 'checked' : ''} onchange="togglePhotographyFeatured('${item.name}', '${item.sha}', this.checked)" style="margin:0;">
                            <strong>${displayTitle}</strong>
                            ${isFeatured ? '<span style="background:#28a745;color:white;padding:2px 6px;border-radius:3px;font-size:11px;margin-left:8px;">Featured on Homepage' + featuredDateDisplay + '</span>' : ''}
                          </label>
                          <div style="display:flex;gap:5px;margin-left:10px;">
                            <button onclick="editPhotographyItem('${item.name}', '${item.sha}')" style="background:#007cba;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;">Edit</button>
                            <button onclick="deletePhotographyItem('${item.name}', '${item.sha}')" style="background:#dc3545;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;">Delete</button>
                          </div>
                          <div style="display:flex;align-items:center;gap:5px;margin-left:20px;">
                            <label style="font-size:12px;color:#666;">Order:</label>
                            <div style="display:inline-flex;align-items:center;gap:5px;">
                              <input type="number" value="${currentOrder}" min="1" max="999" onchange="updatePhotographyOrder('${item.name}', '${item.sha}', this.value)" oninput="showSaveIcon(this)" style="width:60px;padding:2px 4px;border:1px solid #ccc;border-radius:3px;font-size:12px;">
                              <span class="save-icon" style="display:none;color:#28a745;cursor:pointer;font-size:16px;font-weight:bold;" onclick="updatePhotographyOrder('${item.name}', '${item.sha}', this.previousElementSibling.value)">✓</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    `;
                  }
                  photographyList.appendChild(div);
                  console.log('[debug] Added photography item to list:', item.name);
                }
                
                return items;
              }
            } else if (response.status === 401) {
              log('[api] Token expired or invalid (401). Clearing tokens and requiring re-authentication.', 'error');
              console.log('[api] Photography: Clearing invalid tokens...');
              clearInvalidTokens();
            } else {
              log(`[api] Failed to load photography items: ${response.status}`, 'error');
              const photographyList = document.getElementById('photography-list');
              if (photographyList) {
                photographyList.innerHTML = '<div style="text-align:center;padding:20px;color:#666;">Error loading photography. Please refresh the page.</div>';
              }
            }
          } catch (e) {
            log(`[api] Error loading photography items: ${e.message}`, 'error');
            console.error('[api] Photography loading error:', e);
            const photographyList = document.getElementById('photography-list');
            if (photographyList) {
              photographyList.innerHTML = '<div style="text-align:center;padding:20px;color:#666;">Error loading photography. Please refresh the page.</div>';
            }
          } finally {
            window.isLoadingPhotography = false;
          }
        }

        async function editPhotographyItem(filename, sha) {
          try {
            console.log('editPhotographyItem called with filename:', filename, 'sha:', sha);
            // First, get the current content
            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/photography/${filename}`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            if (!response.ok) {
              alert('Error loading photography item');
              return;
            }

            const file = await response.json();
            const content = decodeURIComponent(escape(atob(file.content)));
            
            // Parse frontmatter
            const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);
            let title = filename.replace('.md', '');
            let description = '';
            let tags = '';
            let contentText = '';

            if (frontmatterMatch) {
              const frontmatter = frontmatterMatch[1];
              const titleMatch = frontmatter.match(/title:\s*["']?([^"'\n]+)["']?/);
              const descMatch = frontmatter.match(/description:\s*["']?([^"'\n]*)["']?/);
              const tagsMatch = frontmatter.match(/tags:\s*\[([^\]]*)\]/);
              const featuredMatch = frontmatter.match(/featured:\s*(true|false)/);
              
              if (titleMatch) title = titleMatch[1].trim();
              if (descMatch) description = descMatch[1].trim();
              if (tagsMatch) tags = tagsMatch[1].trim();
              if (featuredMatch) featured = featuredMatch[1] === 'true';
              contentText = frontmatterMatch[2];
            } else {
              contentText = content;
            }

            // Create edit form
            const form = document.createElement('div');
            form.id = 'edit-photography-modal';
            form.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;';

            form.innerHTML = `
              <div style="background:white;padding:20px;border-radius:8px;width:80%;max-width:600px;max-height:80%;overflow-y:auto;position:relative;">
                <button onclick="document.getElementById('edit-photography-modal').remove()" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;">&times;</button>
                <h3>Edit Photo</h3>
                <form id="edit-photography-form">
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Title:</label>
                    <input type="text" id="edit-photography-title" value="${title}" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Description:</label>
                    <input type="text" id="edit-photography-description" value="${description}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Tags (comma-separated):</label>
                    <input type="text" id="edit-photography-tags" value="${tags}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">New Photo (optional):</label>
                    <input type="file" id="edit-photography-image" accept="image/*" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Content (Markdown):</label>
                    <textarea id="edit-photography-content" rows="6" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">${contentText}</textarea>
                  </div>
                  <div style="text-align:right;">
                    <button type="button" onclick="document.getElementById('edit-photography-modal').remove()" style="background:#6c757d;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;margin-right:10px;">Cancel</button>
                    <button type="submit" style="background:#6f42c1;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;">Save</button>
                  </div>
                </form>
              </div>
            `;
            document.body.appendChild(form);

            // Handle form submission
            document.getElementById('edit-photography-form').addEventListener('submit', async (e) => {
              e.preventDefault();
              try {
                const newTitle = document.getElementById('edit-photography-title').value;
                const newDescription = document.getElementById('edit-photography-description').value;
                const newTags = document.getElementById('edit-photography-tags').value;
                const newContent = document.getElementById('edit-photography-content').value;
                const imageFile = document.getElementById('edit-photography-image').files[0];

                let imagePath = null;
                if (imageFile) {
                  try {
                    imagePath = await uploadImage(imageFile);
                  } catch (error) {
                    alert(error.message);
                    return;
                  }
                }
                
                await updatePhotographyItem(filename, sha, newTitle, newDescription, newTags, newContent, imagePath);

                form.remove();
                loadPhotographyItems(currentToken);
              } catch (error) {
                alert('Error updating photo: ' + error.message);
              }
            });
          } catch (e) {
            alert('Error loading photography item: ' + e.message);
          }
        }

        async function updatePhotographyItem(filename, sha, title, description, tags, content, imageFile) {
          try {
            console.log('updatePhotographyItem called with filename:', filename, 'sha:', sha);
            const date = new Date().toISOString().split('T')[0];
            
            // First, get the current content to preserve existing image
            const currentResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/photography/${filename}`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            let existingImagePath = null;
            let existingOrder = '';
            if (currentResponse.ok) {
              const currentFile = await currentResponse.json();
              const currentContent = decodeURIComponent(escape(atob(currentFile.content)));
              const frontmatterMatch = currentContent.match(/^---\n([\s\S]*?)\n---/);
              if (frontmatterMatch) {
                const coverMatch = frontmatterMatch[1].match(/cover:\s*image:\s*["']([^"\n]+)["']/);
                if (coverMatch) {
                  existingImagePath = coverMatch[1].trim();
                }
                const orderMatch = frontmatterMatch[1].match(/order:\s*(\d+)/);
                if (orderMatch) {
                  existingOrder = `order: ${orderMatch[1]}`;
                }
              }
            }

            // Use new image if provided, otherwise keep existing
            let imagePath = existingImagePath;
            if (imageFile) {
              try {
                imagePath = await uploadImage(imageFile);
              } catch (error) {
                alert(error.message);
                return;
              }
            }
            
            // Build frontmatter
            let frontmatter = `---
title: "${title}"
date: ${date}
description: "${description}"`;

            if (existingOrder) {
              frontmatter += `\n${existingOrder}`;
            }

            if (tags) {
              const tagsArray = tags.split(',').map(tag => tag.trim()).filter(tag => tag);
              if (tagsArray.length > 0) {
                frontmatter += `\ntags: [${tagsArray.map(tag => `"${tag}"`).join(', ')}]`;
              }
            }

            if (imagePath) {
              frontmatter += `\ncover:\n  image: "${imagePath}"`;
            }

            frontmatter += `\n---\n\n`;

            const markdownContent = frontmatter + content;

            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/photography/${filename}`, {
              method: 'PUT',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Update photography post: ${title}`,
                content: btoa(unescape(encodeURIComponent(markdownContent))),
                sha: sha
              })
            });

            if (response.ok) {
              alert('Photo updated successfully!');
              await loadPhotographyItems(currentToken);
            } else {
              const error = await response.json();
              alert('Error updating photo: ' + (error.message || 'Unknown error'));
            }
          } catch (e) {
            alert('Error updating photo: ' + e.message);
          }
        }

        async function deletePhotographyItem(filename, sha) {
          try {
            if (!confirm(`Are you sure you want to delete the photo "${filename}"? This action cannot be undone.`)) {
              return;
            }

            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/photography/${filename}`, {
              method: 'DELETE',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Delete photography post: ${filename}`,
                sha: sha
              })
            });

            if (response.ok) {
              alert('Photo deleted successfully!');
              console.log('Photo deleted, reloading photography items...');
              try {
                await loadPhotographyItems(currentToken);
                console.log('Photography items reloaded successfully');
              } catch (error) {
                console.error('Error reloading photography items:', error);
                alert('Photo deleted but failed to refresh the list. Please refresh the page.');
              }
            } else {
              const error = await response.json();
              alert('Error deleting photo: ' + (error.message || 'Unknown error'));
            }
          } catch (e) {
            alert('Error deleting photo: ' + e.message);
          }
        }

        // Site Settings Functions
        async function editSiteSettings() {
          console.log('editSiteSettings function called');
          try {
            console.log('Loading config.toml...');
            // First, get the current config.toml content
            const response = await fetch('https://api.github.com/repos/oos/omarosullivan.com/contents/config.toml', {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            if (!response.ok) {
              alert('Error loading site settings');
              return;
            }

            const file = await response.json();
            const content = decodeURIComponent(escape(atob(file.content)));
            
            // Parse current title from config.toml
            const titleMatch = content.match(/title\s*=\s*["']([^"']+)["']/);
            const descMatch = content.match(/description\s*=\s*["']([^"']+)["']/);
            
            const currentTitle = titleMatch ? titleMatch[1] : 'Omar O\'Sullivan — Portfolio';
            const currentDescription = descMatch ? descMatch[1] : 'Work, notes, and experiments.';

            // Remove any existing modal first
            const existingModal = document.getElementById('edit-site-settings-modal');
            if (existingModal) {
              existingModal.remove();
            }
            
            // Show edit form
            const form = document.createElement('div');
            form.id = 'edit-site-settings-modal';
            form.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;';
            form.innerHTML = `
              <div style="background:white;padding:20px;border-radius:8px;width:80%;max-width:600px;max-height:80%;overflow-y:auto;position:relative;">
                <button onclick="document.getElementById('edit-site-settings-modal').remove()" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;">&times;</button>
                <h3>Edit Site Settings</h3>
                <form id="edit-site-settings-form">
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Site Title:</label>
                    <input type="text" id="site-title" value="${currentTitle}" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                    <small style="color:#666;">This appears in the browser tab and as the main site title</small>
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Site Description:</label>
                    <textarea id="site-description" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;height:80px;">${currentDescription}</textarea>
                    <small style="color:#666;">This appears in search results and social media previews</small>
                  </div>
                  <div style="text-align:right;">
                    <button type="button" onclick="document.getElementById('edit-site-settings-modal').remove()" style="background:#6c757d;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;margin-right:10px;">Cancel</button>
                    <button type="submit" style="background:#28a745;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">Save Settings</button>
                  </div>
                </form>
              </div>
            `;
            document.body.appendChild(form);
            
            document.getElementById('edit-site-settings-form').addEventListener('submit', async (e) => {
              e.preventDefault();
              const newTitle = document.getElementById('site-title').value;
              const newDescription = document.getElementById('site-description').value;
              
              console.log('Updating site settings:', { newTitle, newDescription, sha: file.sha });
              
              try {
                await updateSiteSettings(file.sha, newTitle, newDescription, content);
                form.remove();
              } catch (error) {
                console.error('Error updating site settings:', error);
                alert('Error updating site settings: ' + error.message);
              }
            });
          } catch (e) {
            alert('Error loading site settings: ' + e.message);
          }
        }

        async function updateSiteSettings(sha, title, description, content) {
          try {
            console.log('updateSiteSettings called with:', { sha, title, description, currentToken: currentToken ? 'exists' : 'missing' });
            console.log('Original content preview:', content.substring(0, 200) + '...');
            
            // Update title and description in the content
            let updatedContent = content.replace(/title\s*=\s*["'][^"']*["']/, `title = "${title}"`);
            updatedContent = updatedContent.replace(/description\s*=\s*["'][^"']*["']/, `description = "${description}"`);

            console.log('Updated content preview:', updatedContent.substring(0, 200) + '...');
            console.log('Content changed:', content !== updatedContent);

            // Update the file
            const updateResponse = await fetch('https://api.github.com/repos/oos/omarosullivan.com/contents/config.toml', {
              method: 'PUT',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Update site settings: ${title}`,
                content: btoa(unescape(encodeURIComponent(updatedContent))),
                sha: sha
              })
            });

            console.log('Update response status:', updateResponse.status);

            if (updateResponse.ok) {
              const result = await updateResponse.json();
              console.log('Update successful:', result);
              alert('Site settings updated successfully! The changes will be visible after the next site build.');
            } else {
              const error = await updateResponse.json();
              console.error('GitHub API error:', error);
              console.error('Full error response:', error);
              alert('Error updating site settings: ' + (error.message || 'Unknown error') + '\n\nCheck console for details.');
            }
          } catch (e) {
            console.error('Exception in updateSiteSettings:', e);
            alert('Error updating site settings: ' + e.message);
          }
        }

        // Try to authenticate on page load - check immediately and with retry
        function initializeAuth() {
          log('[boot] Initializing authentication...');
          debugStorage();
          
          // Check for existing token immediately
          const existingToken = extractTokenFromStorage();
          if (existingToken) {
            log('[boot] Found existing token, testing authentication...');
            testGitHubAPI(existingToken).then(user => {
              if (user) {
                currentToken = existingToken;
                isAuthenticated = true;
                log('[boot] Authentication successful! Welcome ' + user.login, 'token');
                
                // Hide login section and show CMS interface
                loginSection.style.display = 'none';
                cmsInterface.style.display = 'block';
                
                // Set up button event listeners now that CMS interface is visible
                console.log('About to call setupButtonListeners from init...');
                setupButtonListeners();
                console.log('setupButtonListeners called from init');
                
                // Load all content types
                loadPoetryItems(currentToken);
                loadPortfolioItems(currentToken);
                loadVideographyItems(currentToken);
                loadPhotographyItems(currentToken);
                loadPages(currentToken);
              } else {
                log('[boot] Existing token invalid, clearing storage...');
                clearInvalidTokens();
              }
            }).catch(err => {
              log('[boot] Error testing token: ' + err.message, 'error');
              clearInvalidTokens();
            });
          } else {
            log('[boot] No existing token found');
          }
        }
        
        // Toggle functions for featured checkboxes
        window.togglePortfolioFeatured = async function(filename, sha, isFeatured) {
          try {
            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/portfolio/${filename}`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });
            
            if (response.ok) {
              const fileData = await response.json();
              const content = decodeURIComponent(escape(atob(fileData.content)));
              
              // Update the featured field in frontmatter
              let updatedContent = content;
              const featuredDate = new Date().toISOString();
              
              if (content.includes('featured:')) {
                updatedContent = content.replace(/featured:\s*(true|false)/, `featured: ${isFeatured}`);
              } else {
                // Add featured field after title
                updatedContent = content.replace(/(title:\s*[^\n]+)/, `$1\nfeatured: ${isFeatured}`);
              }
              
              // Add or update featured_date
              if (isFeatured) {
                if (content.includes('featured_date:')) {
                  updatedContent = updatedContent.replace(/featured_date:\s*[^\n]+/, `featured_date: ${featuredDate}`);
                } else {
                  updatedContent = updatedContent.replace(/(featured:\s*(true|false))/, `$1\nfeatured_date: ${featuredDate}`);
                }
              } else {
                // Remove featured_date when unfeaturing
                updatedContent = updatedContent.replace(/featured_date:\s*[^\n]+\n?/, '');
              }
              
              const updateResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/portfolio/${filename}`, {
                method: 'PUT',
                headers: {
                  'Authorization': 'token ' + currentToken,
                  'Accept': 'application/vnd.github.v3+json'
                },
                body: JSON.stringify({
                  message: `Update featured status for ${filename}`,
                  content: btoa(unescape(encodeURIComponent(updatedContent))),
                  sha: fileData.sha
                })
              });
              
              if (updateResponse.ok) {
                alert('Featured status updated successfully!');
                loadPortfolioItems(currentToken);
              } else {
                alert('Error updating featured status');
              }
            }
          } catch (error) {
            alert('Error updating featured status: ' + error.message);
          }
        };

        window.togglePhotographyFeatured = async function(filename, sha, isFeatured) {
          try {
            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/photography/${filename}`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });
            
            if (response.ok) {
              const fileData = await response.json();
              const content = decodeURIComponent(escape(atob(fileData.content)));
              
              // Update the featured field and featured_date in frontmatter
              let updatedContent = content;
              
              if (isFeatured) {
                // Adding to featured - add featured field and featured_date
                if (content.includes('featured:')) {
                  updatedContent = content.replace(/featured:\s*(true|false)/, `featured: ${isFeatured}`);
                } else {
                  updatedContent = content.replace(/(title:\s*[^\n]+)/, `$1\nfeatured: ${isFeatured}`);
                }
                
                // Add or update featured_date
                const now = new Date().toISOString();
                if (content.includes('featured_date:')) {
                  updatedContent = updatedContent.replace(/featured_date:\s*[^\n]+/, `featured_date: ${now}`);
                } else {
                  updatedContent = updatedContent.replace(/(featured:\s*true)/, `$1\nfeatured_date: ${now}`);
                }
              } else {
                // Removing from featured - remove featured field and featured_date
                updatedContent = content.replace(/featured:\s*(true|false)/, `featured: ${isFeatured}`);
                updatedContent = updatedContent.replace(/featured_date:\s*[^\n]+\n?/, '');
              }
              
              const updateResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/photography/${filename}`, {
                method: 'PUT',
                headers: {
                  'Authorization': 'token ' + currentToken,
                  'Accept': 'application/vnd.github.v3+json'
                },
                body: JSON.stringify({
                  message: `Update featured status for ${filename}`,
                  content: btoa(unescape(encodeURIComponent(updatedContent))),
                  sha: fileData.sha
                })
              });
              
              if (updateResponse.ok) {
                alert('Featured status updated successfully!');
                loadPhotographyItems(currentToken);
              } else {
                alert('Error updating featured status');
              }
            }
          } catch (error) {
            alert('Error updating featured status: ' + error.message);
          }
        };

        // Function to show/hide save icon when typing in order fields
        window.showSaveIcon = function(input) {
          const saveIcon = input.nextElementSibling;
          if (input.value !== input.defaultValue) {
            saveIcon.style.display = 'inline';
          } else {
            saveIcon.style.display = 'none';
          }
        };

        window.updatePhotographyOrder = async function(filename, sha, newOrder) {
          try {
            // First, get all photography items to check for conflicts
            const listResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/photography/`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });
            
            if (!listResponse.ok) {
              alert('Error fetching photography items');
              return;
            }
            
            const items = await listResponse.json();
            const itemsToUpdate = [];
            
            // Get the current item's content
            const currentItemResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/photography/${filename}`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });
            
            if (!currentItemResponse.ok) {
              alert('Error fetching current item');
              return;
            }
            
            const currentItemData = await currentItemResponse.json();
            const currentContent = decodeURIComponent(escape(atob(currentItemData.content)));
            
            // Update the current item
            let updatedContent = currentContent;
            if (currentContent.includes('order:')) {
              updatedContent = currentContent.replace(/order:\s*\d+/, `order: ${newOrder}`);
            } else {
              updatedContent = currentContent.replace(/(title:\s*[^\n]+)/, `$1\norder: ${newOrder}`);
            }
            
            itemsToUpdate.push({
              filename: filename,
              content: updatedContent,
              sha: currentItemData.sha
            });
            
            // Check other items for conflicts and increment them
            for (const item of items) {
              if (item.name === filename || item.name === '_index.md') continue;
              
              const itemResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/photography/${item.name}`, {
                headers: {
                  'Authorization': 'token ' + currentToken,
                  'Accept': 'application/vnd.github.v3+json'
                }
              });
              
              if (itemResponse.ok) {
                const itemData = await itemResponse.json();
                const itemContent = decodeURIComponent(escape(atob(itemData.content)));
                
                // Extract current order
                const orderMatch = itemContent.match(/order:\s*(\d+)/);
                if (orderMatch) {
                  const currentOrder = parseInt(orderMatch[1]);
                  if (currentOrder >= newOrder) {
                    // Increment this item's order
                    const newItemOrder = currentOrder + 1;
                    let updatedItemContent = itemContent.replace(/order:\s*\d+/, `order: ${newItemOrder}`);
                    
                    itemsToUpdate.push({
                      filename: item.name,
                      content: updatedItemContent,
                      sha: itemData.sha
                    });
                  }
                }
              }
            }
            
            // Update all items
            for (const itemToUpdate of itemsToUpdate) {
              const updateResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/photography/${itemToUpdate.filename}`, {
                method: 'PUT',
                headers: {
                  'Authorization': 'token ' + currentToken,
                  'Accept': 'application/vnd.github.v3+json'
                },
                body: JSON.stringify({
                  message: `Update order for ${itemToUpdate.filename}`,
                  content: btoa(unescape(encodeURIComponent(itemToUpdate.content))),
                  sha: itemToUpdate.sha
                })
              });
              
              if (!updateResponse.ok) {
                alert(`Error updating ${itemToUpdate.filename}`);
                return;
              }
            }
            
            alert('Order updated successfully!');
            loadPhotographyItems(currentToken);
          } catch (error) {
            alert('Error updating order: ' + error.message);
          }
        };

        window.updatePortfolioOrder = async function(filename, sha, newOrder) {
          try {
            // First, get all portfolio items
            const listResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/portfolio/`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });
            
            if (!listResponse.ok) {
              alert('Error fetching portfolio items');
              return;
            }
            
            const items = await listResponse.json();
            const itemsToUpdate = [];
            const itemsWithOrders = [];
            
            // Load all items and their current orders
            for (const item of items) {
              if (item.name === '_index.md') continue;
              
              const itemResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/portfolio/${item.name}`, {
                headers: {
                  'Authorization': 'token ' + currentToken,
                  'Accept': 'application/vnd.github.v3+json'
                }
              });
              
              if (itemResponse.ok) {
                const itemData = await itemResponse.json();
                const itemContent = decodeURIComponent(escape(atob(itemData.content)));
                
                // Extract current order
                const orderMatch = itemContent.match(/order:\s*(\d+)/);
                const currentOrder = orderMatch ? parseInt(orderMatch[1]) : 999;
                
                itemsWithOrders.push({
                  filename: item.name,
                  content: itemContent,
                  sha: itemData.sha,
                  currentOrder: currentOrder,
                  isCurrentItem: item.name === filename
                });
              }
            }
            
            // Sort items by current order
            itemsWithOrders.sort((a, b) => a.currentOrder - b.currentOrder);
            
            // Renumber all items starting from 1
            let orderCounter = 1;
            for (const item of itemsWithOrders) {
              let newItemOrder;
              if (item.isCurrentItem) {
                // For the item being edited, use the requested order
                newItemOrder = parseInt(newOrder);
              } else {
                // For other items, assign sequential numbers, skipping the edited item's position
                if (orderCounter >= parseInt(newOrder)) {
                  orderCounter++; // Skip the position where the edited item will be
                }
                newItemOrder = orderCounter;
                orderCounter++;
              }
              
              // Update the order in the content
              let updatedContent = item.content;
              if (updatedContent.includes('order:')) {
                updatedContent = updatedContent.replace(/order:\s*\d+/, `order: ${newItemOrder}`);
              } else {
                updatedContent = updatedContent.replace(/(title:\s*[^\n]+)/, `$1\norder: ${newItemOrder}`);
              }
              
              itemsToUpdate.push({
                filename: item.filename,
                content: updatedContent,
                sha: item.sha
              });
            }
            
            // Update all items
            for (const itemToUpdate of itemsToUpdate) {
              const updateResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/portfolio/${itemToUpdate.filename}`, {
                method: 'PUT',
                headers: {
                  'Authorization': 'token ' + currentToken,
                  'Accept': 'application/vnd.github.v3+json'
                },
                body: JSON.stringify({
                  message: `Update order for ${itemToUpdate.filename}`,
                  content: btoa(unescape(encodeURIComponent(itemToUpdate.content))),
                  sha: itemToUpdate.sha
                })
              });
              
              if (!updateResponse.ok) {
                alert(`Error updating ${itemToUpdate.filename}`);
                return;
              }
            }
            
            alert('Order updated successfully!');
            loadPortfolioItems(currentToken);
          } catch (error) {
            alert('Error updating order: ' + error.message);
          }
        };

        window.updatePoetryOrder = async function(filename, sha, newOrder) {
          try {
            // First, get all poetry items
            const listResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/poetry/`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });
            
            if (!listResponse.ok) {
              alert('Error fetching poetry items');
              return;
            }
            
            const items = await listResponse.json();
            const itemsToUpdate = [];
            const itemsWithOrders = [];
            
            // Load all items and their current orders
            for (const item of items) {
              if (item.name === '_index.md') continue;
              
              const itemResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/poetry/${item.name}`, {
                headers: {
                  'Authorization': 'token ' + currentToken,
                  'Accept': 'application/vnd.github.v3+json'
                }
              });
              
              if (itemResponse.ok) {
                const itemData = await itemResponse.json();
                const itemContent = decodeURIComponent(escape(atob(itemData.content)));
                
                // Extract current order
                const orderMatch = itemContent.match(/order:\s*(\d+)/);
                const currentOrder = orderMatch ? parseInt(orderMatch[1]) : 999;
                
                itemsWithOrders.push({
                  filename: item.name,
                  content: itemContent,
                  sha: itemData.sha,
                  currentOrder: currentOrder,
                  isCurrentItem: item.name === filename
                });
              }
            }
            
            // Sort items by current order
            itemsWithOrders.sort((a, b) => a.currentOrder - b.currentOrder);
            
            // Renumber all items starting from 1
            let orderCounter = 1;
            for (const item of itemsWithOrders) {
              let newItemOrder;
              if (item.isCurrentItem) {
                // For the item being edited, use the requested order
                newItemOrder = parseInt(newOrder);
              } else {
                // For other items, assign sequential numbers, skipping the edited item's position
                if (orderCounter >= parseInt(newOrder)) {
                  orderCounter++; // Skip the position where the edited item will be
                }
                newItemOrder = orderCounter;
                orderCounter++;
              }
              
              // Update the order in the content
              let updatedContent = item.content;
              if (updatedContent.includes('order:')) {
                updatedContent = updatedContent.replace(/order:\s*\d+/, `order: ${newItemOrder}`);
              } else {
                updatedContent = updatedContent.replace(/(title:\s*[^\n]+)/, `$1\norder: ${newItemOrder}`);
              }
              
              itemsToUpdate.push({
                filename: item.filename,
                content: updatedContent,
                sha: item.sha
              });
            }
            
            // Update all items
            for (const itemToUpdate of itemsToUpdate) {
              const updateResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/poetry/${itemToUpdate.filename}`, {
                method: 'PUT',
                headers: {
                  'Authorization': 'token ' + currentToken,
                  'Accept': 'application/vnd.github.v3+json'
                },
                body: JSON.stringify({
                  message: `Update order for ${itemToUpdate.filename}`,
                  content: btoa(unescape(encodeURIComponent(itemToUpdate.content))),
                  sha: itemToUpdate.sha
                })
              });
              
              if (!updateResponse.ok) {
                alert(`Error updating ${itemToUpdate.filename}`);
                return;
              }
            }
            
            alert('Order updated successfully!');
            loadPoetryItems(currentToken);
          } catch (error) {
            alert('Error updating order: ' + error.message);
          }
        };

        window.togglePoetryFeatured = async function(filename, sha, isFeatured) {
          try {
            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/poetry/${filename}`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });
            
            if (response.ok) {
              const fileData = await response.json();
              const content = decodeURIComponent(escape(atob(fileData.content)));
              
              // Update the featured field in frontmatter
              let updatedContent = content;
              const featuredDate = new Date().toISOString();
              
              if (content.includes('featured:')) {
                updatedContent = content.replace(/featured:\s*(true|false)/, `featured: ${isFeatured}`);
              } else {
                // Add featured field after title
                updatedContent = content.replace(/(title:\s*[^\n]+)/, `$1\nfeatured: ${isFeatured}`);
              }
              
              // Add or update featured_date
              if (isFeatured) {
                if (content.includes('featured_date:')) {
                  updatedContent = updatedContent.replace(/featured_date:\s*[^\n]+/, `featured_date: ${featuredDate}`);
                } else {
                  updatedContent = updatedContent.replace(/(featured:\s*(true|false))/, `$1\nfeatured_date: ${featuredDate}`);
                }
              } else {
                // Remove featured_date when unfeaturing
                updatedContent = updatedContent.replace(/featured_date:\s*[^\n]+\n?/, '');
              }
              
              const updateResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/poetry/${filename}`, {
                method: 'PUT',
                headers: {
                  'Authorization': 'token ' + currentToken,
                  'Accept': 'application/vnd.github.v3+json'
                },
                body: JSON.stringify({
                  message: `Update featured status for ${filename}`,
                  content: btoa(unescape(encodeURIComponent(updatedContent))),
                  sha: fileData.sha
                })
              });
              
              if (updateResponse.ok) {
                alert('Featured status updated successfully!');
                loadPoetryItems(currentToken);
              } else {
                alert('Error updating featured status');
              }
            }
          } catch (error) {
            alert('Error updating featured status: ' + error.message);
          }
        };

        window.updateVideographyOrder = async function(filename, sha, newOrder) {
          try {
            // First, get all videography items
            const listResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/videography/`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });
            
            if (!listResponse.ok) {
              alert('Error fetching videography items');
              return;
            }
            
            const items = await listResponse.json();
            const itemsToUpdate = [];
            const itemsWithOrders = [];
            
            // Load all items and their current orders
            for (const item of items) {
              if (item.name === '_index.md') continue;
              
              const itemResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/videography/${item.name}`, {
                headers: {
                  'Authorization': 'token ' + currentToken,
                  'Accept': 'application/vnd.github.v3+json'
                }
              });
              
              if (itemResponse.ok) {
                const itemData = await itemResponse.json();
                const itemContent = decodeURIComponent(escape(atob(itemData.content)));
                
                // Extract current order
                const orderMatch = itemContent.match(/order:\s*(\d+)/);
                const currentOrder = orderMatch ? parseInt(orderMatch[1]) : 999;
                
                itemsWithOrders.push({
                  filename: item.name,
                  content: itemContent,
                  sha: itemData.sha,
                  currentOrder: currentOrder,
                  isCurrentItem: item.name === filename
                });
              }
            }
            
            // Sort items by current order
            itemsWithOrders.sort((a, b) => a.currentOrder - b.currentOrder);
            
            // Renumber all items starting from 1
            let orderCounter = 1;
            for (const item of itemsWithOrders) {
              let newItemOrder;
              if (item.isCurrentItem) {
                // For the item being edited, use the requested order
                newItemOrder = parseInt(newOrder);
              } else {
                // For other items, assign sequential numbers, skipping the edited item's position
                if (orderCounter >= parseInt(newOrder)) {
                  orderCounter++; // Skip the position where the edited item will be
                }
                newItemOrder = orderCounter;
                orderCounter++;
              }
              
              // Update the order in the content
              let updatedContent = item.content;
              if (updatedContent.includes('order:')) {
                updatedContent = updatedContent.replace(/order:\s*\d+/, `order: ${newItemOrder}`);
              } else {
                updatedContent = updatedContent.replace(/(title:\s*[^\n]+)/, `$1\norder: ${newItemOrder}`);
              }
              
              itemsToUpdate.push({
                filename: item.filename,
                content: updatedContent,
                sha: item.sha
              });
            }
            
            // Update all items
            let hasErrors = false;
            for (const itemToUpdate of itemsToUpdate) {
              const updateResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/videography/${itemToUpdate.filename}`, {
                method: 'PUT',
                headers: {
                  'Authorization': 'token ' + currentToken,
                  'Accept': 'application/vnd.github.v3+json'
                },
                body: JSON.stringify({
                  message: `Update order for ${itemToUpdate.filename}`,
                  content: btoa(unescape(encodeURIComponent(itemToUpdate.content))),
                  sha: itemToUpdate.sha
                })
              });
              
              if (!updateResponse.ok) {
                console.error(`Error updating ${itemToUpdate.filename}:`, updateResponse.status, updateResponse.statusText);
                hasErrors = true;
              }
            }
            
            if (hasErrors) {
              alert('Order updated with some warnings, but the main change was successful.');
            } else {
              alert('Order updated successfully!');
            }
            loadVideographyItems(currentToken);
          } catch (error) {
            alert('Error updating order: ' + error.message);
          }
        };

        window.toggleVideographyFeatured = async function(filename, sha, isFeatured) {
          try {
            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/videography/${filename}`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });
            
            if (response.ok) {
              const fileData = await response.json();
              const content = decodeURIComponent(escape(atob(fileData.content)));
              
              // Update the featured field in frontmatter
              let updatedContent = content;
              const featuredDate = new Date().toISOString();
              
              if (content.includes('featured:')) {
                updatedContent = content.replace(/featured:\s*(true|false)/, `featured: ${isFeatured}`);
              } else {
                // Add featured field after title
                updatedContent = content.replace(/(title:\s*[^\n]+)/, `$1\nfeatured: ${isFeatured}`);
              }
              
              // Add or update featured_date
              if (isFeatured) {
                if (content.includes('featured_date:')) {
                  updatedContent = updatedContent.replace(/featured_date:\s*[^\n]+/, `featured_date: ${featuredDate}`);
                } else {
                  updatedContent = updatedContent.replace(/(featured:\s*(true|false))/, `$1\nfeatured_date: ${featuredDate}`);
                }
              } else {
                // Remove featured_date when unfeaturing
                updatedContent = updatedContent.replace(/featured_date:\s*[^\n]+\n?/, '');
              }
              
              const updateResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/videography/${filename}`, {
                method: 'PUT',
                headers: {
                  'Authorization': 'token ' + currentToken,
                  'Accept': 'application/vnd.github.v3+json'
                },
                body: JSON.stringify({
                  message: `Update featured status for ${filename}`,
                  content: btoa(unescape(encodeURIComponent(updatedContent))),
                  sha: fileData.sha
                })
              });
              
              if (updateResponse.ok) {
                alert('Featured status updated successfully!');
                loadVideographyItems(currentToken);
              } else {
                alert('Error updating featured status');
              }
            }
          } catch (error) {
            alert('Error updating featured status: ' + error.message);
          }
        };

        // Initialize only once to prevent loops
        if (!window.authInitialized) {
          window.authInitialized = true;
        initializeAuth();
        }
        
        // Run regression tests after initialization
        setTimeout(() => {
          console.log('🔍 Running automatic regression tests...');
          window.runRegressionTests();
        }, 4000);

        // Videography Management Functions
        function toggleVideoInputs() {
          const sourceType = document.getElementById('video-source-type').value;
          const urlInputs = document.getElementById('url-inputs');
          const fileInputs = document.getElementById('file-inputs');
          const videoTypeSelect = document.getElementById('videography-type');
          
          if (sourceType === 'file') {
            urlInputs.style.display = 'none';
            fileInputs.style.display = 'block';
            videoTypeSelect.value = 'uploaded';
            videoTypeSelect.disabled = true;
          } else {
            urlInputs.style.display = 'block';
            fileInputs.style.display = 'none';
            videoTypeSelect.disabled = false;
          }
        }

        function showAddVideographyForm() {
          console.log('showAddVideographyForm function called');
          
          // Remove any existing modal first
          const existingModal = document.getElementById('add-videography-modal');
          if (existingModal) {
            existingModal.remove();
          }

          const form = document.createElement('div');
          form.id = 'add-videography-modal';
          form.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;';

          form.innerHTML = `
            <div style="background:white;padding:20px;border-radius:8px;width:80%;max-width:600px;max-height:80%;overflow-y:auto;position:relative;">
              <button onclick="document.getElementById('add-videography-modal').remove()" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;">&times;</button>
              <h3>Add New Video</h3>
              <form id="add-videography-form">
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Title:</label>
                  <input type="text" id="videography-title" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Description:</label>
                  <input type="text" id="videography-description" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Video Source:</label>
                  <select id="video-source-type" onchange="toggleVideoInputs()" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;margin-bottom:10px;">
                    <option value="url">YouTube/Vimeo URL</option>
                    <option value="file">Upload Video File</option>
                  </select>
                </div>
                <div id="url-inputs" style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Video URL (YouTube or Vimeo):</label>
                  <input type="url" id="videography-url" placeholder="https://www.youtube.com/watch?v=... or https://vimeo.com/..." style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                </div>
                <div id="file-inputs" style="margin-bottom:15px;display:none;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Upload Video File:</label>
                  <input type="file" id="videography-file" accept="video/*" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  <small style="color:#666;font-size:12px;margin-top:5px;display:block;">Supported formats: MP4, WebM, MOV, AVI (Max 100MB)</small>
                </div>
                <div id="video-type-container" style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Video Type:</label>
                  <select id="videography-type" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                    <option value="">Select video type</option>
                    <option value="youtube">YouTube</option>
                    <option value="vimeo">Vimeo</option>
                    <option value="uploaded">Uploaded Video</option>
                  </select>
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Tags (comma-separated):</label>
                  <input type="text" id="videography-tags" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;">Content (Markdown) - Optional:</label>
                  <textarea id="videography-content" rows="6" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;"></textarea>
                </div>
                <div style="margin-bottom:15px;">
                  <label style="display:flex;align-items:center;gap:8px;font-weight:bold;">
                    <input type="checkbox" id="videography-featured" style="margin:0;">
                    Featured on Homepage
                  </label>
                </div>
                <div style="text-align:right;">
                  <button type="button" onclick="document.getElementById('add-videography-modal').remove()" style="background:#6c757d;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;margin-right:10px;">Cancel</button>
                  <button type="submit" style="background:#fd7e14;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;">Add Video</button>
                </div>
              </form>
            </div>
          `;
          document.body.appendChild(form);

          // Initialize form state
          toggleVideoInputs();
          
          // Handle form submission
          document.getElementById('add-videography-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
              const title = document.getElementById('videography-title').value;
              const description = document.getElementById('videography-description').value;
              const sourceType = document.getElementById('video-source-type').value;
              const tags = document.getElementById('videography-tags').value;
              const content = document.getElementById('videography-content').value;
              const featured = document.getElementById('videography-featured').checked;
              
              let videoUrl = '';
              let videoType = '';
              
              if (sourceType === 'file') {
                const fileInput = document.getElementById('videography-file');
                const file = fileInput.files[0];
                
                if (!file) {
                  alert('Please select a video file to upload');
                  return;
                }
                
                // Check file size (100MB limit)
                if (file.size > 100 * 1024 * 1024) {
                  alert('File size must be less than 100MB');
                  return;
                }
                
                // Upload the video file
                videoUrl = await uploadVideoFile(file);
                videoType = 'uploaded';
              } else {
                videoUrl = document.getElementById('videography-url').value;
                videoType = document.getElementById('videography-type').value;
                
                if (!videoUrl) {
                  alert('Please enter a video URL');
                  return;
                }
              }
              
              // Create videography item
              await createVideographyItem(title, description, videoUrl, videoType, tags, content, featured);

              form.remove();
              loadVideographyItems(currentToken);
            } catch (error) {
              alert('Error adding video: ' + error.message);
            }
          });
        }

        async function uploadVideoFile(file) {
          try {
            console.log('Uploading video file:', file.name, 'Size:', file.size);
            
            // Convert file to base64
            const base64 = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = () => resolve(reader.result.split(',')[1]);
              reader.onerror = reject;
              reader.readAsDataURL(file);
            });
            
            // Generate filename
            const timestamp = Date.now();
            const extension = file.name.split('.').pop();
            const filename = `video-${timestamp}.${extension}`;
            
            // Upload to GitHub
            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/static/uploads/${filename}`, {
              method: 'PUT',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              },
              body: JSON.stringify({
                message: `Upload video: ${file.name}`,
                content: base64
              })
            });
            
            if (response.ok) {
              const result = await response.json();
              console.log('Video uploaded successfully:', result.content.download_url);
              return result.content.download_url;
            } else {
              const error = await response.json();
              throw new Error('Failed to upload video: ' + (error.message || 'Unknown error'));
            }
          } catch (error) {
            console.error('Error uploading video:', error);
            throw error;
          }
        }

        async function createVideographyItem(title, description, videoUrl, videoType, tags, content, featured = false) {
          try {
            const slug = title.toLowerCase().replace(/[^a-z0-9\s]+/g, '').replace(/\s+/g, '-').replace(/^-|-$/g, '');
            const filename = slug + '.md';
            const date = new Date().toISOString().split('T')[0];
            
            // Build frontmatter
            let frontmatter = `---
title: "${title}"
date: ${date}
description: "${description}"
video_url: "${videoUrl}"
video_type: "${videoType}"
featured: ${featured}`;

            if (tags) {
              const tagArray = tags.split(',').map(tag => tag.trim()).filter(tag => tag);
              if (tagArray.length > 0) {
                frontmatter += `
tags:
  - "${tagArray.join('"\n  - "')}"`;
              }
            }

            frontmatter += `
---`;

            if (content) {
              frontmatter += `\n\n${content}`;
            }

            const response = await fetch('https://api.github.com/repos/oos/omarosullivan.com/contents/content/videography/' + filename, {
              method: 'PUT',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Add video: ${title}`,
                content: btoa(unescape(encodeURIComponent(frontmatter)))
              })
            });

            if (response.ok) {
              alert('Video added successfully!');
            } else {
              alert('Failed to add video');
            }
          } catch (e) {
            alert('Error adding video: ' + e.message);
          }
        }

        async function loadVideographyItems(token) {
          if (window.isLoadingVideography) {
            log('[api] Already loading videography items, skipping...', 'token');
            return;
          }
          
          window.isLoadingVideography = true;
          try {
            console.log('[debug] Starting to load videography items...');
            
            const response = await fetch('https://api.github.com/repos/oos/omarosullivan.com/contents/content/videography', {
              headers: {
                'Authorization': 'token ' + token,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            if (response.ok) {
              const items = await response.json();
              console.log('[api] Loaded videography items');
              console.log('[debug] Videography items loaded:', items);
              
              const videographyList = document.getElementById('videography-list');
              if (videographyList) {
                videographyList.innerHTML = '';
                
                const videographyItems = items.filter(item => item.name.endsWith('.md'));
                console.log('[debug] Filtered videography items:', videographyItems);
                
                // Load all items first to get their metadata for sorting
                const itemsWithMetadata = [];
                for (const item of videographyItems) {
                  if (item.name === '_index.md') {
                    itemsWithMetadata.push({
                      ...item,
                      displayTitle: item.name + ' (Videography Section Page)',
                      date: '1900-01-01',
                      content: '',
                      isSectionPage: true
                    });
                  } else {
                    try {
                      const fileResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/videography/${item.name}`, {
                        headers: {
                          'Authorization': 'token ' + token,
                          'Accept': 'application/vnd.github.v3+json'
                        }
                      });
                        
                        if (fileResponse.ok) {
                          const fileData = await fileResponse.json();
                          const content = decodeURIComponent(escape(atob(fileData.content)));
                          const titleMatch = content.match(/title:\s*["']([^"\n]+)["']/);
                          const dateMatch = content.match(/date:\s*(\d{4}-\d{2}-\d{2})/);
                          const displayTitle = titleMatch ? titleMatch[1].trim() : item.name.replace('.md', '');
                          const date = dateMatch ? dateMatch[1] : '1900-01-01';
                          
                          // Check if this item is featured
                          const featuredMatch = content.match(/featured:\s*(true|false)/i);
                          const isFeatured = featuredMatch ? featuredMatch[1].toLowerCase() === 'true' : false;
                          
                          // Check for featured_date field
                          const featuredDateMatch = content.match(/featured_date:\s*([^\n]+)/);
                          const featuredDate = featuredDateMatch ? featuredDateMatch[1].trim() : null;
                          
                          // Check for order field
                          const orderMatch = content.match(/order:\s*(\d+)/);
                          const currentOrder = orderMatch ? parseInt(orderMatch[1]) : 999;
                          
                          itemsWithMetadata.push({
                            ...item,
                            displayTitle,
                            date,
                            content,
                            isFeatured,
                            featuredDate,
                            order: currentOrder,
                            isSectionPage: false
                          });
                        }
                    } catch (error) {
                      console.error('Error loading videography item:', error);
                      itemsWithMetadata.push({
                        ...item,
                        displayTitle: item.name.replace('.md', ''),
                        date: '1900-01-01',
                        content: '',
                        isSectionPage: false
                      });
                    }
                  }
                }
                
                // Sort items: section pages first, then by order field, then by date, then by title
                itemsWithMetadata.sort((a, b) => {
                  if (a.isSectionPage && !b.isSectionPage) return -1;
                  if (!a.isSectionPage && b.isSectionPage) return 1;
                  
                  // Get order values (default to 999 if not set)
                  const orderA = a.content ? (a.content.match(/order:\s*(\d+)/) ? parseInt(a.content.match(/order:\s*(\d+)/)[1]) : 999) : 999;
                  const orderB = b.content ? (b.content.match(/order:\s*(\d+)/) ? parseInt(b.content.match(/order:\s*(\d+)/)[1]) : 999) : 999;
                  
                  // Sort by order field first (lower numbers first)
                  if (orderA !== orderB) {
                    return orderA - orderB;
                  }
                  
                  // If order is the same, sort by date (newest first)
                  if (a.date !== b.date) {
                    return b.date.localeCompare(a.date);
                  }
                  
                  // Finally sort by title alphabetically
                  return a.displayTitle.localeCompare(b.displayTitle);
                });
                
                // Clear the loading indicator before populating content
                videographyList.innerHTML = '';
                
                // Display items in the correct order
                for (const item of itemsWithMetadata) {
                  const div = document.createElement('div');
                  div.style.cssText = 'border:1px solid #ddd;padding:10px;margin:5px;border-radius:3px;';
                  
                  // Handle _index.md files differently (these are section pages, not individual videos)
                  if (item.isSectionPage) {
                    div.innerHTML = `
                      <strong>${item.displayTitle}</strong>
                      <button onclick="editPage('videography')" style="float:right;background:#007cba;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;margin-left:5px;">Edit Section</button>
                    `;
                    videographyList.appendChild(div);
                  } else {
                    // Use pre-loaded metadata
                    const content = item.content;
                    const displayTitle = item.displayTitle;
                    const date = item.date;
                    const isFeatured = item.isFeatured;
                    const featuredDate = item.featuredDate;
                    const currentOrder = item.order;
                    
                    // Format featured date for display
                    let featuredDateDisplay = '';
                    if (featuredDate) {
                      const featuredDateObj = new Date(featuredDate);
                      featuredDateDisplay = ` (${featuredDateObj.toLocaleDateString()} ${featuredDateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'})})`;
                    }
                    
                    div.innerHTML = `
                      <div style="display:flex;align-items:center;justify-content:space-between;">
                        <div style="display:flex;align-items:center;gap:8px;flex:1;">
                          <label style="display:flex;align-items:center;gap:8px;">
                            <input type="checkbox" ${isFeatured ? 'checked' : ''} onchange="toggleVideographyFeatured('${item.name}', '${item.sha}', this.checked)" style="margin:0;">
                            <strong>${displayTitle}</strong>
                            ${isFeatured ? '<span style="background:#28a745;color:white;padding:2px 6px;border-radius:3px;font-size:11px;margin-left:8px;">Featured on Homepage' + featuredDateDisplay + '</span>' : ''}
                          </label>
                          <div style="display:flex;gap:5px;margin-left:10px;">
                            <button onclick="editVideographyItem('${item.name}', '${item.sha}')" style="background:#007cba;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;">Edit</button>
                            <button onclick="deleteVideographyItem('${item.name}', '${item.sha}')" style="background:#dc3545;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;">Delete</button>
                          </div>
                          <div style="display:flex;align-items:center;gap:5px;margin-left:20px;">
                            <label style="font-size:12px;color:#666;">Order Field:</label>
                            <div style="display:inline-flex;align-items:center;gap:5px;">
                              <input type="number" value="${currentOrder}" min="1" max="999" onchange="updateVideographyOrder('${item.name}', '${item.sha}', this.value)" oninput="showSaveIcon(this)" style="width:60px;padding:2px 4px;border:1px solid #ccc;border-radius:3px;font-size:12px;">
                              <span class="save-icon" style="display:none;color:#28a745;cursor:pointer;font-size:16px;font-weight:bold;" onclick="updateVideographyOrder('${item.name}', '${item.sha}', this.previousElementSibling.value)">✓</span>
                            </div>
                          </div>
                          <div style="display:flex;align-items:center;gap:5px;margin-left:20px;">
                            <label style="font-size:12px;color:#666;">Date:</label>
                            <span style="font-size:12px;color:#333;">${date}</span>
                          </div>
                        </div>
                      </div>
                    `;
                  }
                  videographyList.appendChild(div);
                  console.log('[debug] Added videography item to list:', item.name);
                }
                
                return items;
              }
            } else if (response.status === 401) {
              log('[api] Token expired or invalid (401). Clearing tokens and requiring re-authentication.', 'error');
              console.log('[api] Videography: Clearing invalid tokens...');
              clearInvalidTokens();
            } else {
              log(`[api] Failed to load videography items: ${response.status}`, 'error');
              const videographyList = document.getElementById('videography-list');
              if (videographyList) {
                videographyList.innerHTML = '<div style="text-align:center;padding:20px;color:#666;">Error loading videos. Please refresh the page.</div>';
              }
            }
          } catch (e) {
            log(`[api] Error loading videography items: ${e.message}`, 'error');
            console.error('[api] Videography loading error:', e);
            const videographyList = document.getElementById('videography-list');
            if (videographyList) {
              videographyList.innerHTML = '<div style="text-align:center;padding:20px;color:#666;">Error loading videos. Please refresh the page.</div>';
            }
          } finally {
            window.isLoadingVideography = false;
          }
        }

        async function editVideographyItem(filename, sha) {
          try {
            console.log('editVideographyItem called with filename:', filename, 'sha:', sha);
            // First, get the current content
            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/videography/${filename}`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            if (!response.ok) {
              alert('Error loading videography item');
              return;
            }

            const file = await response.json();
            const content = decodeURIComponent(escape(atob(file.content)));
            
            // Parse frontmatter
            const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);
            let title = filename.replace('.md', '');
            let description = '';
            let videoUrl = '';
            let videoType = '';
            let tags = '';
            let contentText = '';
            let featured = false;

            if (frontmatterMatch) {
              const frontmatter = frontmatterMatch[1];
              console.log('Frontmatter found:', frontmatter);
              
              // Better regex patterns that handle both quoted and unquoted values
              const titleMatch = frontmatter.match(/title:\s*["']?([^"'\n]+)["']?/);
              const descMatch = frontmatter.match(/description:\s*["']?([^"'\n]*)["']?/);
              const videoUrlMatch = frontmatter.match(/video_url:\s*["']?([^"'\n]*)["']?/);
              const videoTypeMatch = frontmatter.match(/video_type:\s*["']?([^"'\n]*)["']?/);
              const tagsMatch = frontmatter.match(/tags:\s*\[([^\]]*)\]/);
              const featuredMatch = frontmatter.match(/featured:\s*(true|false)/);
              
              console.log('Matches:', { titleMatch, descMatch, videoUrlMatch, videoTypeMatch, tagsMatch, featuredMatch });
              
              if (titleMatch) title = titleMatch[1].trim();
              if (descMatch) description = descMatch[1].trim();
              if (videoUrlMatch) videoUrl = videoUrlMatch[1].trim();
              if (videoTypeMatch) videoType = videoTypeMatch[1].trim();
              if (tagsMatch) tags = tagsMatch[1].trim();
              if (featuredMatch) featured = featuredMatch[1] === 'true';
              contentText = frontmatterMatch[2];
              
              console.log('Extracted values:', { title, description, videoUrl, videoType, tags, featured });
            } else {
              contentText = content;
            }

            // Create edit form
            const form = document.createElement('div');
            form.id = 'edit-videography-modal';
            form.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;';

            form.innerHTML = `
              <div style="background:white;padding:20px;border-radius:8px;width:80%;max-width:600px;max-height:80%;overflow-y:auto;position:relative;">
                <button onclick="document.getElementById('edit-videography-modal').remove()" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;">&times;</button>
                <h3>Edit Video</h3>
                <form id="edit-videography-form">
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Title:</label>
                    <input type="text" id="edit-videography-title" value="${title}" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Description:</label>
                    <input type="text" id="edit-videography-description" value="${description}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Video URL (YouTube or Vimeo):</label>
                    <input type="url" id="edit-videography-url" value="${videoUrl}" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Video Type:</label>
                    <select id="edit-videography-type" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                      <option value="youtube" ${videoType === 'youtube' ? 'selected' : ''}>YouTube</option>
                      <option value="vimeo" ${videoType === 'vimeo' ? 'selected' : ''}>Vimeo</option>
                    </select>
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Tags (comma-separated):</label>
                    <input type="text" id="edit-videography-tags" value="${tags}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Content (Markdown) - Optional:</label>
                    <textarea id="edit-videography-content" rows="6" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">${contentText}</textarea>
                  </div>
                  <div style="margin-bottom:15px;">
                    <label style="display:flex;align-items:center;gap:8px;font-weight:bold;">
                      <input type="checkbox" id="edit-videography-featured" ${featured ? 'checked' : ''} style="margin:0;">
                      Featured on Homepage
                    </label>
                  </div>
                  <div style="text-align:right;">
                    <button type="button" onclick="document.getElementById('edit-videography-modal').remove()" style="background:#6c757d;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;margin-right:10px;">Cancel</button>
                    <button type="submit" style="background:#fd7e14;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;">Save</button>
                  </div>
                </form>
              </div>
            `;
            document.body.appendChild(form);

            // Handle form submission
            document.getElementById('edit-videography-form').addEventListener('submit', async (e) => {
              e.preventDefault();
              try {
                const newTitle = document.getElementById('edit-videography-title').value;
                const newDescription = document.getElementById('edit-videography-description').value;
                const newVideoUrl = document.getElementById('edit-videography-url').value;
                const newVideoType = document.getElementById('edit-videography-type').value;
                const newTags = document.getElementById('edit-videography-tags').value;
                const newContent = document.getElementById('edit-videography-content').value;
                const newFeatured = document.getElementById('edit-videography-featured').checked;
                
                await updateVideographyItem(filename, sha, newTitle, newDescription, newVideoUrl, newVideoType, newTags, newContent, newFeatured);

                form.remove();
                loadVideographyItems(currentToken);
              } catch (error) {
                alert('Error updating video: ' + error.message);
              }
            });
          } catch (e) {
            alert('Error loading videography item: ' + e.message);
          }
        }

        async function updateVideographyItem(filename, sha, title, description, videoUrl, videoType, tags, content, featured = false) {
          try {
            console.log('updateVideographyItem called with filename:', filename, 'sha:', sha);
            const date = new Date().toISOString().split('T')[0];
            
            // First, get the current content to preserve existing order
            const currentResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/videography/${filename}`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            let existingOrder = '';
            if (currentResponse.ok) {
              const currentFile = await currentResponse.json();
              const currentContent = decodeURIComponent(escape(atob(currentFile.content)));
              const frontmatterMatch = currentContent.match(/^---\n([\s\S]*?)\n---/);
              if (frontmatterMatch) {
                const orderMatch = frontmatterMatch[1].match(/order:\s*(\d+)/);
                if (orderMatch) {
                  existingOrder = `order: ${orderMatch[1]}`;
                }
              }
            }
            
            // Build frontmatter
            let frontmatter = `---
title: "${title}"
date: ${date}
description: "${description}"
video_url: "${videoUrl}"
video_type: "${videoType}"
featured: ${featured}`;

            if (existingOrder) {
              frontmatter += `\n${existingOrder}`;
            }

            if (tags) {
              const tagArray = tags.split(',').map(tag => tag.trim()).filter(tag => tag);
              if (tagArray.length > 0) {
                frontmatter += `
tags:
  - "${tagArray.join('"\n  - "')}"`;
              }
            }

            frontmatter += `
---`;

            if (content) {
              frontmatter += `\n\n${content}`;
            }

            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/videography/${filename}`, {
              method: 'PUT',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Update video: ${title}`,
                content: btoa(unescape(encodeURIComponent(frontmatter))),
                sha: sha
              })
            });

            if (response.ok) {
              alert('Video updated successfully!');
            } else {
              alert('Failed to update video');
            }
          } catch (e) {
            alert('Error updating video: ' + e.message);
          }
        }

        async function deleteVideographyItem(filename, sha) {
          try {
            console.log('deleteVideographyItem called with:', { filename, sha });
            if (!confirm(`Are you sure you want to delete the video "${filename}"? This action cannot be undone.`)) {
              return;
            }

            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/videography/${filename}`, {
              method: 'DELETE',
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Delete video: ${filename}`,
                sha: sha
              })
            });

            if (response.ok) {
              alert('Video deleted successfully!');
              console.log('Video deleted, reloading videography items...');
              try {
                await loadVideographyItems(currentToken);
                console.log('Videography items reloaded successfully');
              } catch (error) {
                console.error('Error reloading videography items:', error);
                alert('Video deleted but failed to refresh the list. Please refresh the page.');
              }
            } else {
              const error = await response.json().catch(() => ({}));
              console.error('Delete video error:', response.status, error);
              alert('Error deleting video: ' + (error.message || 'Unknown error'));
            }
          } catch (e) {
            alert('Error deleting video: ' + e.message);
          }
        }

        // Update the global function references to point to the actual functions
        window.editPortfolioItem = editPortfolioItem;
        window.editPoetryItem = editPoetryItem;
        window.editPageInternal = editPage;
        // Bulk Upload Functions
        async function generateAITitle(file, category) {
          try {
            const filename = file.name.replace(/\.[^/.]+$/, ""); // Remove extension
            
            // Generate more descriptive, AI-like titles based on category and filename patterns
            switch(category) {
              case 'photography':
                return generatePhotographyTitle(filename);
              case 'portfolio':
                return generatePortfolioTitle(filename);
              case 'poetry':
                return generatePoetryTitle(filename);
              case 'videography':
                return generateVideographyTitle(filename);
              default:
                return filename.replace(/[-_]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            }
          } catch (error) {
            console.error('Error generating AI title:', error);
            return file.name.replace(/\.[^/.]+$/, "");
          }
        }

        function generatePhotographyTitle(filename) {
          // Remove common Instagram-style number patterns and generate descriptive titles
          const cleanName = filename
            .replace(/^\d+[-_]/g, '') // Remove leading numbers with dash/underscore
            .replace(/[-_]\d+$/g, '') // Remove trailing numbers with dash/underscore
            .replace(/[-_]/g, ' ')
            .replace(/\b\w/g, l => l.toUpperCase())
            .trim();
          
          // Generate descriptive photography titles
          const photographyTitles = [
            'Urban Landscape',
            'Street Photography',
            'Portrait Study',
            'Nature Scene',
            'Architectural Detail',
            'Candid Moment',
            'Abstract Composition',
            'Golden Hour',
            'Black and White',
            'Color Study',
            'Documentary Style',
            'Artistic Vision',
            'Emotional Capture',
            'Visual Story',
            'Creative Perspective',
            'Moody Atmosphere',
            'Textural Detail',
            'Light and Shadow',
            'Minimalist View',
            'Dynamic Composition'
          ];
          
          // Check if filename is mostly numbers (Instagram-style)
          const numbersOnly = filename.replace(/[-_]/g, '').replace(/\.[^/.]+$/, '');
          if (/^\d+$/.test(numbersOnly) || numbersOnly.length > 10) {
            return photographyTitles[Math.floor(Math.random() * photographyTitles.length)];
          }
          
          // If we have a meaningful name, use it
          if (cleanName.length > 3 && !/^\d+$/.test(cleanName.replace(/\s/g, ''))) {
            return cleanName;
          }
          
          return photographyTitles[Math.floor(Math.random() * photographyTitles.length)];
        }

        function generatePortfolioTitle(filename) {
          const cleanName = filename
            .replace(/^\d+[-_]/g, '')
            .replace(/[-_]\d+$/g, '')
            .replace(/[-_]/g, ' ')
            .replace(/\b\w/g, l => l.toUpperCase())
            .trim();
          
          const portfolioTitles = [
            'Sketch Study',
            'Artistic Drawing',
            'Creative Sketch',
            'Pencil Work',
            'Conceptual Art',
            'Visual Design',
            'Illustration',
            'Artistic Expression',
            'Creative Process',
            'Design Study',
            'Artistic Vision',
            'Creative Concept',
            'Visual Art',
            'Design Sketch',
            'Artistic Creation'
          ];
          
          if (/^\d+$/.test(filename.replace(/[-_]/g, ''))) {
            return portfolioTitles[Math.floor(Math.random() * portfolioTitles.length)];
          }
          
          if (cleanName.length > 3) {
            return cleanName;
          }
          
          return portfolioTitles[Math.floor(Math.random() * portfolioTitles.length)];
        }

        function generatePoetryTitle(filename) {
          const cleanName = filename
            .replace(/^\d+[-_]/g, '')
            .replace(/[-_]\d+$/g, '')
            .replace(/[-_]/g, ' ')
            .replace(/\b\w/g, l => l.toUpperCase())
            .trim();
          
          const poetryTitles = [
            'Reflections',
            'Inner Thoughts',
            'Emotional Journey',
            'Poetic Expression',
            'Words of Wisdom',
            'Creative Verse',
            'Artistic Words',
            'Poetic Vision',
            'Emotional Depth',
            'Creative Writing',
            'Poetic Flow',
            'Artistic Language',
            'Emotional Resonance',
            'Poetic Beauty',
            'Creative Expression'
          ];
          
          if (/^\d+$/.test(filename.replace(/[-_]/g, ''))) {
            return poetryTitles[Math.floor(Math.random() * poetryTitles.length)];
          }
          
          if (cleanName.length > 3) {
            return cleanName;
          }
          
          return poetryTitles[Math.floor(Math.random() * poetryTitles.length)];
        }

        function generateVideographyTitle(filename) {
          const cleanName = filename
            .replace(/^\d+[-_]/g, '')
            .replace(/[-_]\d+$/g, '')
            .replace(/[-_]/g, ' ')
            .replace(/\b\w/g, l => l.toUpperCase())
            .trim();
          
          const videographyTitles = [
            'Creative Video',
            'Visual Story',
            'Motion Art',
            'Cinematic Piece',
            'Video Production',
            'Creative Content',
            'Visual Narrative',
            'Motion Graphics',
            'Video Art',
            'Creative Film',
            'Visual Expression',
            'Motion Design',
            'Video Story',
            'Creative Motion',
            'Visual Content'
          ];
          
          if (/^\d+$/.test(filename.replace(/[-_]/g, ''))) {
            return videographyTitles[Math.floor(Math.random() * videographyTitles.length)];
          }
          
          if (cleanName.length > 3) {
            return cleanName;
          }
          
          return videographyTitles[Math.floor(Math.random() * videographyTitles.length)];
        }

        async function getNextOrderNumber(category) {
          try {
            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/${category}`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            if (response.ok) {
              const items = await response.json();
              let maxOrder = 0;
              
              // Get all existing order numbers
              for (const item of items) {
                if (item.type === 'file' && item.name.endsWith('.md')) {
                  try {
                    const itemResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/${category}/${item.name}`, {
                      headers: {
                        'Authorization': 'token ' + currentToken,
                        'Accept': 'application/vnd.github.v3+json'
                      }
                    });
                    
                    if (itemResponse.ok) {
                      const itemData = await itemResponse.json();
                      const content = decodeURIComponent(escape(atob(itemData.content)));
                      const orderMatch = content.match(/order:\s*(\d+)/);
                      const order = orderMatch ? parseInt(orderMatch[1]) : 999;
                      if (order > maxOrder) {
                        maxOrder = order;
                      }
                    }
                  } catch (error) {
                    console.error(`Error getting order for ${item.name}:`, error);
                  }
                }
              }
              
              return maxOrder + 1;
            }
          } catch (error) {
            console.error('Error getting next order number:', error);
          }
          
          return 1; // Fallback to 1 if we can't determine the next order
        }

        async function shiftExistingItemsDown(category, newItemsCount) {
          try {
            console.log(`Shifting existing ${category} items down by ${newItemsCount} positions...`);
            
            const response = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/${category}`, {
              headers: {
                'Authorization': 'token ' + currentToken,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            if (response.ok) {
              const items = await response.json();
              const itemsToUpdate = [];
              
              // Get all existing items with their current order
              for (const item of items) {
                if (item.type === 'file' && item.name.endsWith('.md') && item.name !== '_index.md') {
                  try {
                    const itemResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/${category}/${item.name}`, {
                      headers: {
                        'Authorization': 'token ' + currentToken,
                        'Accept': 'application/vnd.github.v3+json'
                      }
                    });
                    
                    if (itemResponse.ok) {
                      const itemData = await itemResponse.json();
                      const content = decodeURIComponent(escape(atob(itemData.content)));
                      const orderMatch = content.match(/order:\s*(\d+)/);
                      const currentOrder = orderMatch ? parseInt(orderMatch[1]) : 999;
                      
                      // Shift order down by the number of new items
                      const newOrder = currentOrder + newItemsCount;
                      
                      // Update the content with new order
                      const updatedContent = content.replace(
                        /order:\s*\d+/,
                        `order: ${newOrder}`
                      );
                      
                      itemsToUpdate.push({
                        filename: item.name,
                        content: updatedContent,
                        sha: itemData.sha
                      });
                    }
                  } catch (error) {
                    console.error(`Error processing ${item.name} for shift:`, error);
                  }
                }
              }
              
              // Update all items with their new order numbers
              for (const item of itemsToUpdate) {
                try {
                  const updateResponse = await fetch(`https://api.github.com/repos/oos/omarosullivan.com/contents/content/${category}/${item.filename}`, {
                    method: 'PUT',
                    headers: {
                      'Authorization': 'token ' + currentToken,
                      'Accept': 'application/vnd.github.v3+json',
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                      message: `Shift order for ${item.filename} to make room for new items`,
                      content: btoa(unescape(encodeURIComponent(item.content))),
                      sha: item.sha
                    })
                  });
                  
                  if (!updateResponse.ok) {
                    console.error(`Failed to update order for ${item.filename}`);
                  }
                } catch (error) {
                  console.error(`Error updating ${item.filename}:`, error);
                }
              }
              
              console.log(`Successfully shifted ${itemsToUpdate.length} existing items down`);
            }
          } catch (error) {
            console.error('Error shifting existing items down:', error);
          }
        }

        function showBulkUploadModal(category) {
          const existingModal = document.getElementById('bulk-upload-modal');
          if (existingModal) {
            existingModal.remove();
          }

          const modal = document.createElement('div');
          modal.id = 'bulk-upload-modal';
          modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;';
          modal.innerHTML = `
            <div style="background:white;padding:20px;border-radius:8px;width:90%;max-width:800px;max-height:90%;overflow-y:auto;position:relative;">
              <button onclick="document.getElementById('bulk-upload-modal').remove()" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;">&times;</button>
              <h3>Bulk Upload ${category.charAt(0).toUpperCase() + category.slice(1)}</h3>
              <div style="margin-bottom:20px;">
                <label style="display:block;margin-bottom:5px;font-weight:bold;">Select Files:</label>
                <input type="file" id="bulk-files" multiple accept="${category === 'photography' || category === 'portfolio' ? 'image/*' : category === 'videography' ? 'video/*' : '*/*'}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;">
                <small style="color:#666;">You can select multiple files at once. AI will generate titles automatically.</small>
              </div>
              <div id="bulk-preview" style="margin-top:20px;max-height:400px;overflow-y:auto;border:1px solid #ddd;border-radius:4px;padding:10px;display:none;">
                <h4>Preview & Edit Titles:</h4>
                <div style="margin-bottom:15px;padding:10px;background:#f8f9fa;border-radius:4px;border:1px solid #e9ecef;">
                  <label style="display:block;margin-bottom:5px;font-weight:bold;font-size:14px;">Order Placement:</label>
                  <div style="display:flex;gap:15px;align-items:center;">
                    <label style="display:flex;align-items:center;gap:5px;cursor:pointer;">
                      <input type="radio" name="order-placement" value="top" checked style="margin:0;">
                      <span>Add to top (order 1, 2, 3...)</span>
                    </label>
                    <label style="display:flex;align-items:center;gap:5px;cursor:pointer;">
                      <input type="radio" name="order-placement" value="bottom" style="margin:0;">
                      <span>Add to bottom (highest order numbers)</span>
                    </label>
                  </div>
                  <small style="color:#666;font-size:12px;">This determines where new items appear in the list</small>
                </div>
                <div id="bulk-items"></div>
              </div>
              <div style="text-align:right;margin-top:20px;">
                <button type="button" onclick="document.getElementById('bulk-upload-modal').remove()" style="background:#6c757d;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;margin-right:10px;">Cancel</button>
                <button type="button" id="bulk-upload-btn" onclick="processBulkUpload('${category}')" style="background:#28a745;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;display:none;">Upload All</button>
              </div>
            </div>
          `;
          document.body.appendChild(modal);

          // Handle file selection
          document.getElementById('bulk-files').addEventListener('change', async function(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            const preview = document.getElementById('bulk-preview');
            const itemsContainer = document.getElementById('bulk-items');
            const uploadBtn = document.getElementById('bulk-upload-btn');
            
            preview.style.display = 'block';
            uploadBtn.style.display = 'inline-block';
            itemsContainer.innerHTML = '';

            for (let i = 0; i < files.length; i++) {
              const file = files[i];
              const title = await generateAITitle(file, category);
              
              const itemDiv = document.createElement('div');
              itemDiv.style.cssText = 'margin-bottom:15px;padding:15px;border:1px solid #eee;border-radius:8px;background:#fafafa;';
              
              // Create thumbnail for images
              let thumbnailHtml = '';
              if (category === 'photography' || category === 'portfolio') {
                const thumbnailUrl = URL.createObjectURL(file);
                thumbnailHtml = `
                  <div style="flex:0 0 120px;margin-right:15px;">
                    <img src="${thumbnailUrl}" alt="Preview" style="width:120px;height:80px;object-fit:cover;border-radius:4px;border:1px solid #ddd;">
                  </div>
                `;
              }
              
              itemDiv.innerHTML = `
                <div style="display:flex;align-items:flex-start;gap:15px;">
                  ${thumbnailHtml}
                  <div style="flex:1;">
                    <div style="margin-bottom:10px;">
                      <strong style="font-size:14px;color:#333;">${file.name}</strong>
                      <br>
                      <small style="color:#666;">${(file.size / 1024).toFixed(1)} KB</small>
                    </div>
                    <div>
                      <label style="display:block;margin-bottom:5px;font-weight:bold;font-size:12px;color:#555;">AI Generated Title:</label>
                      <input type="text" value="${title}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:14px;" data-file-index="${i}">
                      <small style="color:#888;font-size:11px;">You can edit this title before uploading</small>
                    </div>
                  </div>
                </div>
              `;
              itemsContainer.appendChild(itemDiv);
            }
          });
        }

        async function processBulkUpload(category) {
          const files = Array.from(document.getElementById('bulk-files').files);
          const titleInputs = document.querySelectorAll('#bulk-items input[type="text"]');
          const uploadBtn = document.getElementById('bulk-upload-btn');
          
          // Get order placement preference
          const orderPlacement = document.querySelector('input[name="order-placement"]:checked').value;
          
          uploadBtn.disabled = true;
          uploadBtn.textContent = 'Uploading...';
          
          let successCount = 0;
          let errorCount = 0;

          // Get the appropriate starting order number based on placement preference
          let nextOrder;
          if (orderPlacement === 'top') {
            // For top placement, we need to shift existing items down first
            await shiftExistingItemsDown(category, files.length);
            nextOrder = 1; // Start from 1 for top placement
          } else {
            nextOrder = await getNextOrderNumber(category); // Start from highest + 1 for bottom placement
          }

          for (let i = 0; i < files.length; i++) {
            try {
              const file = files[i];
              const title = titleInputs[i].value.trim() || file.name.replace(/\.[^/.]+$/, "");
              const description = `Uploaded via bulk upload`;
              
              // Create the content based on category
              let content = '';
              if (category === 'poetry') {
                content = `# ${title}\n\n*Uploaded via bulk upload*`;
              } else {
                content = `# ${title}\n\n${description}`;
              }

              // Upload the file and create the content with proper order
              if (category === 'photography') {
                // Upload image first for photography
                const imageFilename = title.toLowerCase().replace(/[^a-z0-9\s]+/g, '').replace(/\s+/g, '-') + '-' + Date.now() + '.' + file.name.split('.').pop();
                const imageResponse = await uploadImage(file, imageFilename);
                if (imageResponse) {
                  const imagePath = `/uploads/${imageFilename}`;
                  await createPhotographyItem(title, description, '', content, imagePath, false, nextOrder);
                } else {
                  throw new Error('Failed to upload image');
                }
              } else if (category === 'portfolio') {
                // Upload image first for portfolio
                const imageFilename = title.toLowerCase().replace(/[^a-z0-9\s]+/g, '').replace(/\s+/g, '-') + '-' + Date.now() + '.' + file.name.split('.').pop();
                const imageResponse = await uploadImage(file, imageFilename);
                if (imageResponse) {
                  const imagePath = `/uploads/${imageFilename}`;
                  await createPortfolioItem(title, description, '', content, imagePath, false, nextOrder);
                } else {
                  throw new Error('Failed to upload image');
                }
              } else if (category === 'poetry') {
                await createPoetryItem(title, description, '', content, false, nextOrder);
              } else if (category === 'videography') {
                // For videos, we need to handle differently
                alert('Video bulk upload not yet implemented. Please use individual upload for videos.');
                continue;
              }
              
              nextOrder++; // Increment order for next item
              successCount++;
            } catch (error) {
              console.error(`Error uploading file ${files[i].name}:`, error);
              errorCount++;
            }
          }

          // Show results
          if (errorCount === 0) {
            alert(`Successfully uploaded ${successCount} files!`);
            document.getElementById('bulk-upload-modal').remove();
            // Reload the appropriate section
            if (category === 'photography') {
              loadPhotographyItems(currentToken);
            } else if (category === 'portfolio') {
              loadPortfolioItems(currentToken);
            } else if (category === 'poetry') {
              loadPoetryItems(currentToken);
            }
          } else {
            alert(`Uploaded ${successCount} files successfully, ${errorCount} failed. Check console for details.`);
          }
        }

        window.deletePortfolioItem = deletePortfolioItem;
        window.deletePoetryItem = deletePoetryItem;
        window.deletePageAndMenu = deletePageAndMenu;
        
        // Expose all required functions for regression testing
        window.showAddPortfolioForm = showAddPortfolioForm;
        window.showAddPageForm = showAddPageForm;
        window.showAddPoetryForm = showAddPoetryForm;
        window.showBulkUploadModal = showBulkUploadModal;
        window.processBulkUpload = processBulkUpload;
        window.getNextOrderNumber = getNextOrderNumber;
        window.loadPortfolioItems = loadPortfolioItems;
        window.loadPages = loadPages;
        window.loadPhotographyItems = loadPhotographyItems;
        window.loadPoetryItems = loadPoetryItems;
        window.createPoetryItem = createPoetryItem;
        window.showAddPhotographyForm = showAddPhotographyForm;
        window.createPhotographyItem = createPhotographyItem;
        window.editPhotographyItem = editPhotographyItem;
        window.updatePhotographyItem = updatePhotographyItem;
        window.showSaveIcon = showSaveIcon;
        window.updatePhotographyOrder = updatePhotographyOrder;
        window.updatePortfolioOrder = updatePortfolioOrder;
        window.updatePoetryOrder = updatePoetryOrder;
        window.updateVideographyOrder = updateVideographyOrder;
        window.deletePhotographyItem = deletePhotographyItem;
        window.showAddVideographyForm = showAddVideographyForm;
        window.toggleVideoInputs = toggleVideoInputs;
        window.uploadVideoFile = uploadVideoFile;
        window.createVideographyItem = createVideographyItem;
        window.loadVideographyItems = loadVideographyItems;
        window.editVideographyItem = editVideographyItem;
        window.updateVideographyItem = updateVideographyItem;
        window.deleteVideographyItem = deleteVideographyItem;
        window.editMainNavigation = editMainNavigation;
        window.addNavItem = addNavItem;
        window.removeNavItem = removeNavItem;
        window.saveMainNavigation = saveMainNavigation;
        window.editSiteSettings = editSiteSettings;
        window.setupButtonListeners = setupButtonListeners;
      })();


    </script>
  </body>
</html>