<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Content Manager (Comprehensive Fix)</title>
    <script>window.CMS_MANUAL_INIT = true;</script>
  </head>
  <body>
    <h3 style="font-family: system-ui; color:#333;">CMS Authentication - Comprehensive Fix</h3>
    <pre id="debug" style="padding:10px;background:#f6f6f6;border:1px solid #ccc;max-height:400px;overflow-y:scroll;"></pre>

    <!-- Try Decap CMS 3.x first (more modern) -->
    <script src="https://unpkg.com/decap-cms@3.6.2/dist/decap-cms.js"></script>

    <script>
      (function () {
        const out = document.getElementById('debug');
        const RELOAD_KEY = 'cms.oauth.reloaded';

        function log(msg, kind) {
          if (kind === 'token') {
            console.log('%c' + msg, 'background:#222;color:#0f0;font-weight:bold;padding:2px 6px;');
          } else if (kind === 'error') {
            console.log('%c' + msg, 'background:#222;color:#f00;font-weight:bold;padding:2px 6px;');
          } else {
            console.log(msg);
          }
          out.textContent += msg + '\n';
          out.scrollTop = out.scrollHeight;
        }

        function extractTokenFromStorage() {
          // Try multiple storage keys and formats
          const keys = ['netlify-cms.oauth', 'decap-cms.oauth', 'cms.oauth'];
          for (const key of keys) {
            const raw = localStorage.getItem(key);
            if (raw) {
              try {
                if (raw[0] === '{') {
                  const obj = JSON.parse(raw);
                  if (obj && obj.token) return obj.token;
                } else {
                  const m = /authorization:github:success:([^:]+)$/.exec(raw);
                  if (m && m[1]) return m[1];
                }
              } catch (e) {
                log('[storage] Error parsing ' + key + ': ' + e.message);
              }
            }
          }
          return null;
        }

        function saveTokenInAllFormats(token) {
          const formats = [
            'authorization:github:success:' + token,
            JSON.stringify({ provider: 'github', type: 'success', token: token }),
            token
          ];
          
          const keys = ['netlify-cms.oauth', 'decap-cms.oauth', 'cms.oauth'];
          
          keys.forEach(key => {
            formats.forEach(format => {
              try {
                localStorage.setItem(key, format);
                log('[storage] Set ' + key + ' = ' + format.substring(0, 50) + '...', 'token');
              } catch (e) {
                log('[storage] Error setting ' + key + ': ' + e.message);
              }
            });
          });
        }

        function attemptAuthentication() {
          const token = extractTokenFromStorage();
          if (!token) {
            log('[auth] No token found in storage');
            return false;
          }

          log('[auth] Found token, attempting comprehensive authentication', 'token');
          
          // Save token in all possible formats
          saveTokenInAllFormats(token);

          // Method 1: PostMessage with all possible formats
          const messages = [
            'authorization:github:success:' + token,
            { provider: 'github', type: 'success', token: token },
            { provider: 'github', token: token },
            { type: 'success', token: token },
            token
          ];

          messages.forEach(msg => {
            try {
              window.postMessage(msg, '*');
              log('[postMessage] Sent: ' + (typeof msg === 'string' ? msg.substring(0, 50) + '...' : JSON.stringify(msg)), 'token');
            } catch (e) {
              log('[postMessage] Error: ' + e.message, 'error');
            }
          });

          // Method 2: Try to access CMS internals directly
          if (window.CMS) {
            try {
              // Try different CMS object structures
              const cmsPaths = [
                'CMS.auth',
                'CMS.backend',
                'CMS.api',
                'CMS.store',
                'CMS.registry'
              ];

              cmsPaths.forEach(path => {
                const obj = path.split('.').reduce((o, p) => o && o[p], window);
                if (obj) {
                  log('[cms] Found ' + path);
                  
                  // Try to set token in various ways
                  if (obj.token !== undefined) {
                    obj.token = token;
                    log('[cms] Set ' + path + '.token = ' + token.substring(0, 20) + '...', 'token');
                  }
                  
                  if (obj.authenticate && typeof obj.authenticate === 'function') {
                    try {
                      obj.authenticate();
                      log('[cms] Called ' + path + '.authenticate()', 'token');
                    } catch (e) {
                      log('[cms] Error calling ' + path + '.authenticate(): ' + e.message, 'error');
                    }
                  }
                  
                  if (obj.isAuthenticated !== undefined) {
                    obj.isAuthenticated = true;
                    log('[cms] Set ' + path + '.isAuthenticated = true', 'token');
                  }
                }
              });
            } catch (e) {
              log('[cms] Error accessing CMS internals: ' + e.message, 'error');
            }
          }

          // Method 3: Dispatch custom events
          const events = [
            'netlify-cms-auth',
            'decap-cms-auth',
            'cms-auth',
            'github-auth',
            'oauth-success'
          ];

          events.forEach(eventName => {
            try {
              const event = new CustomEvent(eventName, {
                detail: { provider: 'github', token: token, type: 'success' }
              });
              window.dispatchEvent(event);
              log('[event] Dispatched ' + eventName, 'token');
            } catch (e) {
              log('[event] Error dispatching ' + eventName + ': ' + e.message, 'error');
            }
          });

          // Method 4: Try to trigger storage events
          try {
            const storageEvent = new StorageEvent('storage', {
              key: 'netlify-cms.oauth',
              newValue: 'authorization:github:success:' + token,
              url: window.location.href
            });
            window.dispatchEvent(storageEvent);
            log('[storage] Dispatched storage event', 'token');
          } catch (e) {
            log('[storage] Error dispatching storage event: ' + e.message, 'error');
          }

          // Method 5: Try to manually trigger GitHub API calls
          try {
            fetch('https://api.github.com/user', {
              headers: {
                'Authorization': 'token ' + token,
                'Accept': 'application/vnd.github.v3+json'
              }
            }).then(response => {
              if (response.ok) {
                log('[api] GitHub API call successful!', 'token');
                return response.json();
              } else {
                log('[api] GitHub API call failed: ' + response.status, 'error');
              }
            }).then(data => {
              if (data) {
                log('[api] GitHub user: ' + data.login, 'token');
              }
            }).catch(e => {
              log('[api] GitHub API error: ' + e.message, 'error');
            });
          } catch (e) {
            log('[api] Error making GitHub API call: ' + e.message, 'error');
          }

          return true;
        }

        function checkAuthenticationStatus() {
          if (window.CMS) {
            const checks = [
              'CMS.auth && CMS.auth.isAuthenticated',
              'CMS.backend && CMS.backend.isAuthenticated',
              'CMS.api && CMS.api.isAuthenticated',
              'CMS.store && CMS.store.isAuthenticated'
            ];

            checks.forEach(check => {
              try {
                const result = eval(check);
                if (result === true) {
                  log('[status] SUCCESS: ' + check + ' = true', 'token');
                } else {
                  log('[status] ' + check + ' = ' + result);
                }
              } catch (e) {
                log('[status] Error checking ' + check + ': ' + e.message, 'error');
              }
            });

            // Try to force authentication state if we have a token
            const token = extractTokenFromStorage();
            if (token) {
              log('[status] Attempting to force authentication state...', 'token');
              
              // Try to set authentication state directly
              try {
                if (window.CMS.auth) {
                  window.CMS.auth.isAuthenticated = true;
                  log('[status] Set CMS.auth.isAuthenticated = true', 'token');
                }
                if (window.CMS.backend) {
                  window.CMS.backend.isAuthenticated = true;
                  log('[status] Set CMS.backend.isAuthenticated = true', 'token');
                }
                if (window.CMS.api) {
                  window.CMS.api.isAuthenticated = true;
                  log('[status] Set CMS.api.isAuthenticated = true', 'token');
                }
                if (window.CMS.store) {
                  window.CMS.store.isAuthenticated = true;
                  log('[status] Set CMS.store.isAuthenticated = true', 'token');
                }
                
                // Try to trigger a state change event
                if (window.CMS.store && window.CMS.store.dispatch) {
                  try {
                    window.CMS.store.dispatch({ type: 'AUTH_SUCCESS', token: token });
                    log('[status] Dispatched AUTH_SUCCESS action', 'token');
                  } catch (e) {
                    log('[status] Error dispatching AUTH_SUCCESS: ' + e.message, 'error');
                  }
                }
                
                // Try to call any authentication success callbacks
                if (window.CMS.auth && window.CMS.auth.onAuthSuccess) {
                  try {
                    window.CMS.auth.onAuthSuccess(token);
                    log('[status] Called CMS.auth.onAuthSuccess', 'token');
                  } catch (e) {
                    log('[status] Error calling onAuthSuccess: ' + e.message, 'error');
                  }
                }
                
              } catch (e) {
                log('[status] Error forcing auth state: ' + e.message, 'error');
              }
            }
          }
        }

        // Clear reload flag on fresh page load
        if (performance.navigation.type === 0) {
          sessionStorage.removeItem(RELOAD_KEY);
        }

        // Listen for OAuth popup messages
        window.addEventListener('message', (e) => {
          const m = e.data;
          log('[message] Received: ' + (typeof m === 'string' ? m.substring(0, 100) + '...' : JSON.stringify(m)));
          
          let saved = false;
          try {
            if (typeof m === 'string' && m.startsWith('authorization:github:success:')) {
              const token = m.replace('authorization:github:success:', '');
              saveTokenInAllFormats(token);
              saved = true;
            } else if (m && typeof m === 'object' && m.provider === 'github' && m.type === 'success' && m.token) {
              saveTokenInAllFormats(m.token);
              saved = true;
            }
          } catch (err) {
            log('[message] Error processing message: ' + err.message, 'error');
          }

          if (saved && !sessionStorage.getItem(RELOAD_KEY)) {
            sessionStorage.setItem(RELOAD_KEY, '1');
            log('[message] Token saved, reloading page...', 'token');
            setTimeout(() => location.reload(), 150);
          }
        });

        // Handle URL token fallback
        try {
          const hash = location.hash || '';
          const qIndex = hash.indexOf('?');
          let urlToken = null;
          if (qIndex !== -1) {
            const qs = hash.slice(qIndex + 1);
            const hp = new URLSearchParams(qs);
            urlToken = hp.get('token');
          }
          const qpToken = new URLSearchParams(location.search).get('token');
          if (qpToken && !urlToken) urlToken = qpToken;

          if (urlToken) {
            saveTokenInAllFormats(urlToken);
            log('[url] TOKEN STORED: ' + urlToken, 'token');
            history.replaceState(null, '', location.pathname + '#/');
            if (!sessionStorage.getItem(RELOAD_KEY)) {
              sessionStorage.setItem(RELOAD_KEY, '1');
              setTimeout(() => location.reload(), 150);
            }
            return;
          }
        } catch (e) {
          log('[url] Error parsing URL token: ' + e.message, 'error');
        }

        // Boot CMS with comprehensive authentication
        function boot() {
          if (typeof window.CMS !== 'object') {
            log('[boot] CMS not present yet, retrying...');
            return setTimeout(boot, 100);
          }
          
          log('[boot] CMS present, calling CMS.init()');
          CMS.init({ config: '/admin/config.yml' });

          // Try authentication immediately and multiple times
          const attempts = [500, 1000, 2000, 3000, 5000];
          attempts.forEach((delay, index) => {
            setTimeout(() => {
              log('[boot] Authentication attempt ' + (index + 1) + ' (delay: ' + delay + 'ms)');
              attemptAuthentication();
              checkAuthenticationStatus();
            }, delay);
          });

          // Final check after all attempts
          setTimeout(() => {
            log('[boot] Final authentication status check');
            checkAuthenticationStatus();
            
            // Check for GitHub API calls
            if (window.performance && window.performance.getEntriesByType) {
              const networkEntries = window.performance.getEntriesByType('resource');
              const githubCalls = networkEntries.filter(entry => 
                entry.name.includes('api.github.com')
              );
              if (githubCalls.length > 0) {
                log('[boot] SUCCESS: Found ' + githubCalls.length + ' GitHub API calls!', 'token');
                githubCalls.forEach(call => log('[boot] GitHub API: ' + call.name, 'token'));
                
                // If we have API calls but CMS isn't authenticated, try to force UI update
                const token = extractTokenFromStorage();
                if (token) {
                  log('[boot] API calls working but CMS not authenticated - forcing UI update', 'token');
                  
                  // Try to trigger a page refresh to force CMS to re-evaluate auth state
                  setTimeout(() => {
                    log('[boot] Attempting to force CMS UI refresh...', 'token');
                    
                    // Try to dispatch a custom event that might trigger UI update
                    const refreshEvent = new CustomEvent('cms-auth-refresh', {
                      detail: { token: token, authenticated: true }
                    });
                    window.dispatchEvent(refreshEvent);
                    
                    // Try to trigger a React re-render if CMS uses React
                    if (window.CMS && window.CMS.store && window.CMS.store.getState) {
                      try {
                        const state = window.CMS.store.getState();
                        log('[boot] CMS store state: ' + JSON.stringify(state).substring(0, 200) + '...');
                      } catch (e) {
                        log('[boot] Error getting CMS store state: ' + e.message);
                      }
                    }
                    
                    // Last resort: try to reload the page to force fresh auth check
                    setTimeout(() => {
                      log('[boot] Last resort: reloading page to force fresh auth check', 'token');
                      location.reload();
                    }, 2000);
                    
                  }, 1000);
                }
              } else {
                log('[boot] No GitHub API calls found - CMS not making authenticated requests', 'error');
              }
            }
          }, 6000);
        }

        // Start booting
        setTimeout(boot, 100);
      })();
    </script>
  </body>
</html>