<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Content Manager (Custom Auth)</title>
  </head>
  <body>
    <h3 style="font-family: system-ui; color:#333;">CMS Authentication - Custom Implementation</h3>
    <pre id="debug" style="padding:10px;background:#f6f6f6;border:1px solid #ccc;max-height:400px;overflow-y:scroll;"></pre>

    <div id="login-section" style="text-align:center;margin:20px;">
      <h4>Login with GitHub</h4>
      <button id="login-btn" style="background:#333;color:white;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;">
        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDBDNS4zNzQgMCAwIDUuMzc0IDAgMTJjMCA1LjMwMiAzLjQzOCA5LjggOC4yMDcgMTEuMzg3LjYuMTExLjgyOS0uMjYxLjgyOS0uNTc3di0yLjIzNGMtMy4zMzguNzI2LTQuMDMzLTEuNDE2LTQuMDMzLTEuNDE2LS41NDYtMS4zODctMS4zMzMtMS43NTYtMS4zMzMtMS43NTYtMS4wODktLjc0NS4wODMtLjcyOS4wODMtLjcyOSAxLjIwNS4wODQgMS44MzggMS4yMzcgMS44MzggMS4yMzcgMS4wNyAxLjgzNCAyLjc3NyAxLjMwNCAzLjQ1Mi45OTcuMTA3LS43NzYuNDE1LTEuMzA1Ljc1NS0xLjYwNS0Mi42NjUtLjMwNS01LjQ2Ni0xLjMzNC01LjQ2Ni01LjkzMSAwLTEuMzExLjQ2OS0yLjM4MSAxLjIzNi0zLjIyMS0uMTI0LS4zMDUtLjUzNS0xLjUyNC4xMTctMy4xNzYgMCAwIDEuMDA4LS4zMjIgMy4zMDEgMS4yMy45NTctLjI2NiAxLjk4My0uMzk5IDMuMDAzLS40MDQgMS4wMi4wMDUgMi4wNDcuMTM4IDMuMDA2LjQwNCAyLjI5LTEuNTUyIDMuMjk3LTEuMjMgMy4yOTctMS4yMy42NTMgMS42NTIuMjQyIDIuODcuMTE4IDMuMTc2LjkyLjg0IDEuMjM1IDEuOTExIDEuMjM1IDMuMjIxIDAgNC42MDktMi44MDcgNS42MjQtNS40NzkgNS45MjEuNDI5LjM2OS44MTEuMS4xMS0uODA4LjEwOC0uODM0LjEwOC0xLjczNSAwLTEuNjA1LS4wMTUtMi45MzUtLjAxNS01LjMzNHYtMi4yNDZjMC0uMzE1LjE5OS0uNjg4LjgyOS0uNTc3QzIwLjU2MiAyMS43OTcgMjQgMTcuMzAyIDI0IDEyYzAtNi42MjYtNS4zNzQtMTItMTItMTJ6IiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K" style="width:20px;height:20px;margin-right:8px;vertical-align:middle;">
        Login with GitHub
      </button>
    </div>

    <div id="cms-interface" style="display:none;">
      <h4>Content Management System</h4>
      <div id="collections">
        <h5>Collections</h5>
        <div id="portfolio-section">
          <h6>Portfolio</h6>
          <button id="add-portfolio" style="background:#007cba;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;margin:5px;">Add New Portfolio Item</button>
          <div id="portfolio-list"></div>
        </div>
        <div id="pages-section">
          <h6>Pages</h6>
          <button id="edit-about" style="background:#007cba;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;margin:5px;">Edit About</button>
          <button id="edit-contact" style="background:#007cba;color:white;border:none;padding:8px 16px;border-radius:3px;cursor:pointer;margin:5px;">Edit Contact</button>
        </div>
      </div>
    </div>

    <script>
      (function () {
        const out = document.getElementById('debug');
        const loginSection = document.getElementById('login-section');
        const cmsInterface = document.getElementById('cms-interface');
        const loginBtn = document.getElementById('login-btn');
        const portfolioList = document.getElementById('portfolio-list');

        let currentToken = null;
        let isLoading = false;
        let isAuthenticated = false;

        function log(msg, kind) {
          if (kind === 'token') {
            console.log('%c' + msg, 'background:#222;color:#0f0;font-weight:bold;padding:2px 6px;');
          } else if (kind === 'error') {
            console.log('%c' + msg, 'background:#222;color:#f00;font-weight:bold;padding:2px 6px;');
          } else {
            console.log(msg);
          }
          out.textContent += msg + '\n';
          out.scrollTop = out.scrollHeight;
        }

        function extractTokenFromStorage() {
          const keys = ['netlify-cms.oauth', 'decap-cms.oauth', 'cms.oauth'];
          log('[storage] Starting token extraction...');
          
          for (const key of keys) {
            const raw = localStorage.getItem(key);
            log('[storage] Checking ' + key + ': ' + (raw ? 'found' : 'not found'));
            
            if (raw) {
              log('[storage] Found token in ' + key + ': ' + raw.substring(0, 50) + '...');
              try {
                // Try JSON format first
                if (raw[0] === '{') {
                  const obj = JSON.parse(raw);
                  if (obj && obj.token) {
                    log('[storage] Extracted token from JSON: ' + obj.token.substring(0, 20) + '...');
                    return obj.token;
                  }
                } 
                // Try string format
                else {
                  const m = /authorization:github:success:([^:]+)$/.exec(raw);
                  if (m && m[1]) {
                    log('[storage] Extracted token from string: ' + m[1].substring(0, 20) + '...');
                    return m[1];
                  }
                  // Try direct token format
                  else if (raw.startsWith('gho_')) {
                    log('[storage] Extracted direct token: ' + raw.substring(0, 20) + '...');
                    return raw;
                  }
                }
              } catch (e) {
                log('[storage] Error parsing ' + key + ': ' + e.message, 'error');
              }
            }
          }
          
          log('[storage] No valid token found in any storage key', 'error');
          return null;
        }

        function saveTokenInAllFormats(token) {
          const formats = [
            'authorization:github:success:' + token,
            JSON.stringify({ provider: 'github', type: 'success', token: token }),
            token
          ];
          
          const keys = ['netlify-cms.oauth', 'decap-cms.oauth', 'cms.oauth'];
          
          keys.forEach(key => {
            formats.forEach(format => {
              try {
                localStorage.setItem(key, format);
                log('[storage] Set ' + key + ' = ' + format.substring(0, 50) + '...', 'token');
              } catch (e) {
                log('[storage] Error setting ' + key + ': ' + e.message, 'error');
              }
            });
          });
        }

        async function testGitHubAPI(token) {
          try {
            log('[api] Testing GitHub API with token...', 'token');
            const response = await fetch('https://api.github.com/user', {
              headers: {
                'Authorization': 'token ' + token,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            if (response.ok) {
              const user = await response.json();
              log('[api] GitHub API successful! User: ' + user.login, 'token');
              return user;
            } else {
              log('[api] GitHub API failed: ' + response.status, 'error');
              return null;
            }
          } catch (e) {
            log('[api] GitHub API error: ' + e.message, 'error');
            return null;
          }
        }

        async function loadPortfolioItems(token) {
          if (isLoading) {
            log('[api] Already loading portfolio items, skipping...', 'token');
            return;
          }
          
          isLoading = true;
          try {
            log('[api] Loading portfolio items...', 'token');
            const response = await fetch('https://api.github.com/repos/oos/omarosullivan.com/contents/content/portfolio', {
              headers: {
                'Authorization': 'token ' + token,
                'Accept': 'application/vnd.github.v3+json'
              }
            });

            if (response.ok) {
              const items = await response.json();
              log('[api] Loaded ' + items.length + ' portfolio items', 'token');
              
              portfolioList.innerHTML = '';
              items.forEach(item => {
                if (item.name.endsWith('.md')) {
                  const div = document.createElement('div');
                  div.style.cssText = 'border:1px solid #ddd;padding:10px;margin:5px;border-radius:3px;';
                  div.innerHTML = `
                    <strong>${item.name}</strong>
                    <button onclick="editFile('${item.name}', '${item.sha}')" style="float:right;background:#007cba;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;">Edit</button>
                  `;
                  portfolioList.appendChild(div);
                }
              });
              
              return items;
            } else {
              log('[api] Failed to load portfolio items: ' + response.status, 'error');
              return [];
            }
                      } catch (e) {
            log('[api] Error loading portfolio items: ' + e.message, 'error');
            return [];
          } finally {
            isLoading = false;
          }
        }

        async function authenticate() {
          if (isAuthenticated) {
            log('[auth] Already authenticated, skipping...', 'token');
            return true;
          }
          
          const token = extractTokenFromStorage();
          if (!token) {
            log('[auth] No token found in storage', 'error');
            return false;
          }

          log('[auth] Found token, testing authentication...', 'token');
          const user = await testGitHubAPI(token);
          
          if (user) {
            currentToken = token;
            isAuthenticated = true;
            log('[auth] Authentication successful! Welcome ' + user.login, 'token');
            
            // Hide login section and show CMS interface
            loginSection.style.display = 'none';
            cmsInterface.style.display = 'block';
            
            // Load portfolio items only if not already loaded
            if (!isLoading) {
              await loadPortfolioItems(token);
            }
            
            return true;
          } else {
            log('[auth] Authentication failed', 'error');
            return false;
          }
        }

        // Listen for OAuth popup messages
        window.addEventListener('message', (e) => {
          const m = e.data;
          
          // Filter out non-OAuth messages to reduce noise
          if (typeof m === 'string' && m.startsWith('authorization:github:success:')) {
            log('[message] OAuth success message received', 'token');
          } else if (m && typeof m === 'object' && m.provider === 'github' && m.type === 'success') {
            log('[message] OAuth success object received', 'token');
          } else {
            // Skip logging non-OAuth messages to reduce noise
            return;
          }
          
          let saved = false;
          try {
            if (typeof m === 'string' && m.startsWith('authorization:github:success:')) {
              const token = m.replace('authorization:github:success:', '');
              saveTokenInAllFormats(token);
              saved = true;
            } else if (m && typeof m === 'object' && m.provider === 'github' && m.type === 'success' && m.token) {
              saveTokenInAllFormats(m.token);
              saved = true;
            }
          } catch (err) {
            log('[message] Error processing message: ' + err.message, 'error');
          }

          if (saved && !isAuthenticated) {
            log('[message] Token saved, attempting authentication...', 'token');
            
            // Single authentication attempt
            setTimeout(() => {
              if (!isAuthenticated) {
                authenticate();
              }
            }, 100);
          }
        });

        // Handle URL token fallback
        try {
          const hash = location.hash || '';
          const qIndex = hash.indexOf('?');
          let urlToken = null;
          if (qIndex !== -1) {
            const qs = hash.slice(qIndex + 1);
            const hp = new URLSearchParams(qs);
            urlToken = hp.get('token');
          }
          const qpToken = new URLSearchParams(location.search).get('token');
          if (qpToken && !urlToken) urlToken = qpToken;

          if (urlToken) {
            saveTokenInAllFormats(urlToken);
            log('[url] TOKEN STORED: ' + urlToken, 'token');
            history.replaceState(null, '', location.pathname + '#/');
            setTimeout(() => {
              if (!isAuthenticated) {
                authenticate();
              }
            }, 100);
            return;
          }
        } catch (e) {
          log('[url] Error parsing URL token: ' + e.message, 'error');
        }

        // Login button click handler
        loginBtn.addEventListener('click', () => {
          log('[login] Opening OAuth popup...');
          const popup = window.open(
            'https://decap-oauth.netlify.app/oauth/authorize?site_id=omarosullivan.netlify.app',
            'github-oauth',
            'width=600,height=600,scrollbars=yes,resizable=yes'
          );
        });

        // Add portfolio button handler
        document.getElementById('add-portfolio').addEventListener('click', () => {
          if (currentToken) {
            log('[cms] Add portfolio item clicked');
            // TODO: Implement add portfolio functionality
            alert('Add portfolio functionality would be implemented here');
          }
        });

        // Edit buttons handlers
        document.getElementById('edit-about').addEventListener('click', () => {
          if (currentToken) {
            log('[cms] Edit about clicked');
            // TODO: Implement edit about functionality
            alert('Edit about functionality would be implemented here');
          }
        });

        document.getElementById('edit-contact').addEventListener('click', () => {
          if (currentToken) {
            log('[cms] Edit contact clicked');
            // TODO: Implement edit contact functionality
            alert('Edit contact functionality would be implemented here');
          }
        });

        // Global function for editing files
        window.editFile = function(filename, sha) {
          if (currentToken) {
            log('[cms] Edit file clicked: ' + filename);
            // TODO: Implement file editing functionality
            alert('Edit file functionality would be implemented here for: ' + filename);
          }
        };

        // Try to authenticate on page load
        setTimeout(() => {
          if (!isAuthenticated) {
            log('[boot] Attempting initial authentication...');
            authenticate();
          } else {
            log('[boot] Already authenticated, skipping initial auth');
          }
        }, 500);
      })();
    </script>
  </body>
</html>