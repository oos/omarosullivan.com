<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Content Manager (Debug)</title>
    <script>window.CMS_MANUAL_INIT = true;</script>
  </head>
  <body>
    <h3 style="font-family: system-ui; color:#333;">Decap CMS Debug Mode</h3>
    <pre id="debug" style="padding:10px;background:#f6f6f6;border:1px solid #ccc;"></pre>

    <!-- Classic Netlify CMS bundle (v2) -->
    <script src="https://unpkg.com/netlify-cms@2.10.192/dist/netlify-cms.js?v=2"></script>

    <script>
      (function () {
        const KEY = 'netlify-cms.oauth';
        const out = document.getElementById('debug');

        function log(msg, kind) {
          if (kind === 'token') {
            console.log('%c' + msg, 'background:#222;color:#0f0;font-weight:bold;padding:2px 6px;');
          } else {
            console.log(msg);
          }
          out.textContent += msg + '\n';
        }

        function saveTokenFromMessage(msg) {
          try {
            if (typeof msg === 'string' && msg.startsWith('authorization:github:success:')) {
              localStorage.setItem(KEY, msg);
              log('[admin] saved string token', 'token');
              return true;
            }
            if (msg && typeof msg === 'object' && msg.provider === 'github' && msg.type === 'success' && msg.token) {
              localStorage.setItem(KEY, JSON.stringify(msg));
              log('[admin] saved object token', 'token');
              return true;
            }
          } catch (e) {
            log('[admin] failed to save token: ' + e.message);
          }
          return false;
        }

        function extractTokenFromStorage() {
          const raw = localStorage.getItem(KEY);
          if (!raw) return null;
          try {
            if (raw[0] === '{') {
              const obj = JSON.parse(raw);
              return obj && obj.token ? obj.token : null;
            } else {
              const m = /authorization:github:success:([^:]+)$/.exec(raw);
              return m && m[1] ? m[1] : null;
            }
          } catch (e) {
            return null;
          }
        }

        function replayTokenToCMS() {
          const token = extractTokenFromStorage();
          if (!token) return false;
          
          // Try multiple approaches to authenticate the CMS
          log('[admin] attempting to authenticate CMS with token', 'token');
          
          // Method 1: PostMessage (original approach)
          window.postMessage('authorization:github:success:' + token, '*');
          window.postMessage({ provider: 'github', type: 'success', token }, '*');
          
          // Method 2: Try to directly set the token in CMS if available
          if (window.CMS && window.CMS.auth) {
            try {
              // Try to manually set the token
              if (window.CMS.auth.token) {
                window.CMS.auth.token = token;
                log('[admin] manually set CMS.auth.token', 'token');
              }
              // Try to trigger authentication
              if (typeof window.CMS.auth.authenticate === 'function') {
                window.CMS.auth.authenticate();
                log('[admin] called CMS.auth.authenticate()', 'token');
              }
            } catch (e) {
              log('[admin] error in manual auth: ' + e.message);
            }
          }
          
          // Method 3: Try to trigger a custom event
          try {
            const event = new CustomEvent('netlify-cms-auth', { 
              detail: { provider: 'github', token: token } 
            });
            window.dispatchEvent(event);
            log('[admin] dispatched netlify-cms-auth event', 'token');
          } catch (e) {
            log('[admin] error dispatching event: ' + e.message);
          }
          
          // Check if CMS is now authenticated
          setTimeout(() => {
            if (window.CMS && window.CMS.auth && window.CMS.auth.isAuthenticated) {
              log('[admin] CMS is now authenticated!', 'token');
            } else {
              log('[admin] CMS still not authenticated after token replay');
              // Try one more time with a longer delay
              setTimeout(() => {
                if (window.CMS && window.CMS.auth && window.CMS.auth.isAuthenticated) {
                  log('[admin] CMS authenticated on second check!', 'token');
                } else {
                  log('[admin] CMS still not authenticated on second check');
                }
              }, 1000);
            }
          }, 200);
          
          return true;
        }

        // 1) Save token from OAuth popup, then reload once to cleanly bootstrap
        const RELOAD_KEY = 'cms.oauth.reloaded';
        window.addEventListener('message', (e) => {
          const m = e.data;
          log('[message] ' + (typeof m === 'string' ? m : JSON.stringify(m)));
          const saved = saveTokenFromMessage(m);
          if (saved && !sessionStorage.getItem(RELOAD_KEY)) {
            sessionStorage.setItem(RELOAD_KEY, '1');
            setTimeout(() => location.reload(), 150);
          }
        });

        // ✅ Robust fallback: read token from the URL when you're at #/oauth?token=...
        try {
          const hash = location.hash || '';              // e.g. "#/oauth?token=gho_xxx"
          const qIndex = hash.indexOf('?');
          let urlToken = null;
          if (qIndex !== -1) {
            const qs = hash.slice(qIndex + 1);           // "token=gho_xxx"
            const hp = new URLSearchParams(qs);
            urlToken = hp.get('token');
          }
          // Also support ?token=... in the real query (rare)
          const qpToken = new URLSearchParams(location.search).get('token');
          if (qpToken && !urlToken) urlToken = qpToken;

          if (urlToken) {
            localStorage.setItem(KEY, 'authorization:github:success:' + urlToken);
            log('[url] TOKEN STORED: ' + urlToken, 'token');
            // clean URL so it doesn't re-trigger
            history.replaceState(null, '', location.pathname + '#/');
            if (!sessionStorage.getItem(RELOAD_KEY)) {
              sessionStorage.setItem(RELOAD_KEY, '1');
              setTimeout(() => location.reload(), 150);
            }
            return;
          }
        } catch (e) {
          log('[url parse error] ' + e.message);
        }

        // Clear reload flag on fresh page load (not from reload)
        if (performance.navigation.type === 0) { // TYPE_NAVIGATE (fresh load)
          sessionStorage.removeItem(RELOAD_KEY);
        }

        // 2) Boot CMS and wait for it to be fully ready before attempting auth
        (function boot() {
          if (typeof window.CMS !== 'object') {
            log('[admin] CMS not present yet, retrying…');
            return setTimeout(boot, 100);
          }
          log('[admin] CMS present, calling CMS.init()');
          CMS.init({ config: '/admin/config.yml' });

          // Wait for CMS to be fully initialized and ready
          function waitForCMSReady() {
            if (window.CMS && window.CMS.auth && window.CMS.auth.isAuthenticated !== undefined) {
              log('[admin] CMS auth system is ready');
              
              // Check if we have a token to use
              const token = extractTokenFromStorage();
              if (token) {
                log('[admin] Found stored token, attempting authentication', 'token');
                
                // Try to authenticate using CMS's internal method
                if (window.CMS.auth.authenticate) {
                  try {
                    // Set the token first
                    window.CMS.auth.token = token;
                    // Then authenticate
                    window.CMS.auth.authenticate();
                    log('[admin] Called CMS.auth.authenticate() with token', 'token');
                  } catch (e) {
                    log('[admin] Error calling CMS.auth.authenticate(): ' + e.message);
                  }
                }
                
                // Also try the postMessage approach
                window.postMessage('authorization:github:success:' + token, '*');
                window.postMessage({ provider: 'github', type: 'success', token }, '*');
                log('[admin] Sent postMessage with token', 'token');
                
                // Check authentication status after a delay
                setTimeout(() => {
                  if (window.CMS.auth.isAuthenticated) {
                    log('[admin] SUCCESS: CMS is now authenticated!', 'token');
                  } else {
                    log('[admin] CMS still not authenticated, trying alternative approach');
                    // Try to manually trigger the auth flow
                    try {
                      if (window.CMS.auth.login) {
                        window.CMS.auth.login();
                        log('[admin] Called CMS.auth.login()');
                      }
                    } catch (e) {
                      log('[admin] Error calling CMS.auth.login(): ' + e.message);
                    }
                  }
                }, 1000);
              } else {
                log('[admin] No stored token found');
              }
            } else {
              log('[admin] CMS auth system not ready yet, retrying...');
              setTimeout(waitForCMSReady, 200);
            }
          }
          
          // Start waiting for CMS to be ready
          setTimeout(waitForCMSReady, 1000);
        })();
      })();
    </script>
  </body>
</html>