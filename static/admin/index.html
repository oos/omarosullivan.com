<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Content Manager</title>
    <script>window.CMS_MANUAL_INIT = true;</script>
  </head>
  <body>
    <!-- Classic Netlify CMS bundle (v2) -->
    <script src="https://unpkg.com/netlify-cms@2.10.192/dist/netlify-cms.js?v=2"></script>

    <script>
      (function () {
        const KEY = 'netlify-cms.oauth';

        function saveTokenFromMessage(msg) {
          try {
            if (typeof msg === 'string' && msg.startsWith('authorization:github:success:')) {
              localStorage.setItem(KEY, msg);
              console.log('[admin] saved string token');
              return true;
            }
            if (msg && typeof msg === 'object' && msg.provider === 'github' && msg.type === 'success' && msg.token) {
              localStorage.setItem(KEY, JSON.stringify(msg));
              console.log('[admin] saved object token');
              return true;
            }
          } catch (e) {
            console.warn('[admin] failed to save token', e);
          }
          return false;
        }

        function extractTokenFromStorage() {
          const raw = localStorage.getItem(KEY);
          if (!raw) return null;
          try {
            if (raw[0] === '{') {
              const obj = JSON.parse(raw);
              return obj && obj.token ? obj.token : null;
            } else {
              const m = /authorization:github:success:([^:]+)$/.exec(raw);
              return m && m[1] ? m[1] : null;
            }
          } catch (e) {
            return null;
          }
        }

        function replayTokenToCMS() {
          const token = extractTokenFromStorage();
          if (!token) return false;
          window.postMessage('authorization:github:success:' + token, '*');
          window.postMessage({ provider: 'github', type: 'success', token }, '*');
          console.log('[admin] replayed token to CMS');
          return true;
        }

        // 1) Save token from OAuth popup, then reload once to cleanly bootstrap
        window.addEventListener('message', (e) => {
          const saved = saveTokenFromMessage(e.data);
          if (saved) setTimeout(() => location.reload(), 150);
        });

        // 2) Boot CMS, then replay AFTER init to guarantee CMS listener is attached
        (function boot() {
          if (typeof window.CMS !== 'object') {
            return setTimeout(boot, 100);
          }
          console.log('[admin] CMS present, calling CMS.init()');
          CMS.init({ config: '/admin/config.yml' });

          // Give CMS a moment to attach its internal listeners, then replay token
          setTimeout(() => {
            const replayed = replayTokenToCMS();
            if (!replayed) console.log('[admin] no token to replay (yet)');
          }, 300);
        })();
      })();
    </script>
  </body>
</html>