<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Content Manager</title>
    <script>
      // Prevent auto-init; we’ll init after token handling
      window.CMS_MANUAL_INIT = true;
    </script>
  </head>
  <body>
    <!-- Use the classic Netlify CMS bundle -->
    <script src="https://unpkg.com/netlify-cms@2.10.192/dist/netlify-cms.js"></script>

    <script>
      (function () {
        const KEY = 'netlify-cms.oauth';

        function saveAndReload(tokenStr) {
          try {
            localStorage.setItem(KEY, tokenStr);
            console.log('[oauth] token stored:', tokenStr.slice(0, 40) + '…');
            location.reload();
          } catch (e) {
            console.warn('[oauth] failed to save token', e);
          }
        }

        // Listen for BOTH formats the popup may send
        window.addEventListener('message', (e) => {
          const m = e.data;
          if (typeof m === 'string' && m.startsWith('authorization:github:success:')) {
            saveAndReload(m);
          } else if (m && typeof m === 'object' && m.provider === 'github' && m.type === 'success' && m.token) {
            saveAndReload(`authorization:github:success:${m.token}`);
          }
        });

        // Fallback: if token arrives via URL hash or query (?token=…)
        try {
          const hashParams = new URLSearchParams(location.hash.replace(/^#\/?/, ''));
          const queryParams = new URLSearchParams(location.search);
          const urlToken = hashParams.get('token') || queryParams.get('token');
          if (urlToken) {
            saveAndReload(`authorization:github:success:${urlToken}`);
            history.replaceState(null, '', location.pathname + '#/');
            return; // reload happens in saveAndReload
          }
        } catch (e) {}

        // Boot CMS once it’s available
        function boot() {
          if (typeof window.CMS !== 'object') {
            console.warn('[admin] CMS not present yet, retrying…');
            return setTimeout(boot, 120);
          }
          console.log('[admin] CMS present, calling CMS.init()');
          CMS.init({ config: '/admin/config.yml' });
        }
        boot();
      })();
    </script>
  </body>
</html>
