<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Content Manager</title>

    <!-- Tell Decap not to auto-start; we'll start it after token is set -->
    <script>
      window.CMS_MANUAL_INIT = true;
    </script>
  </head>
  <body>
    <!-- Decap CMS -->
    <script src="https://unpkg.com/decap-cms@3.8.3/dist/decap-cms.js"></script>

    <script>
      (function () {
        const SAVE_KEY = 'netlify-cms.oauth';

        function tokenInStorage() {
          const v = localStorage.getItem(SAVE_KEY);
          return typeof v === 'string' && v.startsWith('authorization:github:success:');
        }

        function storeFromMessage(d) {
          if (typeof d === 'string' && d.startsWith('authorization:github:success:')) {
            localStorage.setItem(SAVE_KEY, d);
            return true;
          }
          if (d && typeof d === 'object' && d.provider === 'github' && d.type === 'success' && d.token) {
            localStorage.setItem(SAVE_KEY, 'authorization:github:success:' + String(d.token).trim());
            return true;
          }
          return false;
        }

        function startCMS() {
          // Give the app a tick with token present, then init
          if (!window.CMS || typeof window.CMS.init !== 'function') {
            console.warn('CMS not ready yet; retrying…');
            return void setTimeout(startCMS, 50);
          }
          console.log('Starting CMS (manual init)…');
          window.CMS.init(); // will load /admin/config.yml automatically
        }

        // 1) If a token is already saved (from a previous popup), start CMS now
        if (tokenInStorage()) {
          startCMS();
        }

        // 2) Also listen for the popup message, store the token, then start CMS
        window.addEven
