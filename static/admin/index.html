<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Content Manager (Debug)</title>
    <script>window.CMS_MANUAL_INIT = true;</script>
  </head>
  <body>
    <h3 style="font-family: system-ui; color:#333;">Decap CMS Debug Mode</h3>
    <pre id="debug" style="padding:10px;background:#f6f6f6;border:1px solid #ccc;"></pre>

    <!-- Classic Netlify CMS bundle (v2) -->
    <script src="https://unpkg.com/netlify-cms@2.10.192/dist/netlify-cms.js?v=2"></script>

    <script>
      (function () {
        const KEY = 'netlify-cms.oauth';
        const out = document.getElementById('debug');

        function log(msg, kind) {
          if (kind === 'token') {
            console.log('%c' + msg, 'background:#222;color:#0f0;font-weight:bold;padding:2px 6px;');
          } else {
            console.log(msg);
          }
          out.textContent += msg + '\n';
        }

        function saveTokenFromMessage(msg) {
          try {
            if (typeof msg === 'string' && msg.startsWith('authorization:github:success:')) {
              localStorage.setItem(KEY, msg);
              log('[admin] saved string token', 'token');
              return true;
            }
            if (msg && typeof msg === 'object' && msg.provider === 'github' && msg.type === 'success' && msg.token) {
              localStorage.setItem(KEY, JSON.stringify(msg));
              log('[admin] saved object token', 'token');
              return true;
            }
          } catch (e) {
            log('[admin] failed to save token: ' + e.message);
          }
          return false;
        }

        function extractTokenFromStorage() {
          const raw = localStorage.getItem(KEY);
          if (!raw) return null;
          try {
            if (raw[0] === '{') {
              const obj = JSON.parse(raw);
              return obj && obj.token ? obj.token : null;
            } else {
              const m = /authorization:github:success:([^:]+)$/.exec(raw);
              return m && m[1] ? m[1] : null;
            }
          } catch (e) {
            return null;
          }
        }

        function replayTokenToCMS() {
          const token = extractTokenFromStorage();
          if (!token) return false;
          window.postMessage('authorization:github:success:' + token, '*');
          window.postMessage({ provider: 'github', type: 'success', token }, '*');
          log('[admin] replayed token to CMS', 'token');
          
          // Check if CMS is now authenticated
          setTimeout(() => {
            if (window.CMS && window.CMS.auth && window.CMS.auth.isAuthenticated) {
              log('[admin] CMS is now authenticated!', 'token');
            } else {
              log('[admin] CMS still not authenticated after token replay');
            }
          }, 100);
          
          return true;
        }

        // 1) Save token from OAuth popup, then reload once to cleanly bootstrap
        const RELOAD_KEY = 'cms.oauth.reloaded';
        window.addEventListener('message', (e) => {
          const m = e.data;
          log('[message] ' + (typeof m === 'string' ? m : JSON.stringify(m)));
          const saved = saveTokenFromMessage(m);
          if (saved && !sessionStorage.getItem(RELOAD_KEY)) {
            sessionStorage.setItem(RELOAD_KEY, '1');
            setTimeout(() => location.reload(), 150);
          }
        });

        // ✅ Robust fallback: read token from the URL when you're at #/oauth?token=...
        try {
          const hash = location.hash || '';              // e.g. "#/oauth?token=gho_xxx"
          const qIndex = hash.indexOf('?');
          let urlToken = null;
          if (qIndex !== -1) {
            const qs = hash.slice(qIndex + 1);           // "token=gho_xxx"
            const hp = new URLSearchParams(qs);
            urlToken = hp.get('token');
          }
          // Also support ?token=... in the real query (rare)
          const qpToken = new URLSearchParams(location.search).get('token');
          if (qpToken && !urlToken) urlToken = qpToken;

          if (urlToken) {
            localStorage.setItem(KEY, 'authorization:github:success:' + urlToken);
            log('[url] TOKEN STORED: ' + urlToken, 'token');
            // clean URL so it doesn't re-trigger
            history.replaceState(null, '', location.pathname + '#/');
            if (!sessionStorage.getItem(RELOAD_KEY)) {
              sessionStorage.setItem(RELOAD_KEY, '1');
              setTimeout(() => location.reload(), 150);
            }
            return;
          }
        } catch (e) {
          log('[url parse error] ' + e.message);
        }

        // Clear reload flag on fresh page load (not from reload)
        if (performance.navigation.type === 0) { // TYPE_NAVIGATE (fresh load)
          sessionStorage.removeItem(RELOAD_KEY);
        }

        // 2) Boot CMS, then replay AFTER init to guarantee CMS listener is attached
        (function boot() {
          if (typeof window.CMS !== 'object') {
            log('[admin] CMS not present yet, retrying…');
            return setTimeout(boot, 100);
          }
          log('[admin] CMS present, calling CMS.init()');
          CMS.init({ config: '/admin/config.yml' });

          // Give CMS a moment to attach its internal listeners, then replay token
          // Try multiple times with increasing delays to ensure CMS is ready
          let attempts = 0;
          const maxAttempts = 5;
          
          function tryReplayToken() {
            attempts++;
            const replayed = replayTokenToCMS();
            if (replayed) {
              log('[admin] token replayed successfully on attempt ' + attempts);
            } else if (attempts < maxAttempts) {
              log('[admin] no token to replay, retrying in ' + (attempts * 200) + 'ms (attempt ' + attempts + '/' + maxAttempts + ')');
              setTimeout(tryReplayToken, attempts * 200);
            } else {
              log('[admin] no token to replay after ' + maxAttempts + ' attempts');
            }
          }
          
          setTimeout(tryReplayToken, 500);
        })();
      })();
    </script>
  </body>
</html>